{"version":3,"sources":["modules/Map.ts","modules/MapDao.ts","modules/Flight.ts","modules/Session.ts","modules/SessionDao.ts","modules/LevelDao.ts","modules/LevelSelection.tsx","modules/MapSelection.tsx","modules/ATCNavbar.tsx","modules/Audio.ts","modules/Message.ts","modules/Home.tsx","modules/CommandPane.tsx","modules/MessageConverters.ts","modules/CockpitLogger.tsx","modules/FlightProcessor.ts","modules/TrafficSimulator.ts","modules/RadarMap.ts","modules/RadarPane.tsx","modules/OptionPane.tsx","modules/QueuePane.tsx","modules/InfoPane.tsx","modules/AudioDialog.ts","modules/SpeechPane.tsx","modules/CommandInterpreter.ts","modules/SessionPane.tsx","modules/SpeechRecogn.tsx","modules/DialogTest.tsx","App.tsx","serviceWorker.js","index.js"],"names":["MapNodeType","GeoLocationSchema","type","properties","lat","lon","required","MapNodeAlignment","MapNodeTypeSchema","enum","Object","values","MapRouteType","MapNodeSchema","anyOf","allOf","id","alignment","hdg","AreaMapSetSchema","maps","additionalProperties","name","descr","center","nodes","routes","items","edges","minItems","maxItems","isRunway","node","Runway","FlightType","RADS_PER_DEG","Math","PI","DEGS_PER_RAD","NMS_PER_RAD","mapDao","_subj","this","AsyncSubject","ajax","getJSON","process","pipe","map","body","obj","Validator","validate","throwError","tap","undefined","error","console","subscribe","getMaps","flatMap","mapSet","from","_","filter","latRad","lonRad","z","sin","c","cos","to","v0","versor","v1","acos","min","max","loc","origin","dLon","nms","xy","atan2","hft","normAngle","hdgSingle","htf","normHdg","round","a","hdgTo","d","distance","angle","location","ds","hdgRad","_nodes","mapValues","coords","x","y","range","value","xmin","xmax","ymin","ymax","FlightStatus","FlightTypeSchema","FlightSchema","status","speed","alt","toAlt","rwy","at","turnTo","loopTimer","holdHdg","fix","right","exit","voice","SessionSchema","version","const","level","t","noFlights","noLandedOk","noLandedKo","noExitOk","noExitKo","noCollision","entries","flights","atcVoice","KEY","session","text","localStorage","getItem","JSON","parse","log","sessionDao","getSessions","sess","defer","s","of","EMPTY","err","setItem","stringify","levelId","mapId","uuidv4","putSession","levelDao","levels","list","find","LevelSelection","onSelect","listOnSelect","Card","style","width","Header","ListGroup","variant","Item","action","key","active","eventKey","onClick","MapSelection","ATCNavBar","serviceStatus","successRate","wrongRate","collisionRate","Container","fluid","Col","Badge","pill","sprintf","Navbar","Text","collapseOnSelect","expand","bg","Brand","href","Toggle","aria-controls","Collapse","Nav","className","Link","synthVoices","synth","v","voices","asyncSynth","asObservable","synthSay","cmds","forEach","cmd","m","exec","length","parseInt","msg","utt","SpeechSynthesisUtterance","speak","interval","take","window","speechSynthesis","getVoices","lang","toLowerCase","startsWith","getSynth","first","MessageTag","Command","Report","Confirmation","ErrorCode","Home","props","state","bindAll","th","setState","toArray","sessions","map1","floor","random","toString","create","Jumbotron","Row","CardDeck","handleLevel","handleMap","ButtonToolbar","aria-label","ButtonGroup","Button","handleStart","disabled","handleLoad","Component","orMsgOp","predicates","findIndex","f","tagMsgOp","tag","tags","indexOf","isSpeechError","Error","isError","parserError","SelectionStatus","isVoice","VoiceMessage","buildClimbCommand","flightId","atcId","flightLevel","concat","Climb","buildDescendCommand","Descend","buildMaintainCommand","Maintain","buildTakeoffCommand","ClearedToTakeoff","buildLandCommand","ClearedToLand","buildFlyToCommand","via","FlyToVia","FlyTo","buildHoldCommand","HoldAt","HoldCurrentPosition","buildHoldShortCommand","HoldShort","buildAtGroundMessage","flight","atc","Negative","FlightAtGround","buildInvalidFlightLevelMessage","InvalidFlightLevel","buildBeaconNotFoundMessage","BeaconNotFound","buildReadbackMessage","command","assign","Readback","buildOutOfAreaMessage","FlightReport","report","LeavingOutOfArea","buildEnterToMessage","EnterTo","dest","buildEnterLeaveMessage","EnterLeave","buildDepartureToMessage","ReadyToDepartureTo","buildDepartureLeaveMessage","ReadyToDepartureLeave","buildRunwayVacated","RunwayVacated","buildGoodDayMessage","confirmation","GoodDay","buildRogerMessage","Roger","buildClearedToLeaveMessage","ClearedToLeave","buildFlightNotFoundMessage","FlightNotFound","buildUnitellegibleMessage","speech","Unitellegible","Style","FlightLveles","CommandSelection","onAbort","onChangeFlightLevel","onTurnHeading","onClearToLand","onHold","Body","vertical","FlightSelection","ids","keys","sort","RunwaySelection","runways","DestinationSelection","Entry","Beacon","numCol1","ceil","nodes1","nodes2","drop","ConditionButtons","ConditionSelection","HoldCondition","FlightLevelSelection","flightLevels","orderBy","identity","fl","CommandPane","FlightId","FlightLevel","onCommand","WaitingForTakeoff","Turn","TurnCondition","when","LandingRunway","HoldingCondition","handleAbort","handleChangeFlightLevel","handleTurnHeading","handleClearToLand","handleHold","handleFlightLevelSelect","handleTurnConditionSelect","handleTurnHeadingSelect","handleRunwaySelect","handleHoldConditionSelect","handleFlightSelection","predicate","isFromFlight","fTags","apply","anyTagMsgOp","isFromAtc","TextBuilderPattern","Flight","templ","ATC","AudioBuilderPattern","TokenRegex","Builder","message","_message","_map","sections","split","prefixSplits","prefix","match","tokens","tok","fnId","substring","fn","join","errCode","SpellingWords","freeze","b","e","g","h","i","j","k","l","n","o","p","q","r","u","w","RunwaySuffix","spell","word","sp","spellId","TextBuilder","pattern","applyTemplate","AudioBuilder","_session","CockpitLogger","maxMessages","_log","messages","takeRight","toast","dark","RADIUS_PER_KNOTS","VALIDATION_PROPS","setMod","set","deleteMod","delete","setLocationMod","FlightProcessor","_flight","_messages","_props","addMessage","FlyingTo","ClearedTo","climbMsg","GoingAroundMissingApproach","GoingAroundMissingRunway","PassingFlightLevel","flightTempl","vspeed","landingAngle","tan","landingAlt","om","rwyId","radial","mm","outerMarker","approachDistance","da","outerMarkerAlt","withMessages","invalid","trace","flightMap","fromJS","modifiers","flight1","reduce","modifier","toJS","withFlight","dt","maxAngle","route","abs","sign","newHdg","cpt","onPassing","newFlight","turnedTo","moveHoriz","moveVert","rwyNode","rwyHdg","pLPnt","pRPnt","dL","dR","sigma1","sigma","asin","entry","pivot","template","speed360","speed0","speedByAlt","toHdg","updater","lp","update","turnedRight","nextPos","newAlt","newSpeed","result","addPassingFlightLevelDialog","minAlt","approachAlt","processClimbCommand","processDescendCommand","processMaintainCommand","processTakeoffCommand","processFlyToCommand","processClearedToLandCommand","processHoldCommand","validateATC","holdingDuration","atNode","HoldingToAt","HoldingFrom","RunwayNotFound","buildRunwayNotFoundMessage","clearToLandDistance","RunwayTooDistant","maxApproachAlt","FlightTooHigh","buildTooHighMessage","Approaching","Turning","ATCNotFound","validateFlightLevelCommand","cmdAlt","Landing","Aligning","Flying","flightRwy","FlightNotAtGround","buildNotAtGroundMessage","InvalidRunway","buildInvalidRunwayMessage","processTimePhase1","processExit","processTimeFlyingTo","processTimeFlying","processTimeTurning","processTimeApproaching","processTimeAligning","processTimeLanding","processTimeHoldingFrom","HoldingTo","processTimeHoldingTo","HoldingFromAt","processTimeHoldingFromNode","processTimeHoldingToNode","outboundTrack","hdg1","flyTo","exitNode","findKey","isEntryNode","nodeHdg","diff","Exited","approachJunction","maxTurn","dc","angle1","goAroundAlt","addMissingApproachDialog","approachVert","f1","turnedRightTo","turnedLeftTo","landVert","landingHdgRange","runwayNode","addMissingRunwayDialog","Landed","shifting","midleMarker","df","sqrt","fPts","apprAlt","addFlyingToDialog","DefaultSimProps","jetProb","safeEntryDelay","entryAlt","exitAlt","collisionDistance","collisionAlt","exitDistance","conditionDistance","J","A","flightVoices","rndFlightId","tmpl","mode","String","fromCharCode","choose","buildSimulator","TrafficSimulator","holdShort","addMessages","fp","processCommand","newSession","setIn","withSession","processFlights","filterForLanded","filterForOutOfArea","filterForExited","filterCollision","processForNewFlight","addTime","flightsAry","collision","Set","add","partition","has","collided","notCollided","noCollided","notCollidedMap","groupBy","Collision","exited","notExited","exitedOk","exitedKo","ok","ko","notExitedMap","okMessages","Leaving","koMessages","LeavingMissingDearture","pts","inArea","inAreaMap","landed","notLanded","landedOk","landedKo","notLandedMap","fromPairs","WrongRunwayVacated","size","processed","processTime","newFlights","maxPlane","flightFreq","lambda","exp","rndPoisson","tmp","createFlight","entryTimeout","prob","candidates","createEntryCandidates","createExitCandidates","Jet","Airplane","fromRwy","flightSpeed","sessionMap1","sessionMap","next","toRwy","addDepartureToDialog","addDepartureLeaveDialog","addEnterToDialog","addEnterLeaveDialog","RadarMap","nodeMap","height","borders","offsetX","offsetY","scale","xscale","yscale","scale1","pointByNm","pointByNode","pointByNodeId","dx","dy","defaults","dxnms","dynms","moveByNm","gs10","logGs","log10","pow","xRange","yRange","topLeft","bottomRight","ZOOM_SCALE","RadarConf","ImageConf","PlaneConf","x1","x2","y1","y2","FlightLevels","Node","pt","radarMap","textPt","radius","textPos","nodeClass","textClass","cx","cy","FlightGraph","altitude","pointByGeo","collisionRadius","showColllision","collisionClassName","trans","rotate","url","txt1","txt2","x3","x4","y3","y4","txtClassName","transform","GridMarker","gridSize","x0","y0","gridMarkerText","Grid","rect","gxmin","gxmax","gymin","gymax","xidx","yidx","upnms","dwnnms","lnms","rpnms","Route","routePath","cl","RadarPane","dragging","ev","button","preventDefault","pivotX","clientX","pivotY","clientY","fit","rm","shiftKey","zoom","deltaY","factor","moveByPts","onMouseMove","handleMove","onMouseDown","handleDown","onMouseUp","handleUp","onMouseLeave","onWheel","handleWheel","handleZoomIn","icon","faSearchPlus","handleZoomOut","faSearchMinus","handleFit","faSearch","DefaultSpeeds","OptionsPane","muted","onMuted","listeningEnabled","onListeningEnabled","speeds","onSpeed","Accordion","defaultActiveKey","as","Form","Group","controlId","Label","Check","label","onChange","checked","parseFloat","target","toLines","toFl","st","line1","line2","QueuePane","lines","sortBy","InfoPane","logger","AudioDialog","_recogn","_speeches","_listening","_buffer","_speech","_listenEnabled","Subject","BehaviorSubject","self","ondefault","onresult","onend","onnomatch","onerror","SpeechRecognition","webkitSpeechRecognition","recognition","continuous","interimResults","maxAlternatives","onspeechend","onstart","onaudiostart","onsoundstart","onspeechstart","onsoundend","onaudioend","createRecogn","results","transcript","handleSpeech","onSpeech","onListening","onRecognized","speeches","listening","speaking","notSpeaking","inter","speakingPooling","polling","combineLatest","cleared","handleCleared","trim","parseSpeech","isCompleted","bfr","listenEnabled","startListening","rec","recogn","start","SpeechPane","InputGroup","Prepend","faMicrophone","faMicrophoneSlash","Similitudes","climb","descend","fly","maintain","runway","isString","el","Context","cursor","data","stack","dropRight","speechToMessage","ctx","peek","ParserError","_ctx","errorIfEnd","token","peekn","push","pushHold","toUpperCase","isSimilar","expected","optWord","ctx1","optDict","all","exprs","expr","ifThenElse","whenDef","whenUndef","ifDropThenElse","any","repeat","reducer","acc","ctx2","must","errorCode","regex","optNum","test","zero","one","wine","two","three","four","for","five","six","seven","eight","nine","niner","naina","optAlpha","alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","indian","juliet","kilo","lima","mike","november","oscar","papa","quebec","rebec","prebec","romeo","sierra","tango","uniform","uniforms","uniformed","victor","viktor","picture","whiskey","whisky","yankee","zulu","optAlphaNum","beaconId","london","paris","munich","milan","frankfurt","optRunway","left","optClimb","optDescend","optMaintain","optFlyTo","optHold","optLand","optTakeoff","muteMessage","SessionPane1","clock","ts","audioDialog","handleSpeechMessage","handleListening","getSession","sessionId","getMap","indices","flightVoices1","reject","handleClock","handleMessages","ts1","ts2","sim","transition","texts","build","putMessages","txt","clips","say","cancel","isCommand","handleCommand","xs","handleSpeed","handleMuted","handleListenEnabled","SessionPane","useParams","SpeechRecogn","_recognition","errorHandler","event","handleResult","listen","column","sm","Control","plaintext","readOnly","defaultValue","DialogTest","errors","splice","Alert","dismissible","show","onClose","handleCloseAlert","FormGroup","handleVoice","NoMatch","App","basename","position","autoClose","hideProgressBar","pauseOnFocusLoss","pauseOnHover","exact","path","Boolean","hostname","ReactDOM","render","StrictMode","document","getElementById","navigator","serviceWorker","ready","then","registration","unregister","catch"],"mappings":"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","file":"static/js/main.c3e05c5d.chunk.js","sourcesContent":["import { Schema, Validator } from 'jsonschema';\n\nexport interface GeoLocation {\n    readonly lat: number;\n    readonly lon: number;\n}\n\nexport const GeoLocationSchema: Schema = {\n    type: 'object',\n    properties: {\n        lat: { type: 'number' },\n        lon: { type: 'number' },\n    },\n    required: ['lat', 'lon']\n};\n\nexport enum MapNodeType {\n    Beacon = 'beacon',\n    Entry = 'entry',\n    OuterMarker = 'om',\n    Runway = 'runway'\n}\n\nconst MapNodeTypeSchema: Schema = {\n    type: 'string',\n    enum: Object.values(MapNodeType)\n};\n\nexport enum MapNodeAlignment {\n    N = 'N',\n    NE = 'NE',\n    E = 'E',\n    SE = 'SE',\n    S = 'S',\n    SW = 'SW',\n    W = 'W',\n    NW = 'NW'\n}\n\nconst MapNodeAlignmentSchema: Schema = {\n    type: 'string',\n    enum: Object.values(MapNodeAlignment)\n};\n\n\nexport interface BasicMapNode extends GeoLocation {\n    readonly id: string;\n    readonly type: MapNodeType;\n    readonly alignment: MapNodeAlignment;\n}\n\nconst BasicMapNodeSchema: Schema = {\n    allOf: [\n        GeoLocationSchema,\n        {\n            type: \"object\",\n            properties: {\n                id: { type: 'string' },\n                type: MapNodeTypeSchema,\n                alignment: MapNodeAlignmentSchema\n            },\n            required: ['id', 'type', 'alignment']\n        }\n    ]\n};\n\nexport interface HeadingMapNode extends BasicMapNode {\n    readonly hdg: number;\n}\n\nconst HeadingMapNodeSchema: Schema = {\n    allOf: [\n        GeoLocationSchema,\n        {\n            type: 'object',\n            properties: { hdg: { type: 'integer' }, },\n            required: ['hdg']\n        }\n    ]\n};\n\nexport type MapNode = HeadingMapNode | BasicMapNode;\n\nconst MapNodeSchema: Schema = {\n    anyOf: [\n        BasicMapNodeSchema,\n        HeadingMapNodeSchema,\n    ]\n};\n\nexport enum MapRouteType {\n    Connection = 'connection',\n    Entry = 'entry',\n    Land = 'land',\n    LandConnection = 'landConnection',\n    Takeoff = 'takeoff',\n}\n\nconst MapRouteTypeSchema: Schema = {\n    type: 'string',\n    enum: Object.values(MapRouteType)\n}\n\nexport interface MapRoute {\n    readonly type: MapRouteType;\n    readonly edges: string[];\n}\n\nconst MapRouteSchema: Schema = {\n    type: 'object',\n    properties: {\n        type: MapRouteTypeSchema,\n        edges: {\n            type: 'array',\n            items: [\n                { type: 'string' }\n            ],\n            minItems: 2,\n            maxItems: 2\n        }\n    },\n    required: ['type', 'edges']\n}\n\nexport interface AreaMap {\n    readonly id: string;\n    readonly name: string;\n    readonly descr: string;\n    readonly center: GeoLocation;\n    readonly nodes: Record<string, MapNode>;\n    readonly routes: MapRoute[];\n}\n\nconst AreaMapSchema: Schema = {\n    type: 'object',\n    properties: {\n        id: { type: 'string' },\n        name: { type: 'string' },\n        descr: { type: 'string' },\n        center: GeoLocationSchema,\n        nodes: {\n            type: 'object',\n            additionalProperties: MapNodeSchema\n        },\n        routes: {\n            type: 'array',\n            items: MapRouteSchema\n        }\n    },\n    required: ['id', 'name', 'descr', 'center', 'nodes', 'routes']\n};\n\nexport interface AreaMapSet {\n    readonly maps: Record<string, AreaMap>;\n}\nexport const AreaMapSetSchema: Schema = {\n    type: 'object',\n    properties: {\n        maps: {\n            type: 'object',\n            additionalProperties: AreaMapSchema\n        }\n    },\n    required: ['maps']\n};\n\n\nexport interface RadarNode { node: MapNode, coords: number[] }\n\nexport interface FlightMap {\n    readonly nodes: Record<string, RadarNode>,\n    readonly xmin: number;\n    readonly xmax: number;\n    readonly ymin: number;\n    readonly ymax: number;\n    readonly range: number;\n}\n\nexport function validateAreaMapSet(obj: any): AreaMapSet {\n    new Validator().validate(obj, AreaMapSetSchema, { throwError: true });\n    return obj as AreaMapSet;\n}\n\nexport function isRunway(node: MapNode): node is HeadingMapNode {\n    return node.type === MapNodeType.Runway;\n}\n\nexport function isEntryNode(node: MapNode): node is HeadingMapNode {\n    return node.type === MapNodeType.Entry;\n}\n","\nimport { ajax } from 'rxjs/ajax';\nimport { filter, flatMap, map, tap } from 'rxjs/operators';\nimport _ from 'lodash';\nimport { AsyncSubject, from, Observable } from 'rxjs';\nimport { AreaMap, AreaMapSet, GeoLocation, MapNode, validateAreaMapSet } from './Map';\n\nconst url = process.env.REACT_APP_BASENAME + '/data/maps.json';\nconst NMS_PER_DEG = 60;\nconst RADS_PER_DEG = Math.PI / 180;\nconst DEGS_PER_RAD = 180 / Math.PI;\nconst NMS_PER_RAD = NMS_PER_DEG / RADS_PER_DEG;\n\nexport interface LocatedVector extends GeoLocation {\n    readonly hdg: number;\n}\n\nexport interface RouteInfo {\n    readonly hdg: number;\n    readonly d: number;\n    readonly angle: number;\n    readonly from: boolean;\n    readonly to: boolean;\n}\n\n/** */\nclass MapDao {\n    private _subj: AsyncSubject<AreaMapSet>;\n\n    /** */\n    constructor() {\n        this._subj = new AsyncSubject();\n        ajax.getJSON<any>(url).pipe(\n            map(body => validateAreaMapSet(body)),\n            tap(undefined,\n                error => {\n                    console.error(error);\n                })).subscribe(this._subj);\n    }\n\n    /** */\n    getMaps(): Observable<AreaMapSet> {\n        return this._subj;\n    }\n\n    /**\n     * \n     * @param id \n     */\n    getMap(id: string): Observable<AreaMap> {\n        return this.getMaps().pipe(\n            flatMap(mapSet => from(_.values(mapSet.maps))),\n            filter(map => map.id === id)\n        );\n    }\n\n    /**\n     * Returns the versor of location double[3]\n     * \n     * @param location {lat lon}\n     */\n    versor({ lat, lon }: GeoLocation): number[] {\n        const latRad = lat * RADS_PER_DEG;\n        const lonRad = lon * RADS_PER_DEG;\n        const z = Math.sin(latRad);\n        const c = Math.cos(latRad);\n        const x = c * Math.sin(lonRad);\n        const y = c * Math.cos(lonRad);\n        return [x, y, z];\n    }\n\n    /**\n     * Returns the distance in nm\n     * \n     * @param from source location {lat, lon}\n     * @param to  destination location {lat, lon}\n     */\n    distance(to: GeoLocation, from: GeoLocation): number {\n        const v0 = this.versor(from);\n        const v1 = this.versor(to);\n        const c = v0[0] * v1[0] + v0[1] * v1[1] + v0[2] * v1[2];\n        const result = Math.acos(Math.min(Math.max(-1, c), 1)) * NMS_PER_RAD;\n        return result;\n    }\n\n    /**\n     * Returns the longitude difference in range (-180, 180)\n     * @param {*} loc the location\n     * @param {*} origin the origin\n     */\n    private dLon(loc: GeoLocation, origin: GeoLocation): number {\n        var dLon = (loc.lon - origin.lon);\n        if (dLon >= 180)\n            dLon -= 360;\n        if (dLon < -180)\n            dLon += 360;\n        return dLon;\n    }\n\n    /**\n     * Returns the xy coordinates in nm {x, y}\n     * @param {*} loc the location\n     * @param {*} origin the origin\n     */\n    xy(loc: GeoLocation, origin: GeoLocation): number[] {\n        const x = this.dLon(loc, origin) * NMS_PER_DEG * Math.cos(loc.lat * RADS_PER_DEG);\n        const y = (loc.lat - origin.lat) * NMS_PER_DEG;\n        return [x, y];\n    }\n\n    /**\n     * \n     * @param {*} to \n     * @param {*} from \n     */\n    private hdgSingle(to: GeoLocation, from: GeoLocation): number {\n        const nms = this.xy(to, from);\n        const deg = Math.atan2(nms[0], nms[1]) * DEGS_PER_RAD;\n        return deg;\n    }\n\n    /**\n     * \n     * @param to \n     * @param from \n     */\n    hdg(to: GeoLocation, from: GeoLocation): number {\n        const hft = this.normAngle(this.hdgSingle(to, from));\n        const htf = this.normAngle(this.hdgSingle(from, to) + 180);\n        const hdg = this.normHdg(Math.round(hft + this.normAngle((htf - hft) / 2)));\n        return hdg;\n    }\n\n    /**\n     * \n     * @param hdg \n     */\n    normHdg(hdg: number): number {\n        return hdg > 360 ? hdg - 360 : hdg <= 0 ? hdg + 360 : hdg;\n    }\n\n    /**\n     * \n     * @param a \n     */\n    normAngle(a: number): number {\n        return a >= 180 ? a - 360 : a < -180 ? a + 360 : a;\n    }\n\n    /**\n     * Returns the route info to fly to a location {d, hdg, angle, from, to}\n     * \n     * @param from the origin location or flight\n     * @param to the target location\n     * @param hdg the from direction\n     */\n    route(from: LocatedVector | GeoLocation, to: GeoLocation, hdg?: number): RouteInfo {\n        if (hdg === undefined) {\n            hdg = (from as LocatedVector).hdg;\n        }\n        const hdgTo = this.hdg(to, from);\n        const d = this.distance(from, to);\n        const angle = this.normAngle(Math.round(hdgTo - hdg));\n        const toFlag = angle < 90 && angle > -90;\n        const fromFlag = angle > 90 || angle < -90;\n        return { hdg: hdgTo, d, angle, from: fromFlag, to: toFlag };\n    }\n\n    /**\n     * \n     * @param location \n     * @param hdg \n     * @param ds \n     */\n    radial(location: GeoLocation, hdg: number, ds: number): GeoLocation {\n        const { lat, lon } = location;\n        const hdgRad = hdg * RADS_PER_DEG;\n        const dlat = ds * Math.cos(hdgRad) / NMS_PER_DEG;\n        const dlon = ds * Math.sin(hdgRad) / Math.cos(lat * RADS_PER_DEG) / NMS_PER_DEG;\n        const newLat = lat + dlat;\n        const newLon = lon + dlon;\n        return { lat: newLat, lon: newLon };\n    }\n\n    /**\n     * Returns the coordinates in nm {center:{lat, lon}, nodes:[{node:any, coords:[double]}]}\n     * @param {*} nodes locations {id:{lat, long}, ...}\n     * @param {*} center center {lat, long}\n     */\n    coords(nodes: Record<string, MapNode>, center: GeoLocation) {\n        const _nodes = _(nodes)\n            .mapValues(node => {\n                return {\n                    node: node,\n                    coords: this.xy(node, center)\n                };\n            })\n        const x = _nodes.map(node => node.coords[0]);\n        const y = _nodes.map(node => node.coords[1]);\n\n        const range = _(nodes).values().map(node =>\n            this.distance(center, node)\n        ).max() || 0;\n        const result = {\n            nodes: _nodes.value(),\n            xmin: x.min() || 0,\n            xmax: x.max() || 0,\n            ymin: y.min() || 0,\n            ymax: y.max() || 0,\n            range\n        };\n        return result;\n    }\n}\n\nexport const mapDao = new MapDao();\n","import { LocatedVector } from \"./MapDao\";\nimport { Validator } from 'jsonschema';\nimport { GeoLocation, GeoLocationSchema } from './Map';\n\nexport enum FlightType {\n    Jet = 'J',\n    Airplane = 'A'\n}\n\nconst FlightTypeSchema = {\n    type: 'string',\n    enum: Object.values(FlightType)\n};\n\nexport enum FlightStatus {\n    WaitingForTakeoff = 'waiting-for-takeoff',\n    Flying = 'flying',\n    FlyingTo = 'flying-to',\n    Turning = 'turning',\n    Approaching = 'approaching',\n    Aligning = 'aligning',\n    Landing = 'landing',\n    HoldingFromAt = 'holding-from-at',\n    HoldingToAt = 'holding-to-at',\n    HoldingFrom = 'holding-from',\n    HoldingTo = 'holding-to',\n    Landed = 'landed',\n    Exited = 'exited'\n}\n\nconst FlightStatusSchema = {\n    type: 'string',\n    enum: Object.values(FlightStatus)\n};\n\nexport interface Flight extends LocatedVector {\n    readonly id: string;\n    readonly type: FlightType;\n    readonly status: FlightStatus;\n    readonly speed: number;\n    readonly alt: number;\n    readonly toAlt: number;\n    readonly to: string;\n    readonly from: string;\n    readonly rwy?: string;\n    readonly at?: string;\n    readonly turnTo?: string;\n    readonly loopTimer?: number;\n    readonly holdHdg?: number;\n    readonly fix?: GeoLocation;\n    readonly right?: boolean;\n    readonly exit?: string;\n    readonly voice?: string;\n}\n\nexport const FlightSchema = {\n    type: 'object',\n    properties: {\n        id: { type: 'string' },\n        type: FlightTypeSchema,\n        status: FlightStatusSchema,\n        speed: { type: 'integer' },\n        alt: { type: 'integer' },\n        toAlt: { type: 'integer' },\n        to: { type: 'string' },\n        from: { type: 'string' },\n        rwy: { type: 'string' },\n        at: { type: 'string' },\n        turnTo: { type: 'string' },\n        loopTimer: { type: 'number' },\n        holdHdg: { type: 'integer' },\n        fix: GeoLocationSchema,\n        right: { type: 'boolean' },\n        exit: { type: 'string' },\n        voice: { type: 'string' }\n    },\n    required: ['id', 'type', 'status', 'speed', 'alt', 'toAlt', 'to', 'from']\n};\n\nexport function validateFlight(obj: any) {\n    new Validator().validate(obj, FlightSchema, { throwError: true });\n    return obj;\n}\n","import { Flight, FlightSchema } from \"./Flight\";\nimport { Validator } from 'jsonschema';\n\nexport const CURRENT_VERSION = '1.1';\n\nexport type Session = Readonly<{\n    id: string;\n    version: string;\n    level: string;\n    map: string;\n    t: number;\n    entries: Record<string, number>;\n    flights: Record<string, Flight>;\n    noFlights: number;\n    noLandedOk: number;\n    noLandedKo: number;\n    noExitOk: number;\n    noExitKo: number;\n    noCollision: number;\n    atcVoice?: string;\n}>;\n\nexport const SessionSchema = {\n    type: 'object',\n    properties: {\n        id: { type: 'string' },\n        version: { type: 'string', const: CURRENT_VERSION },\n        level: { type: 'string' },\n        map: { type: 'string' },\n        t: { type: 'number' },\n        noFlights: { type: 'integer' },\n        noLandedOk: { type: 'integer' },\n        noLandedKo: { type: 'integer' },\n        noExitOk: { type: 'integer' },\n        noExitKo: { type: 'integer' },\n        noCollision: { type: 'integer' },\n        entries: {\n            type: 'object',\n            additionalProperties: { type: 'number' }\n        },\n        flights: {\n            type: 'object',\n            additionalProperties: FlightSchema\n        },\n        atcVoice: { type: 'string' }\n    },\n    required: ['id', 'version', 'level', 'map', 't',\n        'noFlights', 'noLandedOk', 'noLandedKo', 'noExitOk', 'noCollision', 'entries',\n        'flights']\n}\n\n/**\n * \n * @param obj \n */\nexport function validateSession(obj: any): Session {\n    new Validator().validate(obj, SessionSchema, { throwError: true });\n    return obj as Session;\n}","import { defer, EMPTY, Observable, of } from \"rxjs\";\nimport { v4 as uuidv4 } from 'uuid';\nimport { Session, CURRENT_VERSION, validateSession } from \"./Session\";\nimport { filter } from \"rxjs/operators\";\n\nconst KEY = 'atc.session';\n\nfunction session(): Session | undefined {\n    const text = localStorage.getItem(KEY);\n    if (text !== null) {\n        try {\n            return validateSession(JSON.parse(text));\n        } catch (error) {\n            console.log(error);\n            throw error;\n        }\n    }\n}\n\n/**\n * \n */\nclass SessionDao {\n\n    /**\n     * \n     * @param id \n     */\n    getSession(id: string): Observable<Session> {\n        const result = this.getSessions().pipe(\n            filter(sess => !!sess && sess.id === id)\n        );\n        return result;\n    }\n\n    /** */\n    getSessions(): Observable<Session> {\n        return defer(() => {\n            try {\n                const s = session();\n                return !s ? EMPTY : of(s);\n            } catch (err) {\n                return EMPTY;\n            }\n        });\n    }\n\n    /**\n     * \n     * @param session \n     */\n    putSession(session: Session) {\n        localStorage.setItem(KEY, JSON.stringify(session));\n        return session;\n    }\n\n    /**\n     * \n     * @param levelId \n     * @param mapId \n     */\n    create(levelId: string, mapId: string, atcVoice?: string): Session {\n        const session = {\n            id: uuidv4(),\n            version: CURRENT_VERSION,\n            level: levelId,\n            map: mapId,\n            t: 0,\n            entries: {},\n            flights: {},\n            noFlights: 0,\n            noLandedOk: 0,\n            noLandedKo: 0,\n            noExitOk: 0,\n            noExitKo: 0,\n            noCollision: 0,\n            atcVoice\n        };\n        return this.putSession(session);\n    }\n}\n\nexport const sessionDao = new SessionDao();\n","\nimport { AsyncSubject, Observable } from 'rxjs';\nimport { ajax } from 'rxjs/ajax';\nimport { map, tap } from 'rxjs/operators';\nimport _ from 'lodash';\nimport { Level, LevelList } from './Level';\n\nconst url = process.env.REACT_APP_BASENAME + '/data/levels.json';\n\nclass LevelDao {\n    private _subj: AsyncSubject<LevelList>;\n\n    /** */\n    constructor() {\n        this._subj = new AsyncSubject();\n        ajax.getJSON<LevelList>(url).pipe(\n            tap(undefined, error => {\n                console.error(error);\n            })).subscribe(this._subj);\n    }\n\n    /** */\n    levels(): Observable<LevelList> {\n        return this._subj;\n    }\n\n    /**\n     * \n     * @param id \n     */\n    level(id: string): Observable<Level | undefined> {\n        return this.levels().pipe(\n            map(list => _.find(list.levels, { id: id }))\n        );\n    }\n}\n\nexport const levelDao = new LevelDao();\n","import React from 'react';\nimport { Card, ListGroup } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { Level } from './Level';\n\n/**\n * \n */\nexport const LevelSelection: React.FC<{\n  readonly value?: string,\n  readonly values?: Level[],\n  readonly onSelect?: (value: string) => void\n}> = ({ value, values = [], onSelect }) => {\n\n  const listOnSelect = (value: string) => () => {\n    if (!!onSelect) {\n      onSelect(value);\n    }\n  }\n\n  return (\n    <Card style={{ width: '18rem' }}>\n      <Card.Header>Game Level</Card.Header>\n      <ListGroup variant=\"flush\">\n        {_.map(values, level =>\n          (\n            <ListGroup.Item action key={level.id}\n              active={!!value && value === level.id}\n              eventKey={level.id}\n              onClick={listOnSelect(level.id)}>{level.name}</ListGroup.Item>\n          )\n        )}\n      </ListGroup>\n    </Card>\n  );\n}\n","import React from 'react';\nimport { Card, ListGroup } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { AreaMap } from './Map';\n\n/**\n * \n * @param param0 \n */\nexport const MapSelection: React.FC<{\n  readonly value?: string;\n  readonly values?: AreaMap[];\n  readonly onSelect?: (value: string) => void;\n}> = ({ value, values = [], onSelect }) => {\n\n  const onClick = (value: string) => () => {\n    if (!!onSelect) {\n      onSelect(value);\n    }\n  };\n\n  return (\n    <Card style={{ width: '18rem' }}>\n      <Card.Header>Map</Card.Header>\n      <ListGroup variant=\"flush\">\n        {_.map(values, map => {\n          return (\n            <ListGroup.Item key={map.id}\n              eventKey={map.id}\n              active={value === map.id}\n              action onClick={onClick(map.id)}>\n              {map.descr}\n            </ListGroup.Item>\n          );\n        })\n        }\n      </ListGroup>\n    </Card>\n  );\n}\n","import React from 'react';\nimport { Badge, Col, Container, Nav, Navbar } from 'react-bootstrap';\nimport { sprintf } from 'sprintf-js';\nimport { Session } from './Session';\n\n/**\n * \n * @param param0 \n */\nexport const ATCNavBar: React.FC<{ session?: Session }> = ({ session }) => {\n  const home = process.env.REACT_APP_BASENAME;\n  var serviceStatus = undefined;\n  if (!session) {\n    serviceStatus = (\n      <Navbar.Text></Navbar.Text>\n    );\n  } else {\n    const { noFlights, noLandedOk, noLandedKo, noExitKo, noExitOk, noCollision, t } = session as Session;\n    const successRate = !!t ? (noLandedOk + noExitOk) * 3600 / t : 0;\n    const wrongRate = !!noFlights ? (noExitKo + noLandedKo) / noFlights * 100 : 0;\n    const collisionRate = !!noFlights ? noCollision / noFlights * 100 : 0;\n\n    serviceStatus = (\n      <Container fluid>\n        <Col>\n          <span>\n            <Badge variant=\"info\" pill>Inbound: {sprintf('%d', noFlights)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"success\" pill>Success: {sprintf('%.1f fph', successRate)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"warning\" pill>Wrong: {sprintf('%.0f%%', wrongRate)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"danger\" pill>Collision: {sprintf('%.0f%%', collisionRate)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"success\">Right landed: {sprintf('%d', noLandedOk)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"success\">Right left: {sprintf('%d', noExitOk)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span>\n            <Badge variant=\"warning\">Wrong landed: {sprintf('%d', noLandedKo)}</Badge>\n          </span>\n        </Col >\n        <Col>\n          <span><Badge variant=\"warning\">Wrong left: {sprintf('%d', noExitKo)}</Badge></span>\n        </Col>\n        <Col>\n          <span>\n            <Badge variant=\"danger\">Collisions: {sprintf('%d', noCollision)}</Badge>\n          </span>\n        </Col >\n      </Container >\n    );\n  }\n  return (\n    <Navbar collapseOnSelect expand=\"lg\" bg=\"dark\" variant=\"dark\" >\n      <Navbar.Brand href=\"http://www.mmarini.org\">www.mmarini.org</Navbar.Brand>\n      <Navbar.Toggle aria-controls=\"responsive-navbar-nav\" />\n      <Navbar.Collapse id=\"responsive-navbar-nav\">\n        <Nav className=\"mr-auto\">\n          <Nav.Link href={home}>ATC {process.env.REACT_APP_VERSION}</Nav.Link>\n        </Nav>\n        <Navbar.Text>\n        </Navbar.Text >\n      </Navbar.Collapse>\n      <Nav className=\"mr-auto\">\n        {serviceStatus}\n      </Nav>\n    </Navbar >\n  );\n};\n","import { AsyncSubject, interval, Observable } from \"rxjs\";\nimport { bufferCount, filter, first, flatMap, map, take, tap } from \"rxjs/operators\";\n\nconst ReadingPollingInterval = 100;\nconst SpeakingPollingInterval = 100;\n\n/**\n * \n * @param voices \n */\nfunction filterEng(voices: SpeechSynthesisVoice[]): SpeechSynthesisVoice[] {\n    return voices.filter(voice => voice.lang.toLowerCase().startsWith('en'));\n}\n\n/**\n * \n */\nfunction getSynth() {\n    const synth = window.speechSynthesis;\n    const result = { synth, voices: synth ? filterEng(synth.getVoices()) : [] };\n    return result;\n}\n\n/**\n * Returns the single observable with the list of voices\n */\nexport function synthVoices(): Observable<SpeechSynthesisVoice[]> {\n    return synth().pipe(\n        map(v => v.voices)\n    );\n}\n\n/**\n * \n */\nexport function speakingPooling(inter: number = SpeakingPollingInterval): Observable<boolean> {\n    return interval(inter).pipe(\n        flatMap(() => synth()),\n        map(v => v.synth.speaking)\n    );\n}\n\n/**\n * \n */\nexport function speakingChange() {\n    return (obs: Observable<boolean>) =>\n        (obs).pipe(\n            bufferCount(2, 1),\n            filter(x => x[0] !== x[1]),\n            map(x => x[1])\n        );\n}\n\nconst asyncSynth = new AsyncSubject<{\n    synth: SpeechSynthesis,\n    voices: SpeechSynthesisVoice[]\n}>();\n\ninterval(ReadingPollingInterval).pipe(\n    take(100),\n    map(() => getSynth()),\n    filter(v => v.voices.length > 0),\n    first()\n).subscribe(asyncSynth);\n\n/**\n * \n */\nexport function synth() {\n    return asyncSynth.asObservable();\n}\n\n/**\n * Returns the single observable that synthetizes a list of commands or empty observable \n * if cannot synthetize\n * @param {*} cmds the commad list 'voiceIndex text'\n */\nexport function synthSay(cmds: string[]): Observable<any> {\n    return synth().pipe(\n        tap(({ synth, voices }) => {\n            cmds.forEach(cmd => {\n                const m = /(\\d+)\\b(.*)/.exec(cmd);\n                if (m != null && m.length === 3) {\n                    const voice = voices[parseInt(m[1])];\n                    const msg = m[2];\n                    if (voice) {\n                        const utt = new SpeechSynthesisUtterance(msg);\n                        utt.voice = voice;\n                        // utt.rate = 1.2;\n                        synth.speak(utt);\n                    }\n                }\n            })\n        })\n    );\n}\n","import _ from 'lodash';\nimport { sprintf } from 'sprintf-js';\nimport { Flight } from './Flight';\n\nexport enum MessageTag {\n    Command = 'command',\n    Confirmation = 'confirmation',\n    Error = 'error',\n    FlightReport = 'flight-report',\n    Negative = 'negative',\n    Readback = 'readback',\n    VoiceMessage = 'voice'\n}\n\nexport enum Command {\n    ClearedToLand = 'cleared-to-land',\n    ClearedToTakeoff = 'cleared-to-takeoff',\n    Climb = 'climb',\n    Descend = 'descend',\n    FlyTo = 'fly-to',\n    FlyToVia = 'fly-to-via',\n    Maintain = 'maintain',\n    HoldAt = 'hold-at',\n    HoldCurrentPosition = 'hold-current-position',\n    HoldShort = 'hold-short'\n}\n\nexport enum Report {\n    Collision = 'collision',\n    EnterTo = 'enter-to',\n    EnterLeave = 'enter-leave',\n    FlyingTo = 'flying-to',\n    GoingAroundMissingApproach = 'going-around-missing-approach',\n    GoingAroundMissingRunway = 'going-around-missing-runway',\n    Leaving = 'leaving',\n    LeavingMissingDearture = 'leaving-missing-departure',\n    LeavingOutOfArea = 'leaving-out-of-area',\n    PassingFlightLevel = 'passing-flight-level',\n    ReadyToDepartureTo = 'ready-to-departure-to',\n    ReadyToDepartureLeave = 'ready-to-departure-leave',\n    RunwayVacated = 'runway-vacated',\n    WrongRunwayVacated = 'wrong-runway-vacated'\n}\n\nexport enum Confirmation {\n    ClearedTo = 'cleared-to',\n    ClearedToLeave = 'cleared-to-leave',\n    GoodDay = 'good-day',\n    Roger = 'roger'\n}\n\nexport enum ErrorCode {\n    ATCNotFound = 'atc-not-found',\n    BeaconNotFound = 'beacon-not-found',\n    FlightAtGround = 'flight-at-ground',\n    FlightNotAtGround = 'flight-not-at-ground',\n    FlightNotFound = 'flight-not-found',\n    FlightTooHigh = 'flight-too-high',\n    InvalidFlightLevel = 'invalid-flight-level',\n    InvalidRunway = 'invalid-runway',\n    RunwayNotFound = 'runway-not-found',\n    RunwayTooDistant = 'runway-too-distant',\n    Unitellegible = 'unintelligible'\n};\n\nexport interface AbstractMessage {\n    readonly from?: string;\n    readonly to?: string;\n    readonly tags: MessageTag[];\n};\n\nexport interface AbstractCommandMessage extends AbstractMessage {\n    readonly cmd: Command;\n}\n\nexport interface FlightLevelCommandMessage extends AbstractCommandMessage {\n    readonly flightLevel: string;\n}\n\nexport interface TakeoffCommandMessage extends FlightLevelCommandMessage {\n    readonly rwy: string;\n}\n\nexport interface LandCommandMessage extends AbstractCommandMessage {\n    readonly rwy: string;\n}\n\nexport interface FlyToCommandMessage extends AbstractCommandMessage {\n    readonly turnTo: string;\n    readonly via?: string;\n}\n\nexport interface HoldAtCommandMessage extends AbstractCommandMessage {\n    readonly at?: string;\n}\n\nexport type CommandMessage = FlightLevelCommandMessage | TakeoffCommandMessage | LandCommandMessage | FlyToCommandMessage | HoldAtCommandMessage;\n\n\nexport interface BasicReportMessage extends AbstractMessage {\n    readonly report: Report;\n}\n\nexport interface DestinationMessage extends BasicReportMessage {\n    readonly dest: string;\n}\n\nexport interface RunwayMessage extends BasicReportMessage {\n    readonly rwy: string;\n}\n\nexport interface DepartureMessage extends DestinationMessage, RunwayMessage { };\n\nexport interface EnterMessage extends DestinationMessage {\n    readonly via: string;\n}\n\nexport interface FlightLevelMessage extends BasicReportMessage {\n    readonly flightLevel: string;\n}\n\nexport type ReportMessage = BasicReportMessage | DestinationMessage | EnterMessage | FlightLevelMessage | RunwayMessage | DepartureMessage;\n\nexport interface BasicConfirmationMessage extends AbstractMessage {\n    readonly confirmation: Confirmation\n}\n\nexport interface ClearedToDestinationMessage extends BasicConfirmationMessage {\n    readonly dest: string\n}\n\nexport type ConfirmationMessage = ClearedToDestinationMessage | BasicConfirmationMessage;\n\nexport interface BasicNegativeMessage extends AbstractMessage {\n    readonly error: ErrorCode\n}\n\nexport interface IdNegativeMessage extends BasicNegativeMessage {\n    readonly id: string;\n}\n\nexport type NegativeResponse = BasicNegativeMessage | IdNegativeMessage;\n\nexport interface AbstractErrorMessage extends AbstractMessage {\n    readonly error: ErrorCode\n}\n\nexport interface ErrorIdNotFoundMessage extends AbstractErrorMessage {\n    readonly id: string\n}\n\nexport interface SpeechErrorMessage extends AbstractErrorMessage {\n    readonly speech: string;\n    readonly parserError: string;\n}\n\nexport type Message = CommandMessage | ReportMessage | ConfirmationMessage\n    | BasicNegativeMessage | ErrorIdNotFoundMessage;\n\nexport type MessagePredicate = (msg: Message) => boolean;\n\n/**\n * \n * @param msg \n */\nexport function anyMsgOp(msg: Message): boolean { return true; }\n\n/**\n * \n * @param msg \n */\nexport function noneMsgOp(msg: Message): boolean { return false; }\n\n/**\n * \n * @param predicates \n */\nexport function andMsgOp(predicates: MessagePredicate[]): MessagePredicate {\n    return (msg: Message) => _.findIndex(predicates, (f, i) => !f(msg)) < 0;\n}\n\n/**\n * \n * @param predicates \n */\nexport function orMsgOp(...predicates: MessagePredicate[]): MessagePredicate {\n    return (msg: Message) => _.findIndex(predicates, f => f(msg)) >= 0;\n}\n\n/**\n * \n * @param predicate \n */\nexport function notMsgOp(predicate: MessagePredicate): MessagePredicate { return (msg: Message) => !predicate(msg); }\n\n/**\n * \n * @param tag \n */\nexport function tagMsgOp(tag: MessageTag): MessagePredicate { return (msg: Message) => msg.tags.indexOf(tag) >= 0; }\n\n/**\n * \n * @param msg \n */\nexport function isCommand(msg: Message): msg is CommandMessage {\n    return tagMsgOp(MessageTag.Command)(msg);\n}\n\nexport function isError(msg: Message): msg is AbstractErrorMessage {\n    return tagMsgOp(MessageTag.Error)(msg);\n}\n\nexport function isSpeechError(msg: Message): msg is SpeechErrorMessage {\n    return isError(msg) && (msg as SpeechErrorMessage).parserError !== undefined;\n}\n\nexport const isVoice = tagMsgOp(MessageTag.VoiceMessage);\n\n/**\n * \n * @param tags \n */\nexport function anyTagMsgOp(...tags: MessageTag[]): MessagePredicate {\n    const fTags = _.map(tags, t => tagMsgOp(t));\n    return orMsgOp.apply(undefined, fTags);\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param flightLevel \n * @parms tags\n */\nexport function buildClimbCommand(flightId: string, atcId: string, flightLevel: string, tags?: MessageTag[]): FlightLevelCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: Command.Climb,\n        flightLevel\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId\n * @param flightLevel \n * @param tags\n */\nexport function buildDescendCommand(flightId: string, atcId: string, flightLevel: string, tags?: MessageTag[]): FlightLevelCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: Command.Descend,\n        flightLevel\n    };\n}\n\n/**\n * \n * @param {*} flightId \n * @param {*} atcId\n * @param {*} flightLevel \n */\nexport function buildMaintainCommand(flightId: string, atcId: string, flightLevel: string, tags?: MessageTag[]): FlightLevelCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: Command.Maintain,\n        flightLevel\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param rwy \n * @param flightLevel \n */\nexport function buildTakeoffCommand(flightId: string, atcId: string, rwy: string, flightLevel: string, tags?: MessageTag[]): TakeoffCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: Command.ClearedToTakeoff,\n        flightLevel,\n        rwy\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param rwy \n */\nexport function buildLandCommand(flightId: string, atcId: string, rwy: string, tags?: MessageTag[]): LandCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: Command.ClearedToLand,\n        rwy\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param to \n * @param via \n */\nexport function buildFlyToCommand(flightId: string, atcId: string, to: string, via?: string, tags?: MessageTag[]): FlyToCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: via ? Command.FlyToVia : Command.FlyTo,\n        turnTo: to,\n        via\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param at \n */\nexport function buildHoldCommand(flightId: string, atcId: string, at?: string, tags?: MessageTag[]): HoldAtCommandMessage {\n    return {\n        from: atcId,\n        tags: _.concat([MessageTag.Command], tags || []),\n        to: flightId,\n        cmd: at ? Command.HoldAt : Command.HoldCurrentPosition,\n        at\n    };\n}\n\n/**\n * \n * @param flightId \n * @param atcId \n * @param at \n */\nexport function buildHoldShortCommand(flightId: string, atcId: string, at: string, tags?: MessageTag[]): HoldAtCommandMessage {\n    return {\n        from: atcId,\n        tags: [MessageTag.Command],\n        to: flightId,\n        cmd: Command.HoldShort,\n        at\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildATCNotFoundMessage(flight: string, atc: string): BasicNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.ATCNotFound\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param rwy\n */\nexport function buildAtGroundMessage(flight: string, atc: string, rwy: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.FlightAtGround,\n        id: rwy\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param rwy\n */\nexport function buildNotAtGroundMessage(flight: string, atc: string, rwy: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.FlightNotAtGround,\n        id: rwy\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildTooHighMessage(flight: string, atc: string): BasicNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.FlightTooHigh\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildTooDistanthMessage(flight: string, atc: string): BasicNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.RunwayTooDistant\n    };\n}\n\nexport function buildInvalidFlightLevelMessage(flight: string, atc: string, flightLevel: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.InvalidFlightLevel,\n        id: flightLevel\n    };\n}\n\nexport function buildRunwayNotFoundMessage(flight: string, atc: string, rwy: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.RunwayNotFound,\n        id: rwy\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param id\n */\nexport function buildBeaconNotFoundMessage(flight: string, atc: string, id: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.BeaconNotFound,\n        id\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildInvalidRunwayMessage(flight: string, atc: string, rwy: string): IdNegativeMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.Negative],\n        error: ErrorCode.InvalidRunway,\n        id: rwy\n    };\n}\n\n/**\n * \n * @param command \n */\nexport function buildReadbackMessage(command: CommandMessage): CommandMessage {\n    return _.assign({}, command, {\n        from: command.to,\n        to: command.from,\n        tags: [MessageTag.Readback]\n    });\n}\n\n/**\n * \n * @param flight \n * @param report \n */\nexport function buildCollisionMessage(flight: string, atc: string): BasicReportMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.Collision\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildOutOfAreaMessage(flight: string, atc: string): BasicReportMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.LeavingOutOfArea\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildEnterToMessage(flight: Flight, atc: string): EnterMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.EnterTo,\n        dest: flight.to,\n        via: flight.from\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildEnterLeaveMessage(flight: Flight, atc: string): EnterMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.EnterLeave,\n        dest: flight.to,\n        via: flight.from\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildFlyingToMessage(flight: Flight, atc: string): DestinationMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.FlyingTo,\n        dest: flight.at as string\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildLeavingMessage(flight: Flight, atc: string): DestinationMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.Leaving,\n        dest: flight.exit as string\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildLeavingMissingDepartureMessage(flight: Flight, atc: string): DestinationMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.LeavingMissingDearture,\n        dest: flight.exit as string\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param flightLevel \n */\n\nexport function buildPassingFlightLevelMessage(flight: string, atc: string, flightLevel: string | number): FlightLevelMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.PassingFlightLevel,\n        flightLevel: typeof flightLevel === 'string' ? flightLevel : sprintf('%03d', Math.round(flightLevel / 100))\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param flightLevel \n */\nexport function buildMissingApproachMessage(flight: string, atc: string, flightLevel: string | number): FlightLevelMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.GoingAroundMissingApproach,\n        flightLevel: typeof flightLevel === 'string' ? flightLevel : sprintf('%03d', Math.round(flightLevel / 100))\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n * @param flightLevel \n */\nexport function buildMissingRunwayMessage(flight: string, atc: string, flightLevel: string | number): FlightLevelMessage {\n    return {\n        from: flight,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.GoingAroundMissingRunway,\n        flightLevel: typeof flightLevel === 'string' ? flightLevel : sprintf('%03d', Math.round(flightLevel / 100))\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildDepartureToMessage(flight: Flight, atc: string): DepartureMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.ReadyToDepartureTo,\n        rwy: flight.from,\n        dest: flight.to\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildDepartureLeaveMessage(flight: Flight, atc: string): DepartureMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.ReadyToDepartureLeave,\n        rwy: flight.from,\n        dest: flight.to\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildRunwayVacated(flight: Flight, atc: string): RunwayMessage {\n    if (!flight.rwy) {\n        throw new Error('missing runway');\n    }\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.RunwayVacated,\n        rwy: flight.rwy\n    };\n}\n\n/**\n * \n * @param flight \n * @param atc \n */\nexport function buildWrongRunwayVacated(flight: Flight, atc: string): RunwayMessage {\n    return {\n        from: flight.id,\n        to: atc,\n        tags: [MessageTag.FlightReport],\n        report: Report.WrongRunwayVacated,\n        rwy: flight.rwy as string\n    };\n}\n\n/**\n * Returns a goodday message\n * @param atcId \n * @param flightId \n */\nexport function buildGoodDayMessage(atcId: string, flightId: string): BasicConfirmationMessage {\n    return {\n        from: atcId,\n        to: flightId,\n        tags: [MessageTag.Confirmation],\n        confirmation: Confirmation.GoodDay\n    }\n}\n\n/**\n * Returns a roger message\n * @param atcId \n * @param flightId \n */\nexport function buildRogerMessage(atcId: string, flightId: string): BasicConfirmationMessage {\n    return {\n        from: atcId,\n        to: flightId,\n        tags: [MessageTag.Confirmation],\n        confirmation: Confirmation.Roger\n    }\n}\n\n/**\n * Returns a cleared to beacon message\n * @param atcId \n * @param flightId \n * @param dest \n */\nexport function buildClearedToMessage(atcId: string, flightId: string, dest: string): ClearedToDestinationMessage {\n    return {\n        from: atcId,\n        to: flightId,\n        tags: [MessageTag.Confirmation],\n        confirmation: Confirmation.ClearedTo,\n        dest\n    }\n}\n/**\n * Returns a cleared to leave message\n * @param atcId \n * @param flightId \n * @param dest \n */\nexport function buildClearedToLeaveMessage(atcId: string, flightId: string, dest: string): ClearedToDestinationMessage {\n    return {\n        from: atcId,\n        to: flightId,\n        tags: [MessageTag.Confirmation],\n        confirmation: Confirmation.ClearedToLeave,\n        dest\n    }\n}\n\nexport function buildFlightNotFoundMessage(atcId: string, flightId: string): AbstractErrorMessage {\n    return {\n        from: atcId,\n        to: flightId,\n        tags: [MessageTag.Error],\n        error: ErrorCode.FlightNotFound\n    };\n}\n\nexport function buildUnitellegibleMessage(speech: string, parserError: string): SpeechErrorMessage {\n    return {\n        tags: [MessageTag.Error, MessageTag.VoiceMessage],\n        error: ErrorCode.Unitellegible,\n        speech, parserError\n    };\n\n}","import React, { Component } from 'react';\nimport { Button, ButtonGroup, ButtonToolbar, CardDeck, Col, Container, Jumbotron, Row } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { mapDao } from './MapDao';\nimport { sessionDao } from './SessionDao';\nimport { levelDao } from './LevelDao';\nimport { tap, toArray } from 'rxjs/operators';\nimport { LevelSelection } from './LevelSelection';\nimport { MapSelection } from './MapSelection';\nimport { AreaMapSet } from './Map';\nimport { LevelList } from './Level';\nimport { Session } from './Session';\nimport { ATCNavBar } from './ATCNavbar';\nimport { synthVoices } from './Audio';\n\ninterface HomeState {\n  readonly map?: string;\n  readonly maps?: AreaMapSet;\n  readonly level?: string;\n  readonly levels?: LevelList;\n  readonly sessions?: Session[];\n}\n/**\n * \n */\nclass Home extends Component<{}, HomeState> {\n\n  /**\n   * \n   * @param props \n   */\n  constructor(props: {}) {\n    super(props);\n    this.state = {};\n    _.bindAll(this, ['handleLevel', 'handleMap', 'handleStart', 'handleLoad']);\n  }\n\n  /**\n   * \n   */\n  componentDidMount() {\n    const th = this;\n    mapDao.getMaps().pipe(\n      tap(maps => {\n        th.setState({ maps, map: 'LON' });\n      })\n    ).subscribe();\n\n    levelDao.levels().pipe(\n      tap(levels => {\n        th.setState({ levels, level: levels.levels[0].id });\n      })\n    ).subscribe()\n\n    sessionDao.getSessions().pipe(\n      toArray(),\n      tap((sessions: Session[]) => {\n        th.setState({ sessions });\n      })\n    ).subscribe();\n  }\n\n  /**\n   * \n   */\n  handleStart() {\n    const { level = '', map: map1 = '' } = this.state;\n    synthVoices().pipe(\n      tap(voices => {\n        const atcVoice = voices.length > 0\n          ? Math.floor(Math.random() * voices.length).toString()\n          : undefined;\n        const session = sessionDao.create(level, map1, atcVoice);\n        window.location.href = process.env.REACT_APP_BASENAME + '#/sessions/' + session.id;\n      })\n    ).subscribe();\n  }\n\n  handleLoad() {\n    const { sessions } = this.state;\n    if (sessions) {\n      window.location.href = process.env.REACT_APP_BASENAME + '#/sessions/' + sessions[0].id;\n    }\n  }\n\n  /**\n   * \n   * @param level \n   */\n  handleLevel(level: string) {\n    this.setState({ level });\n  }\n\n  /**\n   * \n   * @param map \n   */\n  handleMap(map: string) {\n    this.setState({ map });\n  }\n\n  /**\n   * \n   */\n  render() {\n    const { levels = { levels: [] }, level, maps = { maps: {} }, map, sessions } = this.state;\n\n    return (\n      <Container fluid>\n        <ATCNavBar />\n        <Container>\n          <Jumbotron>\n            <h1>ATC</h1>\n            <Container>\n              <Row>\n                <Col>\n                  <CardDeck>\n                    <LevelSelection value={level} values={levels.levels} onSelect={this.handleLevel} />\n                    <MapSelection value={map} values={_.values(maps.maps)} onSelect={this.handleMap} />\n                  </CardDeck>\n                </Col>\n              </Row>\n              <Row>\n                <Col>\n                  <ButtonToolbar aria-label=\"Buttons\">\n                    <ButtonGroup className=\"mr-2\" aria-label=\"Start\">\n                      <Button onClick={this.handleStart} >Start</Button>\n                    </ButtonGroup>\n                    <ButtonGroup className=\"mr-2\" aria-label=\"Load\">\n                      <Button disabled={!sessions || sessions.length === 0}\n                        onClick={this.handleLoad}>Load last game</Button>\n                    </ButtonGroup>\n                  </ButtonToolbar>\n                </Col>\n              </Row>\n            </Container>\n          </Jumbotron>\n          <p>Your goal is to route safely the planes in your area.</p>\n          <p>You need to:</p>\n          <ul>\n            <li>take off planes waiting at runways</li>\n            <li>land the planes at destination runways</li>\n            <li>fly the planes via the leaving beacons at altitude\n\t\t\t\tof 36000 feet.</li>\n          </ul>\n          <p>You must avoid:</p>\n          <ul>\n            <li>planes collinsion, the collision happend when\n            the distance between two planes are lower then 4 nautic miles and\n\t\t\t\tthe altitude difference is lower then 1000 feet</li>\n            <li>leaving to a wrong beacons</li>\n            <li>landing to a wrong runway</li>\n          </ul>\n          <p>You can zoom the map using the mouse wheel and shift key or move the map by dragging it with the left mouse button</p>\n          <p>A click with the center mouse button fits the map to the viewport.</p>\n        </Container>\n      </Container >\n    );\n  }\n}\n\nexport default Home;\n","import React, { FunctionComponent, Component } from 'react';\nimport { Button, ButtonGroup, Card, Col, Container, Row } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { Flight, FlightStatus } from './Flight';\nimport { AreaMap, MapNodeType } from './Map';\nimport { buildClimbCommand, buildDescendCommand, buildFlyToCommand, buildHoldCommand, buildLandCommand, buildMaintainCommand, buildTakeoffCommand, CommandMessage } from './Message';\nimport { Session } from './Session';\n\nenum SelectionStatus {\n    FlightId = \"flight-id\",\n    Command = \"command\",\n    FlightLevel = \"flight-level\",\n    Turn = \"turn\",\n    TurnCondition = \"turn-condition\",\n    LandingRunway = \"landing-runway\",\n    HoldingCondition = \"holding-condition\"\n}\n\nconst FlightLveles = ['040', '080', '120', '160', '200', '240', '280', '320', '360'];\n\n/**\n * \n * @param param0 \n */\nconst CommandSelection: FunctionComponent<Readonly<Partial<{\n    flight: string;\n    onAbort: () => void;\n    onChangeFlightLevel: () => void;\n    onTurnHeading: () => void;\n    onClearToLand: () => void;\n    onClearToTakeoff: () => void;\n    onHold: () => void;\n}>>> = ({ flight, onAbort, onChangeFlightLevel, onTurnHeading, onClearToLand, onHold }) => {\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}\n            </Card.Header>\n            <Card.Body>\n                <ButtonGroup vertical>\n                    <Button variant=\"warning\"\n                        onClick={() => { if (!!onAbort) { onAbort() } }}>Abort</Button>\n                    <Button variant=\"secondary\"\n                        onClick={() => { if (!!onChangeFlightLevel) { onChangeFlightLevel() } }}>Change flight level</Button>\n                    <Button variant=\"secondary\"\n                        onClick={() => { if (!!onTurnHeading) { onTurnHeading() } }}>Fly to</Button>\n                    <Button variant=\"secondary\"\n                        onClick={() => { if (!!onClearToLand) { onClearToLand() } }}>Clear to land</Button>\n                    <Button variant=\"secondary\"\n                        onClick={() => { if (!!onHold) { onHold() } }}>Hold</Button>\n                </ButtonGroup>\n            </Card.Body>\n        </Card>\n    );\n}\n\n/**\n * \n * @param flights \n * @param onSelect \n */\nconst FlightSelection: FunctionComponent<Readonly<Partial<{\n    flights: Record<string, Flight>;\n    onSelect: (id: string) => void\n}>>> = ({ flights, onSelect }) => {\n    const ids = flights ? _(flights).keys().sort().value() : [];\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>Select flight</Card.Header>\n            <Card.Body>\n                <ButtonGroup vertical>\n                    {ids.map(id => (\n                        <Button key={id} variant=\"secondary\"\n                            onClick={() => { if (onSelect) { onSelect(id) } }\n                            }>{id}</Button>\n                    ))}\n                </ButtonGroup>\n            </Card.Body>\n        </Card >\n    );\n}\n\n/**\n * \n * @param param0 \n */\nconst RunwaySelection: FunctionComponent<Readonly<Partial<{\n    flight: string;\n    map: AreaMap;\n    onAbort: () => void;\n    onSelect: (id: string) => void;\n}>>> = ({ flight, map, onAbort, onSelect }) => {\n    const runways = map ? _(map.nodes)\n        .filter({ type: MapNodeType.Runway })\n        .map('id')\n        .sort().value() : [];\n\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}<br />\n                clear to land\n            </Card.Header>\n            <Card.Body>\n                <ButtonGroup vertical>\n                    <Button\n                        onClick={() => { if (!!onAbort) { onAbort() } }}\n                        variant=\"warning\">Abort</Button>\n                    {runways.map(id => (\n                        <Button key={id}\n                            onClick={() => { if (!!onSelect) { onSelect(id) } }}\n                            variant=\"secondary\" >{id}</Button>\n                    ))}\n                </ButtonGroup>\n            </Card.Body>\n        </Card >\n    );\n}\n\n/**\n * \n * @param param0 \n */\nconst DestinationSelection: FunctionComponent<Readonly<Partial<{\n    flight: string;\n    map: AreaMap;\n    onAbort: () => void;\n    onSelect: (id: string) => void;\n}>>> = ({ flight, map, onAbort, onSelect }) => {\n    const nodes = map ? _(map.nodes)\n        .filter(node =>\n            node.type === MapNodeType.Entry\n            || node.type === MapNodeType.Beacon)\n        .map('id').sort().value()\n        : [];\n    const numCol1 = Math.ceil((nodes.length + 1) / 2) - 1;\n    const nodes1 = _.take(nodes, numCol1);\n    const nodes2 = _.drop(nodes, numCol1);\n\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}<br />\n                turn to\n            </Card.Header>\n            <Card.Body>\n                <Container fluid>\n                    <Row>\n                        <Col>\n                            <ButtonGroup vertical>\n                                <Button\n                                    onClick={() => { if (!!onAbort) { onAbort() } }}\n                                    variant=\"warning\">Abort</Button>\n                                {nodes1.map(id => (\n                                    <Button key={id}\n                                        onClick={() => { if (!!onSelect) { onSelect(id) } }}\n                                        variant=\"secondary\" >{id}</Button>\n                                ))}\n                            </ButtonGroup>\n                        </Col>\n                        <Col>\n                            <ButtonGroup vertical>\n                                {nodes2.map(id => (\n                                    <Button key={id}\n                                        onClick={() => { if (!!onSelect) { onSelect(id) } }}\n                                        variant=\"secondary\" >{id}</Button>\n                                ))}\n                            </ButtonGroup>\n                        </Col>\n                    </Row>\n                </Container>\n            </Card.Body >\n        </Card >\n    );\n}\n\n/**\n * \n * @param param0 \n */\nconst ConditionButtons: FunctionComponent<Readonly<Partial<{\n    map: AreaMap;\n    onAbort: () => void;\n    onSelect: (id?: string) => void\n}>>> = ({ map, onAbort, onSelect }) => {\n    const nodes = map ? _(map.nodes)\n        .filter(node =>\n            node.type === MapNodeType.Entry\n            || node.type === MapNodeType.Beacon)\n        .map('id')\n        .sort().value()\n        : [];\n\n    const numCol1 = Math.ceil((nodes.length + 2) / 2) - 2;\n    const nodes1 = _.take(nodes, numCol1);\n    const nodes2 = _.drop(nodes, numCol1);\n\n    return (\n        <Container fluid>\n            <Row>\n                <Col>\n                    <ButtonGroup vertical>\n                        <Button\n                            onClick={() => { if (!!onAbort) { onAbort() } }}\n                            variant=\"warning\">Abort</Button>\n                        <Button\n                            onClick={() => { if (!!onSelect) { onSelect() } }}\n                            variant=\"primary\">Now</Button>\n                        {nodes1.map(id => (\n                            <Button key={id}\n                                onClick={() => { if (!!onSelect) { onSelect(id) } }}\n                                variant=\"secondary\" >{id}</Button>\n                        ))}\n                    </ButtonGroup>\n                </Col>\n                <Col>\n                    <ButtonGroup vertical>\n                        {nodes2.map(id => (\n                            <Button key={id}\n                                onClick={() => { if (!!onSelect) { onSelect(id) } }}\n                                variant=\"secondary\" >{id}</Button>\n                        ))}\n                    </ButtonGroup>\n                </Col>\n            </Row>\n        </Container>\n    );\n}\n\n\n/**\n * \n * @param param0 \n */\nconst ConditionSelection: FunctionComponent<Readonly<Partial<{\n    flight: string;\n    node: string;\n    map: AreaMap;\n    onAbort: () => void;\n    onSelect: (id: string | undefined) => void;\n}>>> = ({ flight, node, map, onAbort, onSelect }) => {\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}<br />\n                turn to {node}<br />\n                at beacon\n            </Card.Header>\n            <Card.Body>\n                <ConditionButtons\n                    map={map}\n                    onAbort={onAbort}\n                    onSelect={onSelect} />\n            </Card.Body>\n        </Card >\n    );\n}\n\n/**\n * \n * @param param0 \n */\nconst HoldCondition: FunctionComponent<Readonly<Partial<{\n    flight: string;\n    map: AreaMap;\n    onAbort: () => void;\n    onSelect: (id: string | undefined) => void;\n}>>> = ({ flight, map, onAbort, onSelect }) => {\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}<br />\n                hold on at\n            </Card.Header>\n            <Card.Body>\n                <ConditionButtons\n                    map={map}\n                    onAbort={onAbort}\n                    onSelect={onSelect} />\n            </Card.Body>\n        </Card >\n    );\n}\n\n/**\n * \n * @param param0 \n */\nconst FlightLevelSelection: FunctionComponent<Readonly<Partial<{\n    flight: string,\n    onAbort: () => void,\n    onSelect: (fl: string) => void\n}>>> = ({ flight, onAbort, onSelect }) => {\n    const flightLevels = _(FlightLveles).orderBy(_.identity, 'desc').value();\n    return (\n        <Card bg=\"dark\" text=\"white\">\n            <Card.Header>\n                Flight {flight}<br />\n                change flight level\n                </Card.Header>\n            <Card.Body>\n                <ButtonGroup vertical>\n                    <Button variant=\"warning\"\n                        onClick={() => { if (!!onAbort) { onAbort() } }}>Abort</Button>\n                    {flightLevels.map(fl => (\n                        <Button key={fl} variant=\"secondary\"\n                            className={`fl-${fl}`}\n                            onClick={() => { if (!!onSelect) { onSelect(fl) } }}> FL {fl}</Button>\n                    ))}\n                </ButtonGroup>\n            </Card.Body>\n        </Card >\n    );\n}\n\n/**\n * \n */\ntype CommandPaneProps = Readonly<Partial<{\n    session: Session;\n    map: AreaMap;\n    onCommand: (cmd: CommandMessage) => void\n}>>;\n\n/**\n * \n */\nexport class CommandPane extends Component<CommandPaneProps, Readonly<{\n    type: SelectionStatus;\n    flight?: string;\n    node?: string;\n}>> {\n\n    /**\n     * \n     * @param props \n     */\n    constructor(props: CommandPaneProps) {\n        super(props);\n        this.state = { type: SelectionStatus.FlightId };\n        _.bindAll(this, [\n            'handleFlightSelection',\n            'handleAbort',\n            'handleChangeFlightLevel',\n            'handleFlightLevelSelect',\n            'handleTurnHeading',\n            'handleTurnHeadingSelect',\n            'handleTurnConditionSelect',\n            'handleClearToLand',\n            'handleRunwaySelect',\n            'handleHold',\n            'handleHoldConditionSelect'\n        ]);\n    }\n\n    /**\n     * \n     * @param flight \n     */\n    handleFlightSelection(flight: string) {\n        this.setState({ flight, type: SelectionStatus.Command });\n    }\n\n    /**\n     * \n     */\n    handleAbort() {\n        this.setState({ type: SelectionStatus.FlightId });\n    }\n\n    /**\n     * \n     */\n    handleChangeFlightLevel() {\n        this.setState({ type: SelectionStatus.FlightLevel });\n    }\n\n    /**\n     * \n     * @param fl \n     */\n    handleFlightLevelSelect(fl: string) {\n        const toAlt = parseInt(fl) * 100;\n        const { flight: flightId } = this.state;\n        const { session, onCommand } = this.props;\n        const mapId = this.mapId;\n        if (onCommand && flightId && session && mapId) {\n            const flight = session.flights[flightId];\n            if (!flight) {\n                onCommand(buildClimbCommand(flightId, mapId, fl));\n            } else if (flight.status === FlightStatus.WaitingForTakeoff) {\n                onCommand(buildTakeoffCommand(flightId, mapId, flight.from, fl));\n            } else if (toAlt > flight.alt) {\n                onCommand(buildClimbCommand(flightId, mapId, fl));\n            } else if (toAlt < flight.alt) {\n                onCommand(buildDescendCommand(flightId, mapId, fl));\n            } else {\n                onCommand(buildMaintainCommand(flightId, mapId, fl));\n            }\n        }\n        this.setState({ type: SelectionStatus.FlightId });\n    }\n\n    /** */\n    handleTurnHeading() {\n        this.setState({ type: SelectionStatus.Turn });\n    }\n\n    /**\n     * \n     * @param node \n     */\n    handleTurnHeadingSelect(node: string) {\n        this.setState({ node, type: SelectionStatus.TurnCondition });\n    }\n\n    get mapId() { return this.props.map ? this.props.map.id : undefined; }\n    /**\n     * \n     * @param when \n     */\n    handleTurnConditionSelect(when?: string) {\n        const { flight, node } = this.state;\n        const { onCommand } = this.props;\n        const mapId = this.mapId;\n        if (mapId && onCommand && node && flight) {\n            onCommand(\n                buildFlyToCommand(flight, mapId, node, when)\n            );\n        }\n        this.setState({ type: SelectionStatus.FlightId });\n    }\n\n    /** */\n    handleClearToLand() {\n        this.setState({ type: SelectionStatus.LandingRunway });\n    }\n\n    /**\n     * \n     * @param node \n     */\n    handleRunwaySelect(node: string) {\n        const { flight } = this.state;\n        const { onCommand } = this.props;\n        const mapId = this.mapId;\n        if (onCommand && mapId && flight) {\n            onCommand(\n                buildLandCommand(flight, mapId, node)\n            );\n        }\n        this.setState({ type: SelectionStatus.FlightId });\n    }\n\n    /** */\n    handleHold() {\n        this.setState({ type: SelectionStatus.HoldingCondition });\n    }\n\n    /**\n     * \n     * @param when \n     */\n    handleHoldConditionSelect(when?: string) {\n        const { flight } = this.state;\n        const { onCommand } = this.props;\n        const mapId = this.mapId;\n        if (onCommand && flight && mapId) {\n            onCommand(\n                buildHoldCommand(flight, mapId, when)\n            );\n        }\n        this.setState({ type: SelectionStatus.FlightId });\n    }\n\n    /**\n     * \n     */\n    render() {\n        const { session, map } = this.props;\n        const flights = session ? session.flights : undefined;\n        const { type, flight, node } = this.state;\n        switch (type) {\n            case SelectionStatus.Command:\n                return (<CommandSelection onAbort={this.handleAbort}\n                    onChangeFlightLevel={this.handleChangeFlightLevel}\n                    onTurnHeading={this.handleTurnHeading}\n                    onClearToLand={this.handleClearToLand}\n                    onHold={this.handleHold}\n                    flight={flight} />);\n            case SelectionStatus.FlightLevel:\n                return (<FlightLevelSelection\n                    flight={flight}\n                    onAbort={this.handleAbort}\n                    onSelect={this.handleFlightLevelSelect} />);\n            case SelectionStatus.TurnCondition:\n                return (<ConditionSelection map={map}\n                    flight={flight}\n                    node={node}\n                    onAbort={this.handleAbort}\n                    onSelect={this.handleTurnConditionSelect} />);\n            case SelectionStatus.Turn:\n                return (<DestinationSelection map={map}\n                    flight={flight}\n                    onAbort={this.handleAbort}\n                    onSelect={this.handleTurnHeadingSelect} />);\n            case SelectionStatus.LandingRunway:\n                return (<RunwaySelection map={map}\n                    flight={flight}\n                    onAbort={this.handleAbort}\n                    onSelect={this.handleRunwaySelect} />);\n            case SelectionStatus.HoldingCondition:\n                return (<HoldCondition map={map}\n                    flight={flight}\n                    onAbort={this.handleAbort}\n                    onSelect={this.handleHoldConditionSelect} />);\n            default:\n                return (<FlightSelection flights={flights} onSelect={this.handleFlightSelection} />);\n        }\n    }\n}\n","import _ from 'lodash';\nimport { AreaMap } from './Map';\nimport { anyTagMsgOp, Message, MessageTag, notMsgOp } from './Message';\nimport { Session } from './Session';\n\nexport enum Style {\n    ATC = 'atc',\n    Flight = 'flight',\n    Error = 'error'\n}\n\nexport type MessageText = Readonly<{\n    style: Style;\n    text: string;\n}>;\n\nconst isFromFlight = anyTagMsgOp(MessageTag.FlightReport, MessageTag.Negative, MessageTag.Readback);\nconst isFromAtc = notMsgOp(isFromFlight);\n\nconst TextBuilderPattern: Readonly<Record<string, Readonly<{\n    style: Style,\n    templ: string\n}>>> = {\n    'flight-report.ready-to-departure-to': {\n        style: Style.Flight,\n        templ: '$atc, $from, holding short runway $rwy ready for departure to runway $dest'\n    },\n    'flight-report.ready-to-departure-leave': {\n        style: Style.Flight,\n        templ: '$atc, $from, holding short runway $rwy ready for departure via $dest'\n    },\n    'flight-report.enter-to': {\n        style: Style.Flight,\n        templ: '$atc, $from, enter control zone via $via to runway $dest'\n    },\n    'flight-report.enter-leave': {\n        style: Style.Flight,\n        templ: '$atc, $from, enter control zone via $via leave $dest'\n    },\n    'flight-report.passing-flight-level': {\n        style: Style.Flight,\n        templ: '$atc, $from, passing FL$flightLevel'\n    },\n    'flight-report.flying-to': {\n        style: Style.Flight,\n        templ: '$atc, $from, flying to $dest'\n    },\n    'flight-report.runway-vacated': {\n        style: Style.Flight,\n        templ: '$atc, $from, runway $rwy vacated'\n    },\n    'flight-report.wrong-runway-vacated': {\n        style: Style.Flight,\n        templ: '$atc, $from, runway $rwy vacated, wrong arrival'\n    },\n    'flight-report.going-around-missing-approach': {\n        style: Style.Flight,\n        templ: '$atc, $from, going around missing approach'\n    },\n    'flight-report.going-around-missing-runway': {\n        style: Style.Flight,\n        templ: '$atc, $from, going around missing runway'\n    },\n    'flight-report.leaving': {\n        style: Style.Flight,\n        templ: '$atc, $from, leaving controlled zone via $dest'\n    },\n    'flight-report.leaving-missing-departure': {\n        style: Style.Flight,\n        templ: '$atc, $from, leaving controlled zone via $dest, missing departure'\n    },\n    'flight-report.leaving-out-of-area': {\n        style: Style.Flight,\n        templ: '$atc, $from, leaving controlled zone, missing departure'\n    },\n    'flight-report.collision': {\n        style: Style.Flight,\n        templ: '$atc, $from, mayday, mayday, mayday, collision'\n    },\n    'command.climb': {\n        style: Style.ATC,\n        templ: '$to, $atc, climb to FL$flightLevel'\n    },\n    'readback.climb': {\n        style: Style.Flight,\n        templ: 'climbing to FL$flightLevel, $from'\n    },\n    'command.descend': {\n        style: Style.ATC,\n        templ: '$to, $atc, descend to FL$flightLevel'\n    },\n    'readback.descend': {\n        style: Style.Flight,\n        templ: 'descending to FL$flightLevel, $from'\n    },\n    'command.maintain': {\n        style: Style.ATC,\n        templ: '$to, $atc, maintain FL$flightLevel'\n    },\n    'readback.maintain': {\n        style: Style.Flight,\n        templ: 'maintaining FL$flightLevel, $from'\n    },\n    'command.cleared-to-takeoff': {\n        style: Style.ATC,\n        templ: '$to, $atc, runway $rwy cleared to takeoff, climb to FL$flightLevel'\n    },\n    'readback.cleared-to-takeoff': {\n        style: Style.Flight,\n        templ: 'runway $rwy cleared to takeoff, climbing to FL$flightLevel, $from'\n    },\n    'command.fly-to': {\n        style: Style.ATC,\n        templ: '$to, $atc, fly to $turnTo'\n    },\n    'readback.fly-to': {\n        style: Style.Flight,\n        templ: 'flying to $turnTo, $from'\n    },\n    'command.fly-to-via': {\n        style: Style.ATC,\n        templ: '$to, $atc, fly to $turnTo via $via'\n    },\n    'readback.fly-to-via': {\n        style: Style.Flight,\n        templ: 'flying to $turnTo via $via, $from'\n    },\n    'command.cleared-to-land': {\n        style: Style.ATC,\n        templ: '$to, $atc, cleared to land runway $rwy'\n    },\n    'readback.cleared-to-land': {\n        style: Style.Flight,\n        templ: 'cleared to land runway $rwy, $from'\n    },\n    'command.hold-short': {\n        style: Style.ATC,\n        templ: '$to, $atc, hold short runway $at'\n    },\n    'readback.hold-short': {\n        style: Style.Flight,\n        templ: 'holding short runway $at, $from'\n    },\n    'command.hold-current-position': {\n        style: Style.ATC,\n        templ: '$to, $atc, hold at current position'\n    },\n    'readback.hold-current-position': {\n        style: Style.Flight,\n        templ: 'holding at current position, $from'\n    },\n    'command.hold-at': {\n        style: Style.ATC,\n        templ: '$to, $atc, hold at $at'\n    },\n    'readback.hold-at': {\n        style: Style.Flight,\n        templ: 'holding at $at, $from'\n    },\n    'negative.flight-at-ground': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, holding short runway $id'\n    },\n    'negative.runway-too-distant': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, wrong distance'\n    },\n    'negative.flight-too-high': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, wrong flight level'\n    },\n    'negative.atc-not-found': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, ATC not in area'\n    },\n    'negative.beacon-not-found': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, $id not in area'\n    },\n    'negative.flight-not-at-ground': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, not holding short runway $id'\n    },\n    'negative.invalid-flight-level': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, invalid FL$id'\n    },\n    'negative.invalid-runway': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, invalid runway $id'\n    },\n    'negative.runway-not-found': {\n        style: Style.Flight,\n        templ: '$atc, $from, negative, runway $id not in area'\n    },\n    'error.flight-not-found': {\n        style: Style.Error,\n        templ: 'operator, flight $to not in area'\n    },\n    'confirmation.cleared-to': {\n        style: Style.ATC,\n        templ: '$to, $atc, cleared to $dest'\n    },\n    'confirmation.cleared-to-leave': {\n        style: Style.ATC,\n        templ: '$to, $atc, cleared to leave via $dest'\n    },\n    'confirmation.good-day': {\n        style: Style.ATC,\n        templ: '$to, $atc, good day'\n    },\n    'confirmation.roger': {\n        style: Style.ATC,\n        templ: '$to, $atc, roger'\n    },\n    'error.unintelligible': {\n        style: Style.Error,\n        templ: 'unintelligeble $speech, $errCode'\n    }\n};\nconst AudioBuilderPattern: Record<string, string> = {\n    'flight-report.ready-to-departure-to': '$fromVoice $atc $from holding short runway $rwy ready for departure to runway $dest',\n    'flight-report.ready-to-departure-leave': '$fromVoice $atc $from holding short runway $rwy ready for departure via $dest',\n    'flight-report.enter-to': '$fromVoice $atc $from enter control zone via $via to runway $dest',\n    'flight-report.enter-leave': '$fromVoice $atc $from enter control zone via $via leave $dest',\n    'flight-report.passing-flight-level': '$fromVoice $atc $from passing flight level $flightLevel',\n    'flight-report.flying-to': '$fromVoice $atc $from flying to $dest',\n    'flight-report.runway-vacated': '$fromVoice $atc $from runway $rwy vacated',\n    'flight-report.wrong-runway-vacated': '$fromVoice $atc $from runway $rwy vacated wrong arrival',\n    'flight-report.going-around-missing-approach': '$fromVoice $atc $from going around missing approach',\n    'flight-report.going-around-missing-runway': '$fromVoice $atc $from going around missing runway',\n    'flight-report.leaving': '$fromVoice $atc $from leaving controlled zone via $dest',\n    'flight-report.leaving-missing-departure': '$fromVoice $atc $from leaving controlled zone via $dest missing departure',\n    'flight-report.leaving-out-of-area': '$fromVoice $atc $from leaving controlled zone missing departure',\n    'flight-report.collision': '$fromVoice $atc $from mayday mayday mayday collision',\n    'command.climb': '$fromVoice $to $atc climb to flight level $flightLevel',\n    'readback.climb': '$fromVoice climbing to flight level $flightLevel $from',\n    'command.descend': '$fromVoice $to $atc descend to flight level $flightLevel',\n    'readback.descend': '$fromVoice descending to flight level $flightLevel $from',\n    'command.maintain': '$fromVoice $to $atc maintain flight level $flightLevel',\n    'readback.maintain': '$fromVoice maintaining flight level $flightLevel $from',\n    'command.cleared-to-takeoff': '$fromVoice $to $atc runway $rwy cleared to takeoff climb to flight level $flightLevel',\n    'readback.cleared-to-takeoff': '$fromVoice runway $rwy cleared to takeoff climbing to flight level $flightLevel $from',\n    'command.fly-to': '$fromVoice $to $atc fly to $turnTo',\n    'readback.fly-to': '$fromVoice flying to $turnTo $from',\n    'command.fly-to-via': '$fromVoice $to $atc fly to $turnTo via $via',\n    'readback.fly-to-via': '$fromVoice flying to $turnTo via $via $from',\n    'command.cleared-to-land': '$fromVoice $to $atc cleared to land runway $rwy',\n    'readback.cleared-to-land': '$fromVoice cleared to land runway $rwy $from',\n    'command.hold-short': '$fromVoice $to $atc hold short runway $at',\n    'readback.hold-short': '$fromVoice holding short runway $at $from',\n    'command.hold-current-position': '$fromVoice $to $atc hold at current position',\n    'readback.hold-current-position': '$fromVoice holding at current position $from',\n    'command.hold-at': '$fromVoice $to $atc hold at $at',\n    'readback.hold-at': '$fromVoice holding at $at $from',\n    'negative.flight-at-ground': '$fromVoice $atc $from negative holding short runway $id',\n    'negative.runway-too-distant': '$fromVoice $atc $from negative wrong distance',\n    'negative.flight-too-high': '$fromVoice $atc $from negative wrong flight level',\n    'negative.atc-not-found': '$fromVoice $to $from negative ATC not in area',\n    'negative.beacon-not-found': '$fromVoice $atc $from negative $id not in area',\n    'negative.flight-not-at-ground': '$fromVoice $atc $from negative not holding short runway $id',\n    'negative.invalid-flight-level': '$fromVoice $atc $from negative invalid flight level $flId',\n    'negative.invalid-runway': '$fromVoice $atc $from negative invalid runway $id',\n    'negative.runway-not-found': '$fromVoice $atc $from negative runway $id not in area',\n    'error.flight-not-found': '$fromVoice operator flight $to not in area',\n    'confirmation.cleared-to': '$fromVoice $to $atc cleared to $dest',\n    'confirmation.cleared-to-leave': '$fromVoice $to $atc cleared to leave via $dest',\n    'confirmation.good-day': '$fromVoice $to $atc good day',\n    'confirmation.roger': '$fromVoice $to $atc roger',\n    'error.unintelligible': '$atcVoice unintelligeble $speech, $errCode'\n};\n\nconst TokenRegex = /^(\\w+)(.*)/;\n\nabstract class Builder<T> {\n    private _message: Message;\n    private _map: AreaMap;\n\n    /**\n     * \n     * @param message \n     * @param map \n     */\n    constructor(message: Message, map: AreaMap) {\n        this._message = message;\n        this._map = map;\n        _.bindAll(this);\n    }\n\n    /** */\n    get map(): AreaMap { return this._map; }\n\n    /** */\n    get message(): Message { return this._message; }\n\n    /** */\n    abstract build(): T\n\n    /**\n     * \n     * @param templ \n     */\n    applyTemplate(templ: string): string {\n        const sections = templ.split('$');\n        const prefixes = _(sections).drop(1);\n        const prefixSplits = prefixes.flatMap(prefix => {\n            const m = prefix.match(TokenRegex);\n            if (m) {\n                return ['$' + m[1], m[2]];\n            } else {\n                return ['$', prefix];\n            }\n        }).value();\n        const tokens = _.concat(sections[0], prefixSplits);\n        const values = _.map(tokens, tok => {\n            if (tok === '$' || !tok.startsWith('$')) {\n                return tok\n            } else {\n                const fnId = tok.substring(1);\n                const fn = (this as any)[fnId];\n                if (!fn) {\n                    return tok;\n                }\n                const value = (fn as () => string).apply(this);\n                return value ? value : tok;\n            }\n        });\n        return values.join('');\n    }\n\n    key(): string {\n        const type = this.message.tags[0];\n        const msg = this.message as any;\n        const subtype = msg.cmd || msg.report || msg.error || msg.confirmation;\n        return [type, subtype].join('.');\n    }\n\n    atc(): string {\n        const id = isFromAtc(this.message) ? this.message.from : this.message.to\n        return !id ? '?' : this.map.id === id ? this.map.name : id;\n    }\n\n    /** */\n    at(): string {\n        const at = (this.message as any).at;\n        return !at ? '?' : at;\n    }\n\n    /** */\n    to(): string {\n        const to = this.message.to;\n        return !to ? '?' : to;\n    }\n\n    /** */\n    from(): string {\n        const from = this.message.from;\n        return !from ? '?' : from;\n    }\n\n    dest(): string {\n        const msg = this.message as any;\n        return msg.dest !== undefined ? msg.dest : '?';\n    }\n\n    via(): string {\n        const msg = this.message as any;\n        return msg.via !== undefined ? msg.via : '?';\n    }\n\n    rwy(): string {\n        const msg = this.message as any;\n        return msg.rwy !== undefined ? msg.rwy : '?';\n    }\n\n    flightLevel(): string {\n        const msg = this.message as any;\n        return msg.flightLevel !== undefined ? msg.flightLevel : '?';\n    }\n\n    turnTo(): string {\n        const msg = this.message as any;\n        return msg.turnTo !== undefined ? msg.turnTo : '?';\n    }\n\n    id(): string {\n        const id = (this.message as any).id;\n        return id !== undefined ? id : '?';\n    }\n\n    speech() {\n        const speech = (this.message as any).speech;\n        return speech !== undefined ? speech : '?';\n    }\n\n    errCode() {\n        const errCode = (this.message as any).parserError;\n        return errCode !== undefined ? errCode : '?';\n    }\n}\n\nconst SpellingWords: Record<string, string> = Object.freeze({\n    a: 'alpha',\n    b: 'bravo',\n    c: 'charlie',\n    d: 'delta',\n    e: 'echo',\n    f: 'fox trot',\n    g: 'golf',\n    h: 'hotel',\n    i: 'india',\n    j: 'juliet',\n    k: 'kilo',\n    l: 'lima',\n    m: 'mike',\n    n: 'november',\n    o: 'oscar',\n    p: 'papa',\n    q: 'quebeck',\n    r: 'romeo',\n    s: 'sierra',\n    t: 'tango',\n    u: 'uniform',\n    v: 'victor',\n    x: 'x-ray',\n    w: 'whiskey',\n    y: 'yenkee',\n    z: 'zulu',\n    '0': 'zero',\n    '1': 'one',\n    '2': 'two',\n    '3': 'three',\n    '4': 'four',\n    '5': 'five',\n    '6': 'six',\n    '7': 'seven',\n    '8': 'eight',\n    '9': 'niner'\n});\n\nconst RunwaySuffix: Record<string, string> = Object.freeze({\n    r: 'right',\n    c: 'center',\n    l: 'left'\n});\n\n/**\n * \n * @param word \n */\nfunction spell(word: string): string {\n    const x = word.toLowerCase();\n    const z = _(x).map(a => {\n        const sp = SpellingWords[a];\n        return sp !== undefined ? sp : a;\n    }).join(' ');\n    return z;\n}\n\n\n/**\n * \n * @param {id} id \n */\nfunction spellId(id: string): string {\n    const m = /^(\\d.)(r|l|c)?/g.exec(id.toLowerCase());\n    if (m && m.length === 3) {\n        return !!m[2]\n            ? `${spell(m[1])} ${RunwaySuffix[m[2]]}`\n            : `${spell(m[1])}`\n\n    } else {\n        return spell(id);\n    }\n}\n\n\nexport class TextBuilder extends Builder<MessageText> {\n    constructor(message: Message, map: AreaMap) {\n        super(message, map);\n        _.bindAll(this);\n    }\n\n    build(): MessageText {\n        const pattern = TextBuilderPattern[this.key()];\n        if (pattern) {\n            const style = pattern.style;\n            const text = this.applyTemplate(pattern.templ);\n            return { style, text };\n        } else {\n            return { style: Style.Error, text: this.key() };\n        }\n    }\n}\n\n/** */\nexport class AudioBuilder extends Builder<string> {\n    private _session: Session;\n\n    constructor(message: Message, map: AreaMap, session: Session) {\n        super(message, map);\n        this._session = session;\n        _.bindAll(this);\n    }\n\n    get session() { return this._session; }\n\n\n    build(): string {\n        const pattern = AudioBuilderPattern[this.key()];\n        return pattern\n            ? this.applyTemplate(pattern)\n            : this.key();\n    }\n\n    atcVoice() {\n        return this.session.atcVoice;\n    }\n\n    fromVoice(): string {\n        const from = super.from();\n        if (this.map.id === from) {\n            return this.session.atcVoice || '?';\n        }\n        const flight = this.session.flights[from];\n        return (flight ? (flight.voice || this.session.atcVoice)\n            : this.session.atcVoice) || '?';\n    }\n\n    from(): string { return spellId(super.from()); }\n\n    to(): string { return spellId(super.to()); }\n\n    dest(): string { return spellId(super.dest()); }\n\n    rwy(): string { return spellId(super.rwy()); }\n\n    via(): string { return spellId(super.via()); }\n\n    turnTo(): string { return spellId(super.turnTo()); }\n\n    flightLevel(): string { return spell(super.flightLevel()); }\n\n    id(): string { return spellId(super.id()); }\n\n    at(): string { return spellId(super.at()); }\n\n    flId(): string { return spell(super.id()); }\n}\n","import React from 'react';\nimport _ from 'lodash';\nimport '../App.css';\nimport { MessageText, Style } from './MessageConverters';\nimport { toast } from 'react-toastify';\n\n/**\n * \n */\nexport class CockpitLogger {\n    private _log: MessageText[];\n    readonly maxMessages: number;\n\n    constructor(maxMessages: number = 10) {\n        this._log = [];\n        this.maxMessages = maxMessages;\n        _.bindAll(this, ['putMessages']);\n    }\n\n    /**\n     * \n     */\n    get log(): MessageText[] { return this._log; }\n\n    /**\n     * \n     */\n    putMessages(messages: MessageText[]): CockpitLogger {\n        this._log = _(this.log).concat(messages).takeRight(this.maxMessages).value();\n        messages.forEach(msg => {\n            switch (msg.style) {\n                case Style.ATC:\n                    toast.dark(\n                        <div className=\"bg-light text-success border-success border rounded p-2\">\n                            {msg.text}\n                        </div>\n                    );\n                    break;\n                case Style.Error:\n                    toast.dark(\n                        <div className=\"bg-light text-danger border-danger border rounded p-2\">\n                            {msg.text}\n                        </div>\n                    );\n                    break;\n                default:\n                    toast.dark(\n                        <div className=\"bg-light text-dark border-light border rounded p-2\">\n                            {msg.text}\n                        </div>\n                    );\n                    break;\n            }\n        });\n        return this;\n    }\n}\n\n/**\n * \n */\nexport function cockpitLogger(): CockpitLogger {\n    return new CockpitLogger();\n}\n","import { fromJS, Map } from 'immutable';\nimport { mapDao } from './MapDao';\nimport _ from 'lodash';\nimport {\n    Message, Command,\n    CommandMessage, FlightLevelCommandMessage, HoldAtCommandMessage, FlyToCommandMessage, TakeoffCommandMessage, LandCommandMessage,\n    buildReadbackMessage, buildInvalidFlightLevelMessage, buildBeaconNotFoundMessage,\n    buildAtGroundMessage, buildNotAtGroundMessage, buildRunwayNotFoundMessage,\n    buildATCNotFoundMessage, buildInvalidRunwayMessage, buildMissingRunwayMessage, buildMissingApproachMessage,\n    buildPassingFlightLevelMessage, buildTooDistanthMessage, buildTooHighMessage,\n    buildFlyingToMessage,\n    buildRogerMessage,\n    buildClimbCommand,\n    buildClearedToMessage\n} from './Message';\nimport { AreaMap, GeoLocation, isRunway, isEntryNode } from './Map';\nimport { Flight, FlightStatus, FlightType } from './Flight';\nimport { Level } from './Level';\nimport { sprintf } from 'sprintf-js';\n\nconst MIN_ALTITUDE = 4000;\nconst MAX_ALTITUDE = 36000;\nconst ALTITUDE_SEPARATION = 4000;\nconst TURNING_SPEED = 3; // DEG / s\nconst SECS_PER_HOUR = 3600;\nconst MINS_PER_SEC = 1.0 / 60;\nconst FEET_PER_NM = 1852 / 0.3048;\nconst RADS_PER_DEG = Math.PI / 180;\nconst RADIUS_PER_KNOTS = 1 / 60 / Math.PI;\nconst VALIDATION_PROPS = ['hdg', 'speed', 'lat', 'lon', 'alt'];\n\nexport interface FlightTemplate {\n    readonly speed0: number;    // knot\n    readonly speed360: number;  // knot\n    readonly vspeed: number;    // ftpm\n}\n\nexport interface SimulationOptions {\n    readonly dt: number;                // sec\n    readonly jetProb: number;\n    readonly safeEntryDelay: number;    // sec\n    readonly entryAlt: number;          // feet\n    readonly exitAlt: number;           // feet\n    readonly collisionDistance: number; // nms\n    readonly collisionAlt: number;      // feet\n    readonly om: number;                // nms\n    readonly mm: number;                // nms (5469')\n    readonly clearToLandDistance: number;   // nms\n    readonly exitDistance: number;      // nms\n    readonly landingHdgRange: number;   // DEG\n    readonly landingAngle: number;      // DEG\n    readonly conditionDistance: number; // nms\n    readonly holdingDuration: number,   // sec\n    readonly goAroundAlt: number,       // feet\n    readonly flightTempl: Record<FlightType, FlightTemplate>;\n    readonly flightVoices: string[];\n}\n\nexport interface SimulationProps extends SimulationOptions {\n    readonly map: AreaMap;\n    readonly level: Level;\n}\n\n/**\n * \n * @param alt \n * @param template \n */\nfunction speedByAlt(alt: number, template: FlightTemplate): number {\n    return Math.round(alt / 36000 * (template.speed360 - template.speed0) + template.speed0);\n}\n\nexport type Modifier = (flight: Map<string, any>) => Map<string, any>;\n\n/**\n * \n * @param key \n * @param value \n */\nexport const setMod: <T>(key: string, value: T) => Modifier =\n    (key, value) => (flight: Map<string, any>) => flight.set(key, value);\n\n/**\n * \n * @param key \n */\nexport const deleteMod: (key: string) => Modifier =\n    (key) => (flight: Map<string, any>) => flight.delete(key);\n\n/**\n * \n * @param key \n * @param updater \n */\nexport const updateMod: <T>(key: string, updater: (value: T) => T) => Modifier =\n    (key, updater) => (flight: Map<string, any>) => flight.update(key, updater);\n\n/**\n * \n * @param loc \n */\nexport const setLocationMod: (loc: GeoLocation) => Modifier =\n    (loc) => (flight: Map<string, any>) => flight.set('lat', loc.lat).set('lon', loc.lon)\n\ninterface Junction {\n    /** Entry point */\n    readonly entry: GeoLocation;\n    /** Pivot */\n    readonly pivot: GeoLocation;\n    /** sigma */\n    readonly sigma: number;\n    /** true if right junction */\n    readonly right: boolean;\n}\n\n/**\n * \n */\nexport class FlightProcessor {\n    private _flight: Flight;\n    private _messages: Message[];\n    private _props: SimulationProps;\n\n    /**\n     * \n     * @param flight \n     * @param props \n     * @param messages \n     */\n    constructor(flight: Flight, props: SimulationProps, messages: Message[] = []) {\n        this._flight = flight;\n        this._messages = messages;\n        this._props = props;\n        _.bindAll(this);\n    }\n\n    /** */\n    get messages() { return this._messages; }\n\n    /** */\n    get props() { return this._props; }\n\n    /** Returns the JSON flight */\n    get flight() { return this._flight; }\n\n    /** */\n    get map() { return this.props.map; }\n\n    /** */\n    private addFlyingToDialog(): FlightProcessor {\n        const { at } = this.flight;\n        if (!at) {\n            throw new Error('missing at');\n        }\n        return this.addMessage([\n            buildFlyingToMessage(this.flight, this.map.id),\n            buildClearedToMessage(this.map.id, this.flight.id, at)\n        ]);\n    }\n\n    /** */\n    private addMissingApproachDialog(): FlightProcessor {\n        const fl = sprintf('%03d', Math.round(this.flight.toAlt / 100));\n        const climbMsg = buildClimbCommand(this.flight.id, this.map.id, fl);\n        return this.addMessage([\n            buildMissingApproachMessage(this.flight.id, this.map.id, fl),\n            climbMsg,\n            buildReadbackMessage(climbMsg)\n        ]);\n    }\n\n    /** */\n    private addMissingRunwayDialog(): FlightProcessor {\n        const fl = sprintf('%03d', Math.round(this.flight.toAlt / 100));\n        const climbMsg = buildClimbCommand(this.flight.id, this.map.id, fl);\n        return this.addMessage([\n            buildMissingRunwayMessage(this.flight.id, this.map.id, fl),\n            climbMsg,\n            buildReadbackMessage(climbMsg)\n        ]);\n    }\n\n    /** */\n    private addPassingFlightLevelDialog(): FlightProcessor {\n        return this.addMessage([\n            buildPassingFlightLevelMessage(this.flight.id, this.map.id, this.flight.alt),\n            buildRogerMessage(this.map.id, this.flight.id)\n        ]);\n    }\n\n    /**\n     * \n     */\n    vspeed(): number {\n        return this.props.flightTempl[this.flight.type].vspeed;\n    }\n\n    /**\n     * Returns the landing altitude in feet\n     * @param distance the distance nms or undefined if from flight location\n     */\n    landingAlt(distance?: number): number {\n        const { landingAngle, map } = this.props;\n        if (!distance) {\n            const { rwy } = this.flight;\n            if (!rwy) {\n                throw new Error('missing runway');\n            }\n            const d = mapDao.distance(map.nodes[rwy], this.flight);\n            return Math.round(d * Math.tan(landingAngle * RADS_PER_DEG) * FEET_PER_NM);\n        } else {\n            return Math.round(distance * Math.tan(landingAngle * RADS_PER_DEG) * FEET_PER_NM);\n        }\n    }\n\n    /**\n     * Returns the outermarker alt\n     */\n    outerMarkerAlt(): number {\n        return this.landingAlt(this.props.om);\n    }\n\n    /**\n     * \n     * @param rwyId \n     */\n    outerMarker(rwyId?: string): GeoLocation {\n        rwyId = rwyId || this.flight.rwy || '';\n        if (!rwyId) {\n            throw new Error('missing runway');\n        }\n        const { om, map } = this.props;\n        const rwy = map.nodes[rwyId];\n        if (!isRunway(rwy)) {\n            throw new Error('not a runway');\n        }\n        return mapDao.radial(rwy, rwy.hdg + 180, om);\n    }\n\n    /**\n     * \n     * @param rwyId \n     */\n    midleMarker(rwyId?: string): GeoLocation {\n        rwyId = rwyId || this.flight.rwy;\n        if (!rwyId) {\n            throw new Error('missing runway');\n        }\n        const { mm, map } = this.props;\n        const rwy = map.nodes[rwyId];\n        if (!isRunway(rwy)) {\n            throw new Error('not a runway');\n        }\n        return mapDao.radial(rwy, rwy.hdg + 180, mm);\n    }\n\n    /**\n     * Returns the distance to runway via om in nms\n     * @param rwyId \n     */\n    approachDistance(rwyId?: string) {\n        return mapDao.distance(this.flight, this.outerMarker(rwyId)) + this.props.om;\n    }\n\n    /**\n     * Returns the distance to runway via om in nms\n     * @param rwyId \n     */\n    approachAlt(rwyId?: string): number {\n        return this.landingAlt(this.approachDistance(rwyId));\n    }\n\n    /**\n     * Returns the maximum approach altitude in feet\n     * Computed as the altutude at outermarker plus the altutude of maximum rate od descent\n     * from the outermarker and the current position\n     */\n    maxApproachAlt(rwyId?: string): number {\n        const d = mapDao.distance(this.outerMarker(rwyId), this.flight);\n        const da = this.vspeed() * d * 60 / this.flight.speed;\n        return Math.round(da + this.outerMarkerAlt());\n    }\n\n    /**\n     * \n     * @param msg \n     */\n    addMessage(msg: Message | Message[]): FlightProcessor {\n        const messages = _.concat(this.messages, msg);\n        return this.withMessages(messages);\n    }\n\n    /**\n     * Returns the Flight with a flight data\n     * @param flight flight data\n     */\n    withFlight(flight: Flight): FlightProcessor {\n        const invalid = _(VALIDATION_PROPS).find(key => {\n            const value = (flight as any)[key];\n            return (!value && value !== 0);\n        });\n        if (!!invalid) {\n            console.trace('Flight with', invalid, 'invalid', flight);\n        }\n        const result = !invalid ? new FlightProcessor(flight, this.props, this.messages) : this;\n        return result;\n    }\n\n    /**\n     * \n     * @param messages \n     */\n    withMessages(messages: Message[]): FlightProcessor {\n        return new FlightProcessor(this.flight, this.props, messages);\n    }\n\n    /**\n     * Returns the flight with modifier applied\n     * @param modifiers \n     */\n    apply(...modifiers: Modifier[]): FlightProcessor {\n        const flightMap = fromJS(this.flight);\n        const flight1 = _.reduce(modifiers, (flight, modifier) => modifier(flight), flightMap).toJS();\n        return this.withFlight(flight1);\n    }\n\n    /** */\n    nextPos(): GeoLocation {\n        const { speed, hdg } = this.flight;\n        const { dt } = this.props;\n\n        // Compute new position\n        const ds = dt * speed / SECS_PER_HOUR;\n        return mapDao.radial(this.flight, hdg, ds);\n    }\n\n    /**\n     * \n     * @param to the node\n     */\n    turnedTo(to: GeoLocation): FlightProcessor {\n        const { dt } = this.props;\n        const maxAngle = dt * TURNING_SPEED;\n        const { angle } = mapDao.route(this.flight, to);\n        const da = Math.abs(angle) <= maxAngle ? angle : Math.sign(angle) * maxAngle;\n        const newHdg = mapDao.normHdg(this.flight.hdg + da);\n        return this.apply(setMod('hdg', newHdg));\n    }\n\n    /**\n     * Returns the flight moved to checkpoint\n     * @param cpt the checkpoint\n     * @param onPassing the transformation callback on checkpoint passing\n     */\n    flyTo(cpt: GeoLocation, onPassing: (arg: FlightProcessor) => FlightProcessor): FlightProcessor {\n        const { dt } = this.props;\n        const flight = this.flight;\n        const { speed } = flight;\n        // compute heading\n        const d = mapDao.distance(flight, cpt);\n        const ds = speed * dt / SECS_PER_HOUR;\n        const newFlight = this\n            .turnedTo(cpt)\n            .moveHoriz()\n            .moveVert();\n        return ds >= d ? onPassing(newFlight) : newFlight;\n    }\n\n    /** */\n    approachJunction(): Junction {\n        const { speed, rwy } = this.flight;\n        if (!rwy) {\n            throw new Error('missing runway');\n        }\n\n        const om = this.outerMarker();\n        const r = speed * RADIUS_PER_KNOTS;\n        const rwyNode = this.props.map.nodes[rwy];\n        if (!isRunway(rwyNode)) {\n            throw new Error('not a runway');\n        }\n        const rwyHdg = rwyNode.hdg;\n        const pLPnt = mapDao.radial(om, rwyHdg - 90, r);\n        const pRPnt = mapDao.radial(om, rwyHdg + 90, r);\n        const dL = mapDao.distance(pLPnt, this.flight);\n        const dR = mapDao.distance(pRPnt, this.flight);\n\n        if (dR <= dL) {\n            // right approach\n            const sigma1 = mapDao.hdg(pRPnt, this.flight);\n            const sigma = mapDao.normHdg(Math.round(sigma1 - Math.asin(r / dR) / RADS_PER_DEG));\n            const entry = mapDao.radial(pRPnt, sigma - 90, r);\n            return { entry, sigma, pivot: pRPnt, right: true };\n        } else {\n            // left approach\n            const sigma1 = mapDao.hdg(pLPnt, this.flight);\n            const sigma = mapDao.normHdg(Math.round(sigma1 + Math.asin(r / dL) / RADS_PER_DEG));\n            const entry = mapDao.radial(pLPnt, sigma + 90, r);\n            return { entry, sigma, pivot: pLPnt, right: false };\n        }\n    }\n\n    /**\n     * \n     * @param alt \n     */\n    speedByAlt(alt: number): number {\n        return speedByAlt(alt, this.props.flightTempl[this.flight.type]);\n    }\n\n    /**\n     * Returns the flight with hdg turn right to hdg\n     * @param toHdg the target heading\n     */\n    turnedRight(toHdg: number): FlightProcessor {\n        const { dt } = this.props;\n        const { hdg } = this.flight;\n        const angle = (toHdg >= hdg) ? toHdg - hdg : 360 + toHdg - hdg;\n        const maxAngle = dt * TURNING_SPEED;\n        const da = angle <= maxAngle ? angle : maxAngle;\n        const newHdg = mapDao.normHdg(this.flight.hdg + da);\n        return this.apply(setMod('hdg', newHdg));\n    }\n\n    /**\n     * Returns the flight with hdg turn left to checkpoint\n     * @param pivot the checkpoint\n     */\n    turnedRightTo(pivot: GeoLocation): FlightProcessor {\n        const { dt } = this.props;\n        const { hdg } = this.flight;\n        const toHdg = mapDao.hdg(pivot, this.flight);\n        const angle = (toHdg >= hdg) ? toHdg - hdg : 360 + toHdg - hdg;\n        const maxAngle = dt * TURNING_SPEED;\n        const da = angle <= maxAngle ? angle : maxAngle;\n        const newHdg = mapDao.normHdg(this.flight.hdg + da);\n        return this.apply(setMod('hdg', newHdg));\n    }\n\n    /**\n     * Returns the flight with hdg turn left to checkpoint\n     * @param pivot the checkpoint\n     */\n    turnedLeftTo(pivot: GeoLocation): FlightProcessor {\n        const { dt } = this.props;\n        const { hdg } = this.flight;\n        const toHdg = mapDao.hdg(pivot, this.flight);\n        const angle = (hdg >= toHdg) ? hdg - toHdg : 360 + hdg - toHdg;\n        const maxAngle = dt * TURNING_SPEED;\n        const da = angle <= maxAngle ? angle : maxAngle;\n        const newHdg = mapDao.normHdg(this.flight.hdg - da);\n        return this.apply(setMod('hdg', newHdg));\n    }\n\n    /**\n     * Returns the flight in the outbound track\n     * @param onPassing the transformaton on passing the outbound end\n     */\n    outboundTrack(onPassing: (arg: FlightProcessor) => FlightProcessor): FlightProcessor {\n        const { dt } = this.props;\n        const flight = this.flight;\n        const { holdHdg, loopTimer } = flight;\n        if (!holdHdg) {\n            throw new Error('missing hold heading');\n        }\n        const newFlight = this.apply(updateMod<number>('loopTimer', lp => lp - dt))\n            .turnedRight(holdHdg)\n            .moveHoriz()\n            .moveVert();\n        return (!loopTimer || loopTimer <= 0) ? onPassing(newFlight) : newFlight;\n    }\n\n    /** */\n    moveHoriz(): FlightProcessor {\n        // Compute new position\n        return this.apply(setLocationMod(this.nextPos()));\n    }\n\n    /** */\n    moveVert(): FlightProcessor {\n        const flight = this.flight;\n        const { alt, toAlt } = flight;\n        const { dt } = this.props;\n\n        // Compute new altitude\n        const vspeed = this.vspeed();\n        const newAlt = alt < toAlt\n            ? Math.min(toAlt, Math.round(alt + vspeed * dt * MINS_PER_SEC))\n            : alt > toAlt\n                ? Math.max(toAlt, Math.round(alt - vspeed * dt * MINS_PER_SEC))\n                : alt;\n        const newSpeed = this.speedByAlt(newAlt);\n        const result = this.apply(\n            setMod('alt', newAlt),\n            setMod('speed', newSpeed));\n\n        return (toAlt !== alt && newAlt === toAlt)\n            ? result.addPassingFlightLevelDialog()\n            : result;\n    }\n\n    /** */\n    approachVert(): FlightProcessor {\n        // Compute new altitude\n        const { alt } = this.flight;\n        const minAlt = Math.round(alt - this.vspeed() * this.props.dt * MINS_PER_SEC);\n        const newAlt = Math.min(alt, Math.max(minAlt, this.approachAlt()));\n        const newSpeed = this.speedByAlt(newAlt);\n        return this.apply(\n            setMod('alt', newAlt),\n            setMod('speed', newSpeed));\n    }\n\n    /** */\n    landVert(): FlightProcessor {\n        // Compute new altitude\n        const { alt } = this.flight;\n        const minAlt = Math.round(alt - this.vspeed() * this.props.dt * MINS_PER_SEC);\n        const newAlt = Math.min(alt, Math.max(minAlt, this.landingAlt()));\n        const newSpeed = this.speedByAlt(newAlt);\n        return this.apply(\n            setMod('alt', newAlt),\n            setMod('speed', newSpeed));\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processCommand(cmd: CommandMessage): FlightProcessor {\n        switch (cmd.cmd) {\n            case Command.Climb:\n                return this.processClimbCommand(cmd as FlightLevelCommandMessage);\n            case Command.Descend:\n                return this.processDescendCommand(cmd as FlightLevelCommandMessage);\n            case Command.Maintain:\n                return this.processMaintainCommand(cmd as FlightLevelCommandMessage);\n            case Command.ClearedToTakeoff:\n                return this.processTakeoffCommand(cmd as TakeoffCommandMessage);\n            case Command.FlyTo:\n            case Command.FlyToVia:\n                return this.processFlyToCommand(cmd as FlyToCommandMessage);\n            case Command.ClearedToLand:\n                return this.processClearedToLandCommand(cmd as LandCommandMessage);\n            case Command.HoldCurrentPosition:\n            case Command.HoldAt:\n                return this.processHoldCommand(cmd as HoldAtCommandMessage);\n            default:\n                return this;\n        }\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processHoldCommand(cmd: HoldAtCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { at } = cmd;\n        if (at && !this.props.map.nodes[at]) {\n            return this.addMessage(\n                buildBeaconNotFoundMessage(this.flight.id, this.props.map.id, at)\n            );\n        }\n        const { status, hdg, lat, lon } = this.flight;\n        const { map, holdingDuration } = this.props;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        if (!at) {\n            const fix: GeoLocation = { lat, lon };\n            return this.apply(\n                setMod('status', FlightStatus.HoldingFrom),\n                setMod('loopTimer', holdingDuration / 2),\n                setMod('holdHdg', mapDao.normHdg(hdg + 180)),\n                setMod('fix', fix))\n                .addMessage(buildReadbackMessage(cmd));\n        } else {\n            const atNode = map.nodes[at];\n            const hdg = mapDao.hdg(atNode, this.flight);\n            const result = this.apply(\n                setMod('status', FlightStatus.HoldingToAt),\n                setMod('holdHdg', mapDao.normHdg(hdg + 180)),\n                setMod('at', at))\n                .addMessage(buildReadbackMessage(cmd));\n            return result;\n        }\n    }\n\n    /**\n     * \n     * @param {*} cmd \n     */\n    processClearedToLandCommand(cmd: LandCommandMessage) {\n        const invalid = this.validateATC(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { rwy } = cmd;\n        if (!this.props.map.nodes[rwy]) {\n            return this.addMessage(\n                buildRunwayNotFoundMessage(this.flight.id, this.props.map.id, rwy)\n            );\n        }\n        const { alt, status } = this.flight;\n        const { clearToLandDistance } = this.props;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        if (this.approachDistance(rwy) > clearToLandDistance) {\n            return this.addMessage(\n                buildTooDistanthMessage(this.flight.id, this.props.map.id)\n            );\n        }\n        if (alt > this.maxApproachAlt(rwy)) {\n            // Flight to high\n            return this.addMessage(\n                buildTooHighMessage(this.flight.id, this.props.map.id)\n            );\n        }\n        // Cleared to land\n        const result = this.apply(\n            setMod('rwy', rwy),\n            setMod('status', FlightStatus.Approaching),\n            deleteMod('turnTo'),\n            deleteMod('at'))\n            .addMessage(buildReadbackMessage(cmd));\n        return result;\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processFlyToCommand(cmd: FlyToCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { via, turnTo } = cmd;\n        if (!this.props.map.nodes[turnTo]) {\n            return this.addMessage(\n                buildBeaconNotFoundMessage(this.flight.id, this.props.map.id, turnTo)\n            );\n        }\n        if (via && !this.props.map.nodes[via]) {\n            return this.addMessage(\n                buildBeaconNotFoundMessage(this.flight.id, this.props.map.id, via)\n            );\n        }\n        const { status } = this.flight;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        const f1 = !via\n            ? this.apply(\n                setMod('at', turnTo),\n                setMod('status', FlightStatus.FlyingTo),\n                deleteMod('turnTo'))\n            : this.apply(\n                setMod('at', via),\n                setMod('status', FlightStatus.Turning),\n                setMod('turnTo', turnTo));\n        const result = f1.apply(deleteMod('rwy'))\n            .addMessage(\n                buildReadbackMessage(cmd)\n            );\n        return result;\n    }\n\n    /**\n     * \n     * @param {*} cmd \n     */\n    validateATC(cmd: CommandMessage): FlightProcessor | undefined {\n        const { from } = cmd;\n        if (!from) {\n            throw new Error('missing atc id');\n        }\n        if (from !== this.props.map.id) {\n            // Invalid ATC\n            return this.addMessage(\n                buildATCNotFoundMessage(this.flight.id, from)\n            );\n        }\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    validateFlightLevelCommand(cmd: FlightLevelCommandMessage): FlightProcessor | undefined {\n        const { flightLevel } = cmd;\n        const toAlt = parseInt(flightLevel) * 100;\n        if (toAlt < MIN_ALTITUDE\n            || toAlt > MAX_ALTITUDE\n            || (toAlt % ALTITUDE_SEPARATION)) {\n            // Invalid flight level\n            return this.addMessage(\n                buildInvalidFlightLevelMessage(this.flight.id, this.props.map.id, flightLevel)\n            );\n        }\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processClimbCommand(cmd: FlightLevelCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd) || this.validateFlightLevelCommand(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { flightLevel } = cmd;\n        const cmdAlt = parseInt(flightLevel) * 100;\n        const { alt, status } = this.flight;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        if (alt >= cmdAlt) {\n            return this.addMessage(\n                buildInvalidFlightLevelMessage(this.flight.id, this.props.map.id, flightLevel)\n            );\n        }\n        const newFLight = (status === FlightStatus.Landing || status === FlightStatus.Approaching || status === FlightStatus.Aligning)\n            ? this.apply(\n                setMod('toAlt', cmdAlt),\n                setMod('status', FlightStatus.Flying),\n                deleteMod('rwy')\n            )\n            : this.apply(setMod('toAlt', cmdAlt));\n        return newFLight.addMessage(\n            buildReadbackMessage(cmd)\n        );\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processDescendCommand(cmd: FlightLevelCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd) || this.validateFlightLevelCommand(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { flightLevel } = cmd;\n        const cmdAlt = parseInt(flightLevel) * 100;\n        const { alt, status } = this.flight;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        if (alt <= cmdAlt) {\n            return this.addMessage(\n                buildInvalidFlightLevelMessage(this.flight.id, this.props.map.id,flightLevel)\n            );\n        }\n        const newFLight = (status === FlightStatus.Landing || status === FlightStatus.Approaching || status === FlightStatus.Aligning)\n            ? this.apply(\n                setMod('toAlt', cmdAlt),\n                setMod('status', FlightStatus.Flying),\n                deleteMod('rwy')\n            )\n            : this.apply(setMod('toAlt', cmdAlt));\n        return newFLight.addMessage(\n            buildReadbackMessage(cmd)\n        );\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processMaintainCommand(cmd: FlightLevelCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd) || this.validateFlightLevelCommand(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { flightLevel } = cmd;\n        const cmdAlt = parseInt(flightLevel) * 100;\n        const { alt, status } = this.flight;\n        if (status === FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildAtGroundMessage(this.flight.id, this.props.map.id, this.flight.from)\n            );\n        }\n        if (alt !== cmdAlt) {\n            return this.addMessage(\n                buildInvalidFlightLevelMessage(this.flight.id, this.props.map.id,flightLevel)\n            );\n        }\n        const newFLight = (status === FlightStatus.Landing || status === FlightStatus.Approaching || status === FlightStatus.Aligning)\n            ? this.apply(\n                setMod('toAlt', cmdAlt),\n                setMod('status', FlightStatus.Flying),\n                deleteMod('rwy')\n            )\n            : this.apply(setMod('toAlt', cmdAlt));\n        return newFLight.addMessage(\n            buildReadbackMessage(cmd)\n        );\n    }\n\n    /**\n     * \n     * @param {*} cmd \n     */\n    processTakeoffCommand(cmd: TakeoffCommandMessage): FlightProcessor {\n        const invalid = this.validateATC(cmd) || this.validateFlightLevelCommand(cmd);\n        if (invalid) {\n            return invalid;\n        }\n        const { flightLevel, rwy } = cmd;\n        const cmdAlt = parseInt(flightLevel) * 100;\n        const { status, from: flightRwy } = this.flight;\n        if (status !== FlightStatus.WaitingForTakeoff) {\n            return this.addMessage(\n                buildNotAtGroundMessage(this.flight.id, this.props.map.id, rwy)\n            );\n        }\n        if (rwy !== flightRwy) {\n            return this.addMessage(\n                buildInvalidRunwayMessage(this.flight.id, this.props.map.id, rwy)\n            );\n        }\n        return this.apply(\n            setMod('toAlt', cmdAlt),\n            setMod('status', FlightStatus.Flying),\n            deleteMod('rwy'))\n            .addMessage(\n                buildReadbackMessage(cmd)\n            );\n    }\n\n    /** Returns the flight status after time elapsed */\n    processTime(): FlightProcessor {\n        return this.processTimePhase1().processExit();\n    }\n\n    /** */\n    private processTimePhase1(): FlightProcessor {\n        switch (this.flight.status) {\n            case FlightStatus.FlyingTo:\n                return this.processTimeFlyingTo();\n            case FlightStatus.Flying:\n                return this.processTimeFlying();\n            case FlightStatus.Turning:\n                return this.processTimeTurning();\n            case FlightStatus.Approaching:\n                return this.processTimeApproaching();\n            case FlightStatus.Aligning:\n                return this.processTimeAligning();\n            case FlightStatus.Landing:\n                return this.processTimeLanding();\n            case FlightStatus.HoldingFrom:\n                return this.processTimeHoldingFrom();\n            case FlightStatus.HoldingTo:\n                return this.processTimeHoldingTo();\n            case FlightStatus.HoldingFromAt:\n                return this.processTimeHoldingFromNode();\n            case FlightStatus.HoldingToAt:\n                return this.processTimeHoldingToNode();\n            default:\n                return this;\n        }\n    }\n\n    /** */\n    processTimeHoldingFromNode(): FlightProcessor {\n        const flight = this.flight;\n        return this.outboundTrack(fl => {\n            const hdg1 = mapDao.normHdg(flight.hdg + fl.props.dt * TURNING_SPEED);\n            return fl.apply(\n                setMod('status', FlightStatus.HoldingToAt),\n                setMod('hdg', hdg1))\n                .moveHoriz()\n                .moveVert();\n        });\n    }\n\n    /** */\n    processTimeHoldingToNode(): FlightProcessor {\n        const { at } = this.flight;\n        if (!at) {\n            throw new Error('missing at');\n        }\n        return this.flyTo(this.props.map.nodes[at], fl =>\n            fl.apply(\n                setMod('status', FlightStatus.HoldingFromAt),\n                setMod('loopTimer', fl.props.holdingDuration / 2)\n            )\n        );\n    }\n\n    /** */\n    processTimeHoldingFrom(): FlightProcessor {\n        const flight = this.flight;\n        return this.outboundTrack(fl => {\n            const hdg1 = mapDao.normHdg(flight.hdg + fl.props.dt * TURNING_SPEED);\n            return this.apply(\n                setMod('status', FlightStatus.HoldingTo),\n                setMod('hdg', hdg1))\n                .moveHoriz()\n                .moveVert();\n        });\n    }\n\n    /** */\n    processTimeHoldingTo(): FlightProcessor {\n        const { fix } = this.flight;\n        if (!fix) {\n            throw new Error('missing fix');\n        }\n        return this.flyTo(fix, fl => {\n            return fl.apply(\n                setMod('status', FlightStatus.HoldingFrom),\n                setMod('loopTimer', fl.props.holdingDuration / 2)\n            );\n        });\n    }\n\n    /** */\n    processExit(): FlightProcessor {\n        const { map, dt } = this.props;\n        const flight = this.flight;\n        const ds = flight.speed * dt / SECS_PER_HOUR;\n        const exitNode = _.findKey(map.nodes, node => {\n            if (!isEntryNode(node)) {\n                return false;\n            }\n            const nodeHdg = node.hdg;\n            const diff = mapDao.normAngle(flight.hdg - nodeHdg);\n            if (Math.abs(diff) <= 90) {\n                return false;\n            }\n            const { from, d } = mapDao.route(flight, node);\n            return from && d <= ds && Math.abs(diff);\n        });\n        if (!!exitNode) {\n            return this.apply(\n                setMod('exit', exitNode),\n                setMod('status', FlightStatus.Exited)\n            );\n        } else {\n            return this;\n        }\n    }\n\n    /**\n     * \n     */\n    processTimeApproaching(): FlightProcessor {\n        const { dt, map } = this.props;\n        const { hdg, speed, rwy } = this.flight;\n        if (!rwy) {\n            throw new Error('missing runway');\n        }\n        const rwyNode = map.nodes[rwy];\n        if (!isRunway(rwyNode)) {\n            throw new Error('not a runway');\n        }\n        const rwyHdg = rwyNode.hdg;\n\n        const { entry: c, pivot: p, right } = this.approachJunction();\n        const r = speed * RADIUS_PER_KNOTS;\n        const maxTurn = dt * TURNING_SPEED;\n        const d = mapDao.distance(this.flight, p);\n        const { angle, d: dc } = mapDao.route(this.flight, c);\n        const angle1 = mapDao.normAngle(hdg - rwyHdg);\n        if (d <= r - 0.1) {\n            // Missing approach cause distance from pivot turn\n            console.error('Missing approach cause distance from pivot turn', this.flight);\n            console.error('d', d, 'r', r);\n            return this.apply(\n                setMod('toAlt', this.props.goAroundAlt),\n                setMod('status', FlightStatus.Flying),\n                deleteMod('rwy'))\n                .moveHoriz()\n                .moveVert()\n                .addMissingApproachDialog();\n        }\n        if (Math.abs(angle) > maxTurn && d <= 2 * r) {\n            // Missing approach cause turn angle and pivot distance\n            console.error('Missing approach turn angle and pivot distance', this.flight);\n            console.error('d', d,\n                'r', r,\n                'angle', angle,\n                'maxTurn', maxTurn,\n                'r', r);\n            return this.apply(\n                setMod('toAlt', this.props.goAroundAlt),\n                setMod('status', FlightStatus.Flying),\n                deleteMod('rwy'))\n                .moveHoriz()\n                .moveVert()\n                .addMissingApproachDialog();\n        }\n        const dd = speed * dt / SECS_PER_HOUR;\n        if (dd < dc) {\n            // flew length < junction checkpoint distance (not reached)\n            // Turn to C \n            return this.turnedTo(c).moveHoriz().approachVert();\n        } else if (Math.abs(angle1) > maxTurn) {\n            // Start turn to om\n            const f1 = this.apply(\n                setMod('status', FlightStatus.Aligning),\n                setMod('right', right));\n            const f2 = (right) ? f1.turnedRightTo(f1.outerMarker()) : f1.turnedLeftTo(f1.outerMarker());\n            return f2.moveHoriz().approachVert();\n        } else {\n            // Turn to runway and land\n            return this.apply(\n                setMod('status', FlightStatus.Landing))\n                .turnedTo(c)\n                .moveHoriz()\n                .approachVert();\n        }\n    }\n\n    /** */\n    processTimeAligning(): FlightProcessor {\n        const { right, rwy, hdg } = this.flight;\n        if (!rwy) {\n            throw new Error('missing runway');\n        }\n        const { map, dt } = this.props;\n        const rwyNode = map.nodes[rwy];\n        if (!isRunway(rwyNode)) {\n            throw new Error('not a runway');\n        }\n        const rwyHdg = rwyNode.hdg;\n        const da = mapDao.normAngle(rwyHdg - hdg);\n        const maxAngle = dt * TURNING_SPEED;\n        if (Math.abs(da) <= maxAngle) {\n            // turn completed\n            return this.apply(\n                deleteMod('right'),\n                setMod('status', FlightStatus.Landing),\n                setMod('hdg', rwyHdg))\n                .moveHoriz()\n                .landVert();\n        } else if (right) {\n            return this.turnedRightTo(this.outerMarker())\n                .moveHoriz()\n                .landVert();\n        } else {\n            return this.turnedLeftTo(this.outerMarker())\n                .moveHoriz()\n                .landVert();\n        }\n    }\n\n    /** */\n    processTimeLanding(): FlightProcessor {\n        const flight = this.flight;\n        const { speed, rwy, type, alt, hdg } = flight;\n        if (!rwy) {\n            throw new Error('missing runway');\n        }\n        const { dt, map, landingHdgRange, flightTempl, goAroundAlt, mm } = this.props;\n        const runwayNode = map.nodes[rwy];\n        if (!isRunway(runwayNode)) {\n            throw new Error('not a runway');\n        }\n        const rwyHdg = runwayNode.hdg;\n        const { from, d, angle } = mapDao.route(flight, runwayNode);\n        const ds = speed * dt / SECS_PER_HOUR;\n        if (from) {\n            // Go around due to missing runway cause flying away\n            console.error('Missing runway direction from', this.flight);\n            return this.apply(\n                setMod('status', FlightStatus.Flying),\n                setMod('toAlt', goAroundAlt),\n                deleteMod('rwy'))\n                .moveHoriz()\n                .moveVert()\n                .addMissingRunwayDialog();\n        }\n        if (ds > d) {\n            // flying distance > runway distance: touching\n            if (Math.abs(mapDao.normAngle(hdg - rwyHdg)) > landingHdgRange) {\n                // difference between flight heading and runway heading > landing range\n                // Go around due to missing runway cause land alignment\n                console.error('Missing runway land alignment', this.flight);\n                return this.apply(\n                    setMod('status', FlightStatus.Flying),\n                    setMod('toAlt', goAroundAlt),\n                    deleteMod('rwy'))\n                    .moveHoriz()\n                    .moveVert()\n                    .addMissingRunwayDialog();\n            }\n            // Landed\n            return this.apply(\n                setLocationMod(runwayNode),\n                setMod('speed', 0),\n                setMod('alt', 0),\n                setMod('status', FlightStatus.Landed))\n        }\n\n        // Compute shifting\n        const shifting = d * Math.sin(angle * RADS_PER_DEG);\n\n        if (Math.abs(shifting) >= ds) {\n            if (d < mm) {\n                // Missing runway too shifted\n                console.error('Missing runway too shifted', this.flight);\n                return this.apply(\n                    setMod('status', FlightStatus.Flying),\n                    setMod('toAlt', goAroundAlt),\n                    deleteMod('rwy'))\n                    .moveHoriz()\n                    .moveVert()\n                    .addMissingRunwayDialog();\n            }\n            // fly to midle marker\n            return this.turnedTo(this.midleMarker())\n                .moveHoriz()\n                .landVert();\n        }\n\n        // Compute forward point\n        const df = Math.sqrt(ds * ds - shifting * shifting);\n        const fPts = mapDao.radial(runwayNode, rwyHdg + 180, d - df);\n\n        // Compute altitude\n        const apprAlt = this.landingAlt(d - ds);\n        const { vspeed } = flightTempl[type];\n        const minAlt = Math.round(alt - vspeed * dt * MINS_PER_SEC);\n        if (apprAlt < minAlt) {\n            // Go around cause altitude\n            console.error('Missing runway alitude', this.flight);\n            return this.apply(\n                setMod('status', FlightStatus.Flying),\n                setMod('toAlt', goAroundAlt),\n                deleteMod('rwy'))\n                .addMissingRunwayDialog()\n                .moveHoriz()\n                .moveVert();\n        }\n\n        return this.turnedTo(fPts).moveHoriz()\n            .landVert();\n    }\n\n    /**\n     * \n     */\n    processTimeTurning(): FlightProcessor {\n        const { map } = this.props;\n        const { turnTo, at } = this.flight;\n        if (!at) {\n            throw new Error('missing at');\n        }\n        return this.flyTo(map.nodes[at], fl =>\n            fl.apply(\n                setMod('status', FlightStatus.FlyingTo),\n                setMod('at', turnTo),\n                deleteMod('turnTo'))\n                .addFlyingToDialog()\n        );\n    }\n\n    /**\n     * \n     */\n    processTimeFlying(): FlightProcessor {\n        return this.moveHoriz().moveVert();\n    }\n\n    /**\n     * \n     */\n    processTimeFlyingTo(): FlightProcessor {\n        const { at } = this.flight;\n        if (!at) {\n            throw new Error('missing at property');\n        }\n        const atNode = this.props.map.nodes[at];\n        return this.flyTo(atNode, fl =>\n            fl.apply(\n                deleteMod('at'),\n                setMod('status', FlightStatus.Flying)\n            )\n        );\n    }\n}\n","import { fromJS, Set } from 'immutable';\nimport _ from 'lodash';\nimport { Flight, FlightStatus, FlightType } from './Flight';\nimport { FlightProcessor, FlightTemplate, SimulationOptions, SimulationProps } from './FlightProcessor';\nimport { HeadingMapNode, isRunway, MapNode, MapNodeType } from './Map';\nimport { mapDao } from './MapDao';\nimport {\n    buildClearedToLeaveMessage,\n    buildCollisionMessage,\n    buildDepartureLeaveMessage,\n    buildDepartureToMessage, buildEnterLeaveMessage, buildEnterToMessage, buildFlightNotFoundMessage, buildGoodDayMessage, buildHoldShortCommand, buildLeavingMessage, buildLeavingMissingDepartureMessage, buildOutOfAreaMessage,\n    buildReadbackMessage,\n    buildRogerMessage, buildRunwayVacated, buildWrongRunwayVacated, CommandMessage,\n    Message\n} from './Message';\nimport { Session } from './Session';\n\nconst MAX_INITIAL_IDLE_INTERVAL = 20;\n\nexport const DefaultSimProps: SimulationOptions = Object.freeze({\n    dt: 1,                      // sec\n    jetProb: 0.5,\n    safeEntryDelay: 120,        // sec\n    entryAlt: 28000,            // feet\n    exitAlt: 36000,             // feet\n    collisionDistance: 4,       // nms\n    collisionAlt: 1000,         // feet\n    om: 7,                      // nms\n    mm: 0.9,                    // nms (5469')\n    clearToLandDistance: 30,    // nms\n    exitDistance: 2,            // nms\n    landingHdgRange: 2,         // DEG\n    landingAngle: 3,            // DEG\n    conditionDistance: 400 / 3600 * 10 * 1.5, // nms\n    holdingDuration: 240,       // sec\n    goAroundAlt: 4000,          // feet\n    flightTempl: {\n        J: {\n            speed0: 140,        // nmh\n            speed360: 440,      // nmh\n            vspeed: 1500        // fpm\n        },\n        A: {\n            speed0: 80,         // nmh\n            speed360: 280,      // nmh\n            vspeed: 700         // fpm\n        }\n    },\n    flightVoices: []\n});\n\n// Descend speed 1500 feet/min = 25 feet/s\n// Descend speed 700 feet/min = 12 feet/s\n// Descent speed for landing slope from FL040 at 173 Knots = 173/60/1852*0.3*tan(3DEG) = 932 feet/min = 15 feet/s\n// Descent speed for landing slope from FL040 at 102 Knots = 80/60/1852*0.3*tan(3DEG) = 431 feet/min = 7 feet/s\n\n/**\n * \n * @param tmpl \n */\nfunction rndFlightId(tmpl: string = 'X99X'): string {\n    const id = _.map(tmpl, mode =>\n        (mode === 'X')\n            ? String.fromCharCode(65 + Math.floor(Math.random() * 26))\n            : String.fromCharCode(48 + Math.floor(Math.random() * 10))\n    ).join('');\n    return id;\n}\n\n/**\n * \n * @param lambda \n */\nfunction rndPoisson(lambda: number): number {\n    var k = -1;\n    var p = 1;\n    var l = Math.exp(-lambda);\n    do {\n        ++k;\n        p *= Math.random();\n    } while (p > l);\n    return k;\n}\n\n/**\n * \n * @param alt \n * @param template \n */\nfunction flightSpeed(alt: number, template: FlightTemplate): number {\n    return Math.round(alt / 36000 * (template.speed360 - template.speed0) + template.speed0);\n}\n\n/**\n * \n * @param items \n */\nexport function choose<T>(items: T[]): T {\n    return items.length <= 1 ? items[0] : items[rndInt(items.length)];\n}\n\n/**\n * \n * @param prob \n */\nfunction rndByProb(prob: number): boolean {\n    return Math.random() < prob;\n}\n\n/**\n * \n * @param n \n */\nfunction rndInt(n: number): number {\n    return Math.floor(Math.random() * n);\n}\n\n/**\n * \n * @param session \n * @param props \n */\nexport function buildSimulator(session: Session, props: any): TrafficSimulator {\n    return new TrafficSimulator(session, _.assign({}, DefaultSimProps, props) as SimulationProps);\n}\n\n/** */\nclass TrafficSimulator {\n    private _props: SimulationProps;\n    private _session: Session;\n    private _messages: Message[];\n\n    /**\n     * \n     * @param session \n     * @param props \n     * @param messages \n     */\n    constructor(session: Session, props: SimulationProps, messages: Message[] = []) {\n        this._props = props;\n        this._session = session;\n        this._messages = messages;\n        _.bindAll(this);\n    }\n\n    get props() { return this._props; }\n\n    /** Returns the session */\n    get session() { return this._session; }\n\n    /** Returns the messages */\n    get messages() { return this._messages; }\n\n    /** */\n    get map() { return this.props.map; }\n\n    /**\n     * \n     * @param session \n     */\n    withSession(session: Session) {\n        return new TrafficSimulator(session, this.props, this.messages);\n    }\n\n    /**\n     * \n     * @param messages \n     */\n    withMessages(messages: Message[]) {\n        return new TrafficSimulator(this.session, this.props, messages);\n    }\n\n    /**\n     * \n     * @param messages \n     */\n    addMessages(messages: Message | Message[]) {\n        return this.withMessages(_.concat(this.messages, messages));\n    }\n\n    /**\n     * \n     * @param flight \n     */\n    addDepartureToDialog(flight: Flight): TrafficSimulator {\n        const holdShort = buildHoldShortCommand(flight.id, this.map.id, flight.from);\n        return this.addMessages([\n            buildDepartureToMessage(flight, this.map.id),\n            holdShort,\n            buildReadbackMessage(holdShort)\n        ]);\n    }\n\n    /**\n     * \n     * @param flight \n     */\n    addDepartureLeaveDialog(flight: Flight): TrafficSimulator {\n        const holdShort = buildHoldShortCommand(flight.id, this.map.id, flight.from);\n        return this.addMessages([\n            buildDepartureLeaveMessage(flight, this.map.id),\n            holdShort,\n            buildReadbackMessage(holdShort)\n        ]);\n    }\n\n    /**\n     * \n     * @param flight \n     */\n    addEnterToDialog(flight: Flight): TrafficSimulator {\n        return this.addMessages([\n            buildEnterToMessage(flight, this.map.id),\n            buildRogerMessage(this.map.id, flight.id)\n        ]);\n    }\n\n    /**\n     * \n     * @param flight \n     */\n    addEnterLeaveDialog(flight: Flight): TrafficSimulator {\n        return this.addMessages([\n            buildEnterLeaveMessage(flight, this.map.id),\n            buildRogerMessage(this.map.id, flight.id)\n        ]);\n    }\n\n    /**\n     * \n     * @param cmd \n     */\n    processCommand(cmd: CommandMessage): TrafficSimulator {\n        const { to: flightId } = cmd;\n        if (!flightId) {\n            throw new Error('missing flight id');\n        }\n        const flight = this.session.flights[flightId];\n        if (!flight) {\n            return this.addMessages([\n                buildFlightNotFoundMessage(this.props.map.id, flightId)\n            ]);\n        }\n        const fp = new FlightProcessor(flight, this.props).processCommand(cmd);\n        const newSession = fromJS(this.session).setIn(['flights', flightId], fp.flight).toJS();\n        return this.withSession(newSession).addMessages(fp.messages);\n    }\n\n    /**\n     * \n     */\n    transition(): TrafficSimulator {\n        return this.processFlights()\n            .filterForLanded()\n            .filterForOutOfArea()\n            .filterForExited()\n            .filterCollision()\n            .processForNewFlight()\n            .addTime();\n    }\n\n    /**\n     * \n     */\n    filterCollision(): TrafficSimulator {\n        const { collisionAlt, collisionDistance } = this.props;\n        const { flights } = this.session;\n        const flightsAry = _.values(flights);\n        var collision = Set.of();\n        for (var i = 0; i < flightsAry.length; i++) {\n            for (var j = i + 1; j < flightsAry.length; j++) {\n                const a = flightsAry[i];\n                const b = flightsAry[j];\n                const ds = mapDao.distance(a, b);\n                const da = Math.abs(a.alt - b.alt)\n                const collided = a.status !== FlightStatus.WaitingForTakeoff\n                    && b.status !== FlightStatus.WaitingForTakeoff\n                    && da <= collisionAlt\n                    && ds <= collisionDistance;\n                if (collided) {\n                    collision = collision.add(a.id).add(b.id)\n                }\n            }\n        }\n\n        const [collided, notCollided] = _.partition(flights, f => collision.has(f.id));\n        const noCollided = collided.length;\n        if (noCollided > 0) {\n            const notCollidedMap = _(notCollided)\n                .groupBy('id')\n                .mapValues(f => f[0])\n                .value();\n            const newSession = fromJS(this.session)\n                .set('flights', notCollidedMap)\n                .update('noCollision', (n: number) => n + noCollided)\n                .toJS();\n            // Sending message\n            const messages = collided.map(f => buildCollisionMessage(f.id, this.props.map.id));\n            return this.withSession(newSession).addMessages(messages);\n        }\n        return this;\n    }\n\n    /**\n     * \n     */\n    filterForExited(): TrafficSimulator {\n        const { exitAlt } = this.props;\n        const [exited, notExited] = _.partition(this.session.flights,\n            { status: FlightStatus.Exited });\n        const noExited = exited.length;\n        if (noExited > 0) {\n            const [exitedOk, exitedKo] = _.partition(exited, f => {\n                return f.alt === exitAlt\n                    && f.to === f.exit\n            });\n            const ok = exitedOk.length;\n            const ko = exitedKo.length;\n            const notExitedMap = _(notExited)\n                .groupBy('id')\n                .mapValues(f => f[0])\n                .value();\n            const newSession = fromJS(this.session)\n                .set('flights', notExitedMap)\n                .update('noExitOk', (n: number) => n + ok)\n                .update('noExitKo', (n: number) => n + ko)\n                .toJS();\n            // Sending message\n            const okMessages = _.flatMap(exitedOk, f => [\n                buildLeavingMessage(f, this.props.map.id),\n                buildClearedToLeaveMessage(this.props.map.id, f.id, f.exit as string)\n            ]);\n            const koMessages = _.flatMap(exitedKo, f => [\n                buildLeavingMissingDepartureMessage(f, this.props.map.id),\n                buildClearedToLeaveMessage(this.props.map.id, f.id, f.exit as string)\n            ]);\n            return this.withSession(newSession)\n                .addMessages(okMessages)\n                .addMessages(koMessages);\n        }\n        return this;\n    }\n\n    /**\n     * \n     */\n    filterForOutOfArea(): TrafficSimulator {\n        const { map, exitDistance } = this.props;\n        const { center } = map;\n        const coords = mapDao.coords(map.nodes, center);\n        const flights = this.session.flights;\n        const [exited, inArea] = _.partition(flights,\n            f => {\n                const pts = mapDao.xy(f, center);\n                return pts[0] < coords.xmin - exitDistance\n                    || pts[0] > coords.xmax + exitDistance\n                    || pts[1] < coords.ymin - exitDistance\n                    || pts[1] > coords.ymax + exitDistance;\n            });\n        if (exited.length > 0) {\n            const inAreaMap = _(inArea)\n                .groupBy('id')\n                .mapValues(f => f[0])\n                .value();\n            const newSession = fromJS(this.session)\n                .set('flights', fromJS(inAreaMap))\n                .update('noExitKo', (n: number) => n + exited.length)\n                .toJS() as Session;\n            const messages = _(exited).flatMap(flight => [\n                buildOutOfAreaMessage(flight.id, this.props.map.id),\n                buildRogerMessage(this.props.map.id, flight.id)\n            ]).value();\n            return this.withSession(newSession).addMessages(messages);\n        } else {\n            return this;\n        }\n    }\n\n    /** */\n    filterForLanded(): TrafficSimulator {\n        const [landed, notLanded] = _.partition(this.session.flights,\n            { status: FlightStatus.Landed });\n        const noLanded = landed.length;\n        if (noLanded > 0) {\n            const [landedOk, landedKo] = _.partition(landed, f => f.to === f.rwy);\n            const ok = landedOk.length;\n            const ko = landedKo.length;\n            const notLandedMap: Record<string, Flight> = _(notLanded)\n                .map(f => [f.id, f])\n                .fromPairs()\n                .value();\n            const newSession = fromJS(this.session)\n                .set('flights', notLandedMap)\n                .update('noLandedOk', (n: number) => n + ok)\n                .update('noLandedKo', (n: number) => n + ko)\n                .toJS();\n            // Sending message\n            const okMessages = _.flatMap(landedOk, f => [\n                buildRunwayVacated(f, this.props.map.id),\n                buildGoodDayMessage(this.props.map.id, f.id)\n            ]);\n            const koMessages = _.flatMap(landedKo, f => [\n                buildWrongRunwayVacated(f, this.props.map.id),\n                buildGoodDayMessage(this.props.map.id, f.id)\n            ]);\n            return this.withSession(newSession)\n                .addMessages(okMessages)\n                .addMessages(koMessages);\n        } else {\n            return this;\n        }\n    }\n\n    /**\n     * \n     */\n    addTime(): TrafficSimulator {\n        const { dt } = this.props;\n        const session = fromJS(this.session)\n            .update('t', (t: number) => {\n                return t + dt;\n            })\n            .toJS() as Session;\n        return this.withSession(session);\n    }\n\n    /**\n     * \n     */\n    processFlights(): TrafficSimulator {\n        const { flights } = this.session;\n        if (_.size(flights) > 0) {\n            const processed = _(flights)\n                .values()\n                .map(flight =>\n                    new FlightProcessor(flight, this.props).processTime()\n                );\n            const newFlights = processed.map(fp => [fp.flight.id, fp.flight]).fromPairs().value() as Record<string, Flight>;\n            const messages = processed.flatMap('messages').value();\n            const newSession = fromJS(this.session).set('flights', newFlights).toJS() as Session;\n            return this.withSession(newSession).withMessages(messages);\n        } else {\n            return this;\n        }\n    }\n\n    /**\n     * \n     * @param {*} sessionMap \n     */\n    processForNewFlight(): TrafficSimulator {\n        const { dt, level } = this.props;\n        const { maxPlane, flightFreq } = level;\n        const { flights, t, noFlights } = this.session;\n        // Check for new flight eligibility\n        const max = maxPlane - _.size(flights);\n        const n = Math.max(\n            Math.min(rndPoisson(dt * flightFreq / 3600), max),\n            (noFlights === 0 && t >= MAX_INITIAL_IDLE_INTERVAL) ? 1 : 0);\n        if (n > 0) {\n            var tmp: TrafficSimulator = this;\n            for (var i = 0; i < n; i++) {\n                tmp = tmp.createFlight();\n            }\n            return tmp;\n        } else {\n            return this;\n        }\n    }\n\n    /**\n     * \n     */\n    createEntryCandidates(): HeadingMapNode[] {\n        const { safeEntryDelay } = this.props;\n        const { entries, t } = this.session;\n        const entryTimeout = t - safeEntryDelay;\n        return _(this.props.map.nodes)\n            .filter(node =>\n                node.type === MapNodeType.Runway\n                || (node.type === MapNodeType.Entry\n                    && (!entries[node.id]\n                        || entries[node.id] < entryTimeout)\n                )\n            ).value() as HeadingMapNode[];\n    }\n\n    /**\n     * \n     */\n    createExitCandidates(): MapNode[] {\n        return _(this.props.map.nodes)\n            .filter(node => node.type === MapNodeType.Runway || node.type === MapNodeType.Entry)\n            .value();\n    }\n\n    /**\n     * \n     * @param {*} sessionMap \n     */\n    createFlight() {\n        const candidates = this.createEntryCandidates();\n        if (candidates.length > 0) {\n            const { jetProb, entryAlt, flightTempl, flightVoices } = this.props;\n            const { noFlights, t, flights } = this.session;\n            const entry = choose(candidates);\n            const to = choose(this.createExitCandidates());\n            const type = rndByProb(jetProb) ? FlightType.Jet : FlightType.Airplane;\n            var id = undefined;\n            do {\n                id = rndFlightId();\n            } while (flights[id] !== undefined);\n            const fromRwy = isRunway(entry);\n            const alt = fromRwy ? 0 : entryAlt;\n            const status = fromRwy ? FlightStatus.WaitingForTakeoff : FlightStatus.Flying;\n            const speed = fromRwy ? 0 : flightSpeed(alt, flightTempl[type]);\n            const voice = flightVoices.length > 0 ? choose(flightVoices) : undefined;\n            const flight: Flight = {\n                id,\n                type,\n                alt,\n                toAlt: alt,\n                hdg: entry.hdg,\n                to: to.id,\n                lat: entry.lat,\n                lon: entry.lon,\n                speed,\n                from: entry.id,\n                status,\n                voice\n            };\n            const sessionMap1 = fromJS(this.session)\n                .set('noFlights', noFlights + 1)\n                .setIn(['flights', flight.id], flight);\n            const sessionMap = fromRwy\n                ? sessionMap1\n                : sessionMap1.setIn(['entries', entry.id], t);\n            const next = this.withSession(sessionMap.toJS())\n\n            const toRwy = isRunway(to);\n            return fromRwy ?\n                (toRwy ?\n                    next.addDepartureToDialog(flight) :\n                    next.addDepartureLeaveDialog(flight)) :\n                (toRwy ?\n                    next.addEnterToDialog(flight) :\n                    next.addEnterLeaveDialog(flight));\n        } else {\n            return this;\n        }\n    }\n}\n","import _ from 'lodash';\nimport { AreaMap, FlightMap, GeoLocation, MapRoute, RadarNode } from './Map';\nimport { mapDao } from './MapDao';\n\nexport interface RadarMapProps {\n    readonly map: AreaMap;\n    readonly nodeMap: FlightMap;\n    readonly width: number;\n    readonly height: number;\n    readonly borders: number;\n    readonly offsetX: number;\n    readonly offsetY: number\n    readonly scale?: number;\n}\n\ninterface Rect {\n    readonly topLeft: number[];\n    readonly bottomRight: number[];\n}\n\n/**\n * RadarMap computes the pixel position of nodes or locations in the map\n */\nclass RadarMap {\n    private _props: RadarMapProps;\n\n    /**\n     * Creates the radar map\n     * @param {*} props the props\n     */\n    constructor(props: RadarMapProps) {\n        const { nodeMap, width, height, borders, offsetX = 0, offsetY = 0 } = props;\n        if (props.scale === undefined) {\n            const xRange = Math.max(nodeMap.xmax, -nodeMap.xmin);\n            const yRange = Math.max(nodeMap.ymax, -nodeMap.ymin);\n            const xscale = (width - borders * 2) / xRange / 2;\n            const yscale = (height - borders * 2) / yRange / 2;\n            const scale1 = Math.min(xscale, yscale);\n            this._props = _.assign({}, props, { scale: scale1, offsetX, offsetY });\n        } else {\n            this._props = _.assign({}, props, { offsetX, offsetY });\n        }\n    }\n\n    /** */\n    get props(): RadarMapProps { return this._props; }\n\n    /** */\n    get gridSize(): number {\n        const { width, height, borders } = this.props;\n        const mapSize = (Math.min(width, height) - borders * 2) / this.scale;\n        const gs10 = mapSize / 5;\n        const logGs = Math.round(Math.log10(gs10));\n        const gs = Math.pow(10, logGs);\n        return gs;\n    }\n\n    /** */\n    get rect(): Rect {\n        const { nodeMap } = this.props;\n        const xRange = Math.max(nodeMap.xmax, -nodeMap.xmin);\n        const yRange = Math.max(nodeMap.ymax, -nodeMap.ymin);\n        return {\n            topLeft: [-xRange, -yRange],\n            bottomRight: [xRange, yRange]\n        };\n    }\n\n    /**\n     * Returns the width of map in px\n     */\n    get witdh(): number { return this.props.width; }\n\n    /**\n     * Returns the height of map in px\n     */\n    get height(): number { return this.props.height; }\n\n    /**\n     * Returns the node map\n     */\n    get nodeMap(): FlightMap { return this.props.nodeMap; }\n\n    /**\n     * Returns the map\n     */\n    get map(): AreaMap { return this.props.map; }\n\n    /**\n     * Returns the nodes\n     */\n    get nodes(): Record<string, RadarNode> { return this.nodeMap.nodes; }\n\n    /** */\n    get scale(): number { return this.props.scale || 1; }\n\n    /** */\n    get offsetX(): number { return this.props.offsetX; }\n\n    /** */\n    get offsetY(): number { return this.props.offsetY; }\n\n    /**\n     * Return a node\n     * @param id the node id \n     */\n    node(id: string): RadarNode {\n        return this.nodes[id];\n    }\n\n    /**\n     * Returns the pix coordinates of node [x, y]\n     * @param coords the coordinates in nms\n     */\n    pointByNm(coords: number[]): number[] {\n        const { width, height } = this.props;\n        const x = (coords[0] - this.offsetX) * this.scale + width / 2;\n        const y = -(coords[1] - this.offsetY) * this.scale + height / 2;\n        return [x, y];\n    }\n\n    /**\n     * Returns the pix coordinate of node [x, y]\n     * @param node the node\n     */\n    pointByNode(node: RadarNode): number[] {\n        return this.pointByNm(node.coords);\n    }\n\n    /**\n     * Returns the pix coordinate of node [x, y]\n     * @param id the node id\n     */\n    pointByNodeId(id: string): number[] {\n        return this.pointByNode(this.node(id));\n    }\n\n    /**\n     * Returnds the route paths  [[fromx, toy], [tox, toy]]\n     * @param route the route\n     */\n    routePath(route: MapRoute): number[][] {\n        const from = this.pointByNodeId(route.edges[0]);\n        const to = this.pointByNodeId(route.edges[1]);\n        return [from, to];\n    }\n\n    /**\n     * return the pix coordinate [x, y]\n     * @param location the location {lat, lon}\n     */\n    pointByGeo(location: GeoLocation): number[] {\n        return this.pointByNm(mapDao.xy(location, this.map.center));\n    }\n\n    /**\n     * \n     * @param dx \n     * @param dy \n     */\n    moveByNm(dx: number, dy: number): RadarMap {\n        return new RadarMap(_.defaults({\n            offsetX: this.offsetX + dx,\n            offsetY: this.offsetY + dy\n        }, this.props));\n    }\n\n    /**\n     * \n     * @param dx \n     * @param dy \n     */\n    moveByPts(dx: number, dy: number): RadarMap {\n        const dxnms = -dx / this.scale;\n        const dynms = dy / this.scale;\n        return this.moveByNm(dxnms, dynms);\n    }\n}\n\nexport default RadarMap;\n","import React, { Component, FunctionComponent } from 'react';\n\nimport _ from 'lodash';\nimport RadarMap from './RadarMap';\nimport { sprintf } from 'sprintf-js';\nimport { ButtonGroup, Button } from 'react-bootstrap';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { faSearch, faSearchMinus, faSearchPlus } from '@fortawesome/free-solid-svg-icons'\nimport { Flight, FlightStatus } from './Flight';\nimport { AreaMap, FlightMap, MapRoute, RadarNode } from './Map';\nimport { Session } from './Session';\n\nconst ZOOM_TICK = 57;\nconst ZOOM_SCALE = Math.log(10) / 4 / ZOOM_TICK;\nconst GRID_MARKER_HEIGHT = 4;\n\nconst RadarConf = {\n    width: 850,\n    height: 850,\n    borders: 30\n};\n\nconst ImageConf = {\n    width: 15,\n    height: 14\n};\n\nconst PlaneConf = {\n    text1: { x: 2, y: -24 },\n    text2: { x: 2, y: -12 },\n    bar: { x1: 0, x2: 0, y1: -8, y2: -34 }\n};\n\nconst FlightLevels = ['040', '080', '120', '160', '200', '240', '280', '320', '360'];\n\n/**\n * \n * @param pt \n * @param props \n */\nfunction textPos(pt: number[], props: any): number[] {\n    const { alignment = 'E', width = 20, height = 8, radius = 6 } = props;\n    var x = pt[0];\n    var y = pt[1];\n    switch (alignment) {\n        case 'W':\n        case 'NW':\n        case 'SW':\n            x -= radius + width;\n            break;\n        case 'E':\n        case 'NE':\n        case 'SE':\n            x += radius;\n            break;\n        default:\n            x -= width / 2;\n    }\n    switch (alignment) {\n        case 'N':\n        case 'NE':\n        case 'NW':\n            y -= radius;\n            break;\n        case 'S':\n        case 'SE':\n        case 'SW':\n            y += radius + height;\n            break;\n        default:\n            y += height / 2;\n    }\n    return [x, y];\n}\n\n/**\n * \n * @param {*} altitude \n */\nfunction flightLevel(altitude: number): string {\n    return FlightLevels[Math.max(0, Math.floor((altitude - 2000) / 4000))];\n}\n\n/**\n * \n * @param {*} param0 \n */\nconst Node: FunctionComponent<{\n    readonly node: RadarNode;\n    readonly radarMap: RadarMap;\n}> = ({ node, radarMap }) => {\n    const pt = radarMap.pointByNode(node);\n    const textPt = textPos(pt, { alignment: node.node.alignment });\n    const nodeClass = node.node.type;\n    const textClass = node.node.type;\n    return (\n        <g>\n            <circle cx={pt[0]} cy={pt[1]} className={nodeClass} />\n            <text x={textPt[0]} y={textPt[1]} className={textClass}>{node.node.id}</text>\n        </g>\n    );\n}\n\n/**\n * \n * @param angle \n * @param x \n * @param y \n */\nfunction rotate(angle: number, x: number, y: number): string {\n    return sprintf('rotate(%f,%f,%f)', angle, x, y);\n}\n\n/**\n * \n * @param x \n * @param y \n */\nfunction translate(x: number, y: number): string {\n    return sprintf('translate(%g,%g)', x, y);\n}\n\n/**\n * \n * @param {*} param0 \n */\nconst FlightGraph: FunctionComponent<{\n    readonly flight: Flight;\n    readonly radarMap: RadarMap;\n    collisionDistance: number;\n}> = ({ flight, radarMap, collisionDistance }) => {\n    if (flight.status === FlightStatus.WaitingForTakeoff) {\n        return (<g />);\n    } else {\n        const pt = radarMap.pointByGeo(flight);\n        const collisionRadius = collisionDistance * radarMap.scale / 2;\n        const showColllision = collisionRadius > 5;\n        const collisionClassName = collisionRadius > 20 ? 'collision-dots' : 'collision-solid';\n        const fl = flightLevel(flight.alt);\n        const trans = translate(pt[0] - ImageConf.width / 2, pt[1] - ImageConf.height / 2)\n            + rotate(flight.hdg, ImageConf.width / 2, ImageConf.height / 2);\n        const url = `${process.env.REACT_APP_BASENAME}/images/${flight.type === 'J' ? 'jet' : 'plane'\n            }-${fl}.png`;\n        const txt1 = sprintf(\"%s-%s\", flight.id, flight.type);\n        const txt2 = sprintf('%03d', Math.round(flight.alt / 100));\n        const x1 = pt[0] + PlaneConf.text1.x;\n        const x2 = pt[0] + PlaneConf.text2.x;\n        const y1 = pt[1] + PlaneConf.text1.y;\n        const y2 = pt[1] + PlaneConf.text2.y;\n        const x3 = pt[0] + PlaneConf.bar.x1;\n        const x4 = pt[0] + PlaneConf.bar.x2;\n        const y3 = pt[1] + PlaneConf.bar.y1;\n        const y4 = pt[1] + PlaneConf.bar.y2;\n        const txtClassName = 'fl-' + fl;\n        return (\n            <g>\n                { showColllision\n                    ? (<circle cx={pt[0]} cy={pt[1]} className={`${collisionClassName} ${txtClassName}`} r={collisionRadius} />)\n                    : (<g />)}\n                <image href={url}\n                    x={0} y={0}\n                    width={ImageConf.width} height={ImageConf.height}\n                    transform={trans} />\n                <line x1={x3} y1={y3} x2={x4} y2={y4} className={txtClassName} />\n                <text x={x1} y={y1} className={txtClassName}>{txt1}</text>\n                <text x={x2} y={y2} className={txtClassName}>{txt2}</text>\n            </g>);\n    }\n}\n\n/**\n *    x0   x1   x2\n * y1  |   |\n * y0  |---|    legend\n * y2  |   |\n * \n * @param {*} param0 \n */\nconst GridMarker: FunctionComponent<{\n    radarMap: RadarMap;\n}> = ({ radarMap }) => {\n    const { borders } = radarMap.props;\n    const gridSize = radarMap.gridSize;\n    const x0 = borders / 2;\n    const x1 = x0 + gridSize * radarMap.scale;\n    const x2 = x1 + 10;\n    const y0 = borders / 2;\n    const y1 = borders / 2 - GRID_MARKER_HEIGHT;\n    const y2 = borders / 2 + GRID_MARKER_HEIGHT;\n    const gridMarkerText = sprintf(\"%g nms\", gridSize);\n    return (<g className=\"gridmarker\">\n        <line x1={x0} y1={y0} x2={x1} y2={y0} />\n        <line x1={x0} y1={y1} x2={x0} y2={y2} />\n        <line x1={x1} y1={y1} x2={x1} y2={y2} />\n        <text x={x2} y={y0}>{gridMarkerText}</text>\n    </g>\n    );\n}\n\n/**\n * \n * @param {*} param0 \n */\nconst Grid: FunctionComponent<{\n    radarMap: RadarMap;\n}> = ({ radarMap }) => {\n    const { topLeft, bottomRight } = radarMap.rect;\n    const gridSize = radarMap.gridSize;\n    const gxmin = Math.floor(topLeft[0] / gridSize);\n    const gxmax = Math.ceil(bottomRight[0] / gridSize);\n    const gymin = Math.floor(topLeft[1] / gridSize);\n    const gymax = Math.ceil(bottomRight[1] / gridSize);\n    const xidx = _.range(gxmin, gxmax + 1);\n    const yidx = _.range(gymin, gymax + 1);\n    const { borders, width, height } = radarMap.props;\n    const x0 = borders;\n    const x1 = width - borders;\n    const y0 = borders;\n    const y1 = height - borders;\n    return (\n        <g className=\"gridmap\">\n            {xidx.map(i => {\n                const upnms = [i * gridSize, gymin * gridSize];\n                const dwnnms = [i * gridSize, gymax * gridSize];\n                const pts = [\n                    radarMap.pointByNm(upnms),\n                    radarMap.pointByNm(dwnnms)\n                ];\n                return (\n                    <line key={`v${i}`}\n                        x1={pts[0][0]} y1={y0}\n                        x2={pts[1][0]} y2={y1} />\n                );\n            })}\n            {yidx.map(i => {\n                const lnms = [gxmin * gridSize, i * gridSize];\n                const rpnms = [gxmax * gridSize, i * gridSize];\n                const pts = [\n                    radarMap.pointByNm(lnms),\n                    radarMap.pointByNm(rpnms)\n                ];\n                return (\n                    <line key={`h${i}`}\n                        x1={x0} y1={pts[0][1]}\n                        x2={x1} y2={pts[1][1]} />\n                );\n            })}\n        </g>\n    );\n}\n\n/**\n * \n * @param {*} param0 \n */\nconst Route: FunctionComponent<{\n    readonly route: MapRoute;\n    readonly radarMap: RadarMap;\n}> = ({ route, radarMap }) => {\n    const pts = radarMap.routePath(route);\n    const cl = route.type;\n    return (<line x1={pts[0][0]} y1={pts[0][1]} x2={pts[1][0]} y2={pts[1][1]} className={cl} />);\n}\n\ntype RadarPaneProps = Partial<Readonly<{\n    session: Session;\n    map: AreaMap;\n    nodeMap: FlightMap;\n    collisionDistance: number;\n}>>;\n\nexport class RadarPane extends Component<RadarPaneProps, {\n    readonly dragging: boolean;\n    readonly offsetX: number;\n    readonly offsetY: number;\n    readonly scale: number;\n    readonly pivotX?: number;\n    readonly pivotY?: number;\n    readonly clientX?: number;\n    readonly clientY?: number;\n}> {\n    /**\n     * \n     * @param {*} props \n     */\n    constructor(props: RadarPaneProps) {\n        super(props);\n        const { map, nodeMap, session } = this.props;\n        const scale = (!!nodeMap && !!map && !!session)\n            ? new RadarMap(_.assign({}, RadarConf, {\n                map, nodeMap,\n                offsetX: 0, offsetY: 0\n            })).scale\n            : 1;\n\n        this.state = {\n            dragging: false,\n            offsetX: 0,\n            offsetY: 0,\n            scale\n        };\n        _.bindAll(this, [\n            'handleDown', 'handleMove', 'handleUp', 'handleWheel', 'render',\n            'handleFit', 'handleZoomIn', 'handleZoomOut'\n        ]);\n    }\n\n    /**\n     *\n     * @param {*} ev\n     */\n    handleDown(ev: React.MouseEvent) {\n        switch (ev.button) {\n            case 0:\n                // Drag map\n                ev.preventDefault();\n                this.setState({\n                    dragging: true,\n                    pivotX: ev.clientX,\n                    pivotY: ev.clientY,\n                    clientX: ev.clientX,\n                    clientY: ev.clientY\n                });\n                break;\n            case 1:\n                // fit the map to the viewport\n                ev.preventDefault();\n                this.fit();\n                break;\n            default:\n        }\n    }\n\n    fit() {\n        const { map, nodeMap, session } = this.props;\n        const { offsetX, offsetY } = this.state;\n        const scale = (!!nodeMap && !!map && !!session)\n            ? new RadarMap(_.assign({}, RadarConf, {\n                map, nodeMap, offsetX, offsetY\n            })).scale\n            : 1;\n        this.setState({\n            dragging: false,\n            offsetX: 0,\n            offsetY: 0,\n            scale\n        });\n    }\n    /**\n     *\n     * @param {*} ev\n     */\n    handleUp(ev: React.MouseEvent) {\n        ev.preventDefault();\n        const rm = this.radarMap();\n        if (rm) {\n            this.setState({\n                dragging: false,\n                offsetX: rm.offsetX,\n                offsetY: rm.offsetY\n            });\n        }\n    }\n\n    /**\n     *\n     * @param {*} ev\n     */\n    handleLeave(ev: React.MouseEvent) {\n        ev.preventDefault();\n        this.setState({\n            dragging: false\n        });\n    }\n\n    /**\n     * \n     * @param {*} ev \n     */\n    handleWheel(ev: React.WheelEvent) {\n        if (ev.shiftKey) {\n            // ev.preventDefault();\n            this.zoom(ev.deltaY);\n        }\n    }\n\n    zoom(deltaY: number) {\n        const factor = Math.exp(-deltaY * ZOOM_SCALE);\n        const rm = this.radarMap();\n        if (rm) {\n            const scale = rm.scale * factor;\n            this.setState({ scale });\n        }\n    }\n\n    handleZoomIn() {\n        this.zoom(-ZOOM_TICK);\n    }\n\n    handleZoomOut() {\n        this.zoom(ZOOM_TICK);\n    }\n\n    handleFit() {\n        this.fit();\n    }\n\n    /**\n     *\n     * @param {*} ev\n     */\n    handleMove(ev: React.MouseEvent) {\n        const { dragging } = this.state;\n        if (dragging) {\n            ev.preventDefault();\n            const { clientX, clientY } = ev;\n            this.setState({ clientX, clientY });\n        }\n    }\n\n    /**\n     * \n     */\n    radarMap() {\n        const { map, nodeMap } = this.props;\n        if (map && nodeMap) {\n            const { dragging, clientX = 0, clientY = 0, pivotX = 0, pivotY = 0, offsetX, offsetY, scale } = this.state;\n            if (dragging) {\n                return new RadarMap(_.assign({}, RadarConf, {\n                    map,\n                    nodeMap,\n                    width: RadarConf.width,\n                    height: RadarConf.height,\n                    offsetX,\n                    offsetY,\n                    scale\n                })\n                ).moveByPts(clientX - pivotX, clientY - pivotY);\n            } else {\n                return new RadarMap(_.assign({}, RadarConf, {\n                    map,\n                    nodeMap,\n                    width: RadarConf.width,\n                    height: RadarConf.height,\n                    offsetX,\n                    offsetY,\n                    scale\n                }));\n            }\n        }\n    }\n\n    /**\n     * \n     */\n    render() {\n        const { map, nodeMap, session, collisionDistance } = this.props;\n        const radarMap = this.radarMap();\n        if (!nodeMap || !map || !session || !radarMap) {\n            return (<svg width={RadarConf.width} height={RadarConf.height} className=\"radar\" />);\n        } else {\n            const flights = session.flights;\n            return (\n                <div>\n                    <svg width={RadarConf.width} height={RadarConf.height}\n                        onMouseMove={this.handleMove}\n                        onMouseDown={this.handleDown}\n                        onMouseUp={this.handleUp}\n                        onMouseLeave={this.handleUp}\n                        onWheel={this.handleWheel}\n                        className=\"radar\">\n                        <Grid radarMap={radarMap} />\n                        {_.map(map.routes, (route, i) => (\n                            <Route key={i} radarMap={radarMap} route={route} />\n                        ))}\n                        {_(nodeMap.nodes).values().map((node, i) => (\n                            <Node key={i} radarMap={radarMap} node={node} />\n                        )).value()}\n                        <GridMarker radarMap={radarMap} />\n                        {_(flights).values().orderBy('alt', 'asc').map(flight => (\n                            <FlightGraph key={flight.id} radarMap={radarMap} flight={flight}\n                                collisionDistance={collisionDistance || 4} />\n                        )).value()}\n                    </svg>\n                    <ButtonGroup vertical size=\"sm\">\n                        <Button variant=\"dark\" onClick={this.handleZoomIn}>\n                            <FontAwesomeIcon icon={faSearchPlus} />\n                        </Button>\n                        <Button variant=\"dark\" onClick={this.handleZoomOut}>\n                            <FontAwesomeIcon icon={faSearchMinus} />\n                        </Button>\n                        <Button variant=\"dark\" onClick={this.handleFit}>\n                            <FontAwesomeIcon icon={faSearch} />\n                        </Button>\n                    </ButtonGroup>\n                </div >\n            );\n        }\n    }\n}\n","import React, { FunctionComponent } from 'react';\nimport { Accordion, Card, Form } from 'react-bootstrap';\nimport '../App.css';\n\nconst DefaultSpeeds = [1, 3, 10];\n\n/**\n * \n * @param {*} param0 \n */\nexport const OptionsPane: FunctionComponent<{\n  readonly muted?: boolean;\n  readonly onMuted?: () => void;\n  readonly listeningEnabled?: boolean;\n  readonly onListeningEnabled?: () => void;\n  readonly speed?: number;\n  readonly speeds?: number[];\n  readonly onSpeed?: (speed: number) => void;\n}> = ({ muted, onMuted, listeningEnabled, onListeningEnabled, speed, speeds = DefaultSpeeds, onSpeed }) => {\n  return (\n    <Accordion defaultActiveKey=\"1\">\n      <Card bg=\"dark\" text=\"white\">\n        <Accordion.Toggle as={Card.Header} eventKey=\"1\">\n          Options\n      </Accordion.Toggle>\n        <Accordion.Collapse eventKey=\"1\">\n          <Card.Body>\n            <Form>\n              <Form.Group controlId=\"muted\">\n                <Form.Label>Audio</Form.Label>\n                <Form.Check\n                  type=\"switch\"\n                  id=\"muted\"\n                  label=\"Muted\"\n                  onChange={onMuted}\n                  checked={muted} />\n                <Form.Check\n                  type=\"switch\"\n                  id=\"listening\"\n                  label=\"Listening\"\n                  onChange={onListeningEnabled}\n                  checked={listeningEnabled} />\n              </Form.Group>\n              <Form.Group controlId=\"speed\">\n                <Form.Label>Speed</Form.Label>\n                {speeds.map(sp => {\n                  return (\n                    <Form.Check\n                      type=\"radio\"\n                      name=\"speed\"\n                      checked={speed === sp}\n                      // id={sp}\n                      key={sp}\n                      value={sp}\n                      onChange={(ev: React.ChangeEvent<HTMLInputElement>) => { if (onSpeed) { onSpeed(parseFloat(ev.target.value)) } }}\n                      label={`x ${sp}`} />\n                  );\n                })}\n              </Form.Group>\n            </Form>\n          </Card.Body>\n        </Accordion.Collapse>\n      </Card>\n    </Accordion>\n  );\n}\n","import React, { FunctionComponent } from 'react';\nimport _ from 'lodash';\nimport { sprintf } from 'sprintf-js';\nimport { Flight, FlightStatus } from './Flight';\nimport { Session } from './Session';\n\n/**\n * \n * @param {*} flight \n */\nfunction status(flight: Flight): string {\n    const { status, at, turnTo, rwy, from } = flight;\n\n    switch (status) {\n        case FlightStatus.Flying:\n            return '';\n        case FlightStatus.FlyingTo:\n            return `flying to ${at}`;\n        case FlightStatus.WaitingForTakeoff:\n            return sprintf('holding rwy %s', from);\n        case FlightStatus.Landing:\n            return sprintf('landing rwy %s', rwy);\n        case FlightStatus.Aligning:\n            return sprintf('aligning rwy %s', rwy);\n        case FlightStatus.Approaching:\n            return sprintf('approaching rwy %s', rwy);\n        case FlightStatus.HoldingFrom:\n        case FlightStatus.HoldingTo:\n            return 'holding';\n        case FlightStatus.HoldingFromAt:\n        case FlightStatus.HoldingToAt:\n            return `holding at ${at}`;\n        case FlightStatus.Turning:\n            return sprintf('turn to %s via %s', turnTo, at);\n        default:\n            return status;\n    }\n}\n\n/**\n * \n * @param {*} flight \n */\nfunction toLines(flight: Flight): string[] {\n    const fl = Math.round(flight.alt / 100);\n    const toFl = Math.round(flight.toAlt / 100);\n    const st = status(flight);\n    const line1 = sprintf('%3s to %s Class %s', flight.id, flight.to, flight.type);\n\n    const line2 = fl !== toFl\n        ? sprintf('    FL%03d to FL%03d Hdg %03d', fl, toFl, flight.hdg)\n        : sprintf('    FL%03d  Hdg %03d', fl, flight.hdg);\n\n    return st.length === 0\n        ? [line1, line2]\n        : [line1, line2, sprintf('    %s', status(flight))];\n}\n\n/**\n * \n * @param {*} param0 \n */\nexport const QueuePane: FunctionComponent<{\n    readonly session?: Session;\n}> = ({ session }) => {\n    if (!session) {\n        return (\n            <pre className=\"terminal\" />\n        );\n    } else {\n        const lines = _(session.flights)\n            .values()\n            .sortBy(['id'])\n            .flatMap(toLines)\n            .join('\\n');\n        return (\n            <pre className=\"terminal\">{lines}</pre>\n        );\n    }\n}\n","import React, { FunctionComponent } from 'react';\nimport { Accordion, Card } from 'react-bootstrap';\nimport '../App.css';\nimport { Session } from './Session';\nimport { CockpitLogger } from './CockpitLogger';\nimport { QueuePane } from './QueuePane';\n\n/**\n * \n * @param {*} param0 \n */\nexport const InfoPane: FunctionComponent<{\n  session?: Session,\n  logger?: CockpitLogger;\n}> = ({ session, logger }) => {\n  return (\n    <div>\n      <Accordion defaultActiveKey=\"0\">\n        <Card bg=\"dark\" text=\"white\">\n          <Accordion.Toggle as={Card.Header} eventKey=\"0\">\n            Flights\n          </Accordion.Toggle>\n          <Accordion.Collapse eventKey=\"0\">\n            <Card.Body>\n              <QueuePane session={session} />\n            </Card.Body>\n          </Accordion.Collapse>\n        </Card>\n      </Accordion>\n      <Accordion defaultActiveKey=\"0\">\n        <Card bg=\"dark\" text=\"white\">\n          <Accordion.Toggle as={Card.Header} eventKey=\"2\">\n            Cockpit Log\n          </Accordion.Toggle>\n          <Accordion.Collapse eventKey=\"2\">\n            <Card.Body>\n              {logger && logger.log.map((msg, i) => (\n                <div key={i} className={`term-${msg.style} text-monospace`}>{msg.text}</div>\n              ))}\n            </Card.Body>\n          </Accordion.Collapse>\n        </Card>\n      </Accordion>\n    </div>\n  );\n}\n","import { BehaviorSubject, combineLatest, Observable, Subject } from \"rxjs\";\nimport { map, tap, filter } from \"rxjs/operators\";\nimport { speakingPooling, synthSay } from \"./Audio\";\nimport _ from 'lodash';\n\nconst DefaultPolling = 500;\n/**\n * \n * @param param0\n */\nconst createRecogn: (arg: {\n    onresult?: (ev: SpeechRecognitionEvent) => void,\n    onnomatch?: (ev: SpeechRecognitionEvent) => void,\n    onend?: (ev: Event) => void\n    onerror?: (ev: Event) => void\n    ondefault?: (ev: Event) => void\n}) => SpeechRecognition | undefined\n    = ({ ondefault = null, onresult = null, onend = null, onnomatch = null, onerror = null }) => {\n        const SpeechRecognition: (new () => SpeechRecognition) | undefined = window.SpeechRecognition || (window as any).webkitSpeechRecognition;\n        if (!!SpeechRecognition) {\n            const recognition = new SpeechRecognition();\n            // const speechRecognitionList = new SpeechGrammarList();\n            // speechRecognitionList.addFromString(grammar, 1);\n            // recognition.grammars = speechRecognitionList;\n            recognition.continuous = false;\n            recognition.lang = 'en';\n            recognition.interimResults = false;\n            recognition.maxAlternatives = 1;\n\n            recognition.onresult = onresult || ondefault;\n            recognition.onspeechend = ondefault;\n            recognition.onnomatch = onnomatch || ondefault\n            recognition.onerror = onerror || ondefault;\n            recognition.onstart = ondefault;\n            recognition.onaudiostart = ondefault;\n            recognition.onsoundstart = ondefault;\n            recognition.onspeechstart = ondefault;\n            recognition.onspeechend = ondefault;\n            recognition.onsoundend = ondefault;\n            recognition.onaudioend = ondefault;\n            recognition.onend = onend || ondefault;\n            return recognition;\n            // return undefined;\n        } else {\n            return undefined;\n        }\n    };\n\nfunction cleared(listening: Observable<boolean>, speaking: Observable<boolean>): Observable<boolean> {\n    return combineLatest([speaking, listening]).pipe(\n        map(([speaking, listening]) => !speaking && !listening),\n        filter(cleared => cleared)\n    );\n}\n\ntype AudioDialogProps<T> = Readonly<{\n    polling?: number;\n    parseSpeech: (arg: string) => T;\n    isCompleted: (arg: T) => boolean;\n    onSpeech?: (arg: string) => void;\n    onRecognized?: (arg: T) => void;\n    onListening?: (arg: boolean) => void;\n}>;\n\n/**\n * \n */\nexport class AudioDialog<T> {\n    private _recogn: SpeechRecognition | undefined;\n    private _speeches: Subject<string>;\n    private _messages: Subject<T>;\n    private _listening: Subject<boolean>;\n    private _props: AudioDialogProps<T>;\n    private _buffer: string[];\n    private _speech: string;\n    private _listenEnabled: boolean;\n\n    constructor(props: AudioDialogProps<T>) {\n        this._props = props;\n        this._speeches = new Subject<string>();\n        this._messages = new Subject<T>();\n        this._listening = new BehaviorSubject<boolean>(false);\n        const self = this;\n        this._buffer = [];\n        this._speech = '';\n        this._listenEnabled = false;\n\n        this._recogn = createRecogn({\n            onend: ev => {\n                self._listening.next(false);\n            },\n            // onresult: ev => {\n            //     console.log('------------------');\n            //         _.forEach(ev.results, (element, i) => {\n            //         console.log(element.isFinal,\n            //             element[0].confidence,\n            //             element[0].transcript);\n            //     });\n            //     console.log('------------------');\n            // },\n            onresult: ev => {\n                const speech = ev.results[0][0].transcript\n                this.handleSpeech(speech);\n            }\n            // ondefault: ev => { console.log(ev.type); }\n        });\n\n        const { onSpeech, onListening, onRecognized } = props;\n        if (onSpeech) {\n            this.speeches().pipe(\n                tap(s => onSpeech(s))\n            ).subscribe();\n        }\n        if (onRecognized) {\n            this.messages().pipe(\n                tap(s => onRecognized(s))\n            ).subscribe();\n        }\n        if (onListening) {\n            this.listening().pipe(\n                tap(s => {\n                    onListening(s);\n                })\n            ).subscribe();\n        }\n\n        const notSpeaking = speakingPooling(props.polling || DefaultPolling).pipe(\n            filter(speaking => !speaking)\n        );\n        cleared(this.listening(), notSpeaking).pipe(\n            tap(cleared => self.handleCleared(cleared))\n        ).subscribe();\n    }\n\n    private get props() { return this._props; }\n\n    private get recogn() { return this._recogn; }\n\n    /**\n     * \n     * @param speech \n     */\n    private handleSpeech(speech: string) {\n        // console.log(speech);\n        const sp = (this._speech + ' ' + speech).trim();\n        const msg = this.props.parseSpeech(sp);\n        if (this.props.isCompleted(msg)) {\n            this._messages.next(msg);\n            this._speech = '';\n            this._speeches.next('');\n        } else {\n            this._speech = sp;\n            this._speeches.next(sp);\n        }\n    }\n\n    /**\n     * \n     */\n    private handleCleared(cleared: boolean) {\n        if (this._speech === '' && this._buffer.length > 0) {\n            const bfr = this._buffer;\n            this._buffer = [];\n            // console.log('speaking ...');\n            synthSay(bfr).subscribe();\n        } else if (this.listenEnabled) {\n            this.startListening();\n        }\n    }\n\n    /**\n     * \n     */\n    private startListening() {\n        const rec = this.recogn;\n        if (rec) {\n            this._listening.next(true);\n            // console.log('listening...')\n            rec.start();\n        }\n    }\n\n    speeches() { return this._speeches.asObservable(); }\n\n    /**\n     * \n     */\n    listening() { return this._listening.asObservable(); }\n\n    /**\n     * \n     */\n    messages() {\n        return this._messages.asObservable();\n    }\n\n    /**\n     * \n     * @param speeches \n     */\n    say(speeches: string[]) {\n        const bfr = this._buffer;\n        this._buffer = [];\n        this._buffer = _.concat(bfr, speeches);\n    }\n\n    get listenEnabled() { return this._listenEnabled; }\n\n    /**\n     * \n     */\n    set listenEnabled(value: boolean) {\n        this._listenEnabled = value;\n    }\n}\n","import React, { FunctionComponent } from 'react';\nimport { faMicrophone, faMicrophoneSlash } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { Card, Form, InputGroup } from 'react-bootstrap';\nimport '../App.css';\n\n/**\n * \n * @param {*} param0 \n */\nexport const SpeechPane: FunctionComponent<{\n  readonly listening?: boolean;\n  readonly speech?: string;\n}> = ({ listening, speech = '' }) => {\n  return (\n    <Card bg=\"dark\" text=\"white\">\n      <Card.Body>\n        <Form>\n          <Form.Group >\n            <Form.Label>Listening</Form.Label>\n            <InputGroup>\n              <InputGroup.Prepend>\n                {listening ?\n                  (<FontAwesomeIcon icon={faMicrophone} />) :\n                  (<FontAwesomeIcon icon={faMicrophoneSlash} />)}\n              </InputGroup.Prepend>\n            </InputGroup>\n            {speech.toLowerCase()}\n          </Form.Group>\n        </Form>\n      </Card.Body>\n    </Card>\n  );\n}\n","import { buildClimbCommand, buildDescendCommand, buildFlyToCommand, buildHoldCommand, buildLandCommand, buildMaintainCommand, buildTakeoffCommand, buildUnitellegibleMessage, CommandMessage, MessageTag } from './Message';\nimport _ from 'lodash';\n\nconst Similitudes: Record<string, string[]> = {\n    at: ['it'],\n    cleared: ['clear', 'player', 'order'],\n    climb: ['time'],\n    descend: ['descent'],\n    fly: ['flight', 'play'],\n    flight: ['fly', 'play'],\n    maintain: ['19'],\n    runway: ['railway', 'runways', 'roundway'],\n    to: ['two', '2'],\n    via: ['fire', 'by']\n}\n\n/**\n * \n */\ntype ContextProps = Readonly<{\n    tokens: string[];\n    cursor: number;\n    stack: any[];\n}>\n\nconst NumberDict: Record<string, string> = {\n    zero: '0',\n    one: '1',\n    wine: '1',\n    two: '2',\n    to: '2',\n    three: '3',\n    four: '4',\n    for: '4',\n    five: '5',\n    six: '6',\n    seven: '7',\n    eight: '8',\n    nine: '9',\n    niner: '9',\n    naina: '9'\n};\n\nconst AlphaDict: Record<string, string> = {\n    alpha: 'a',\n    bravo: 'b',\n    charlie: 'c',\n    delta: 'd',\n    echo: 'e',\n    foxtrot: 'f',\n    'fox-trot': 'f',\n    'fox-tots': 'f',\n    golf: 'g',\n    hotel: 'h',\n    india: 'i',\n    indian: 'i',\n    juliet: 'j',\n    kilo: 'k',\n    lima: 'l',\n    mike: 'm',\n    november: 'n',\n    oscar: 'o',\n    papa: 'p',\n    quebec: 'q',\n    rebec: 'q',\n    prebec: 'q',\n    romeo: 'r',\n    sierra: 's',\n    tango: 't',\n    uniform: 'u',\n    uniforms: 'u',\n    uniformed: 'u',\n    victor: 'v',\n    viktor: 'v',\n    picture: 'v',\n    whiskey: 'w',\n    whisky: 'w',\n    'x-ray': 'x',\n    'x-rayed': 'x',\n    yankee: 'y',\n    zulu: 'z'\n};\n\nconst RunwaySuffixDict: Record<string, string> = {\n    right: 'r',\n    center: 'c',\n    left: 'l'\n};\n\ntype StackElement = string | CommandMessage | undefined;\n\n/**\n * \n * @param el \n */\nfunction isString(el: StackElement): el is string {\n    return typeof el === 'string';\n}\n\nfunction isMessage(el: StackElement): el is CommandMessage {\n    return el !== undefined && !isString(el);\n}\n\n/**\n * \n */\nclass Context implements Context {\n    private _props: ContextProps;\n\n    /**\n     * \n     * @param props \n     */\n    constructor(props: ContextProps) {\n        this._props = props;\n    }\n\n    /**\n     * \n     */\n    get props(): ContextProps { return this._props; }\n\n    /**\n     * \n     */\n    token(): string | undefined {\n        const { cursor, tokens } = this.props;\n        return cursor < tokens.length ? tokens[cursor] : undefined;\n    }\n\n    /**\n     * \n     */\n    next(): Context {\n        const { cursor, tokens } = this.props;\n        if (cursor >= tokens.length) {\n            return this;\n        } else {\n            return new Context(_.assign({}, this.props, { cursor: cursor + 1 }))\n        }\n    }\n\n    /**\n     * \n     * @param data \n     */\n    push(data: StackElement): Context {\n        const { stack } = this.props;\n        return new Context(_.assign({}, this.props, { stack: _.concat(stack, data) }));\n    }\n\n    /**\n     * \n     */\n    peek(): StackElement {\n        const { stack } = this.props;\n        return stack[stack.length - 1];\n    }\n\n    /**\n     * \n     * @param n \n     */\n    peekn(n: number): StackElement[] {\n        const { stack } = this.props;\n        return _.takeRight(stack, n);\n    }\n\n    /**\n     * \n     */\n    drop(n: number = 1): Context {\n        const { stack } = this.props;\n        return new Context(_.assign({}, this.props, { stack: _.dropRight(stack, n) }));\n    }\n}\n\n/**\n * \n * @param tokens \n */\nexport function buildParserContext(text: string): Context {\n    return new Context({\n        tokens: _.filter(text.toLowerCase().split(/[^-\\w]+/), t => t.length > 0),\n        cursor: 0,\n        stack: []\n    });\n}\n\nexport function speechToMessage(speech: string) {\n    const ctx = buildParserContext(speech);\n    try {\n        const cmd = command(ctx).peek();\n        if (isMessage(cmd)) {\n            return cmd;\n        } else {\n            return buildUnitellegibleMessage(speech, 'message-expected');\n        }\n    } catch (err: any) {\n        const error = err.message;\n        if (typeof error === 'string') {\n            const pe = error === 'word-expected' ? `${err.props.word}-exepected` : error;\n            return buildUnitellegibleMessage(speech, pe);\n        } else {\n            console.trace(err);\n            return buildUnitellegibleMessage(speech, 'unknown-error');\n        }\n    }\n}\n\n/**\n * \n */\ntype ErrorProps = {\n    word: string\n}\n\n/**\n * \n */\nclass ParserError extends Error {\n    private _ctx: Context;\n    private _props: ErrorProps | undefined;\n\n    /**\n     * \n     * @param msg \n     * @param ctx \n     * @param expr \n     */\n    constructor(msg: string, ctx: Context, props?: ErrorProps) {\n        super(msg);\n        this._ctx = ctx;\n        this._props = props;\n    }\n\n    /**\n     * \n     */\n    get context() { return this._ctx; }\n\n    /**\n     * \n     */\n    get props() { return this._props; }\n}\n\n/**\n * An experession returns the context after appliy a syntatic rules.\n * The effect of syntatic role is applyed to the cursor position and to the stack.\n * Types of Expression:\n * optional expression results the last element equal to undefined if not match otherwise a defined element poping eventualy elements\n * mandatory expression pushes elements on the stack poping eventualy elements\n */\ntype Expression = (ctx: Context) => Context;\n\n/**********************************/\n/* terminal syntactic expressions */\n/**********************************/\n\n/**\n * Mandatory expression to match end context.\n * result no changed\n * @param ctx \n */\nexport function errorIfNotEnd(ctx: Context): Context {\n    if (ctx.token()) {\n        throw new ParserError('end-expected', ctx);\n    }\n    return ctx;\n};\n\n/**\n * Mandatory expression to match end context.\n * result no changed\n * @param ctx \n */\nfunction errorIfEnd(ctx: Context): Context {\n    if (!ctx.token()) {\n        throw new ParserError('partial-command', ctx);\n    }\n    return ctx;\n};\n\n/******************+*************/\n/* terminal context expressions */\n/********************************/\n\n/**\n *  Concatenate last 2 results if any\n * @param ctx\n */\nexport function concat(ctx: Context): Context {\n    const [a, b] = ctx.peekn(2);\n    if (!isString(a)) {\n        return ctx.drop(2).push(b);\n    }\n    if (!isString(b)) {\n        return ctx.drop(2).push(a);\n    }\n    return ctx.drop(2).push(a + b);\n}\n\n/**\n *  Concatenate last 2 results if any\n * @param ctx\n */\n// function log(ctx: Context): Context {\n//     console.log(ctx);\n//     return ctx;\n// }\n\n/**\n * \n * @param ctx \n */\nfunction pushClimb(ctx: Context): Context {\n    const [flightId, atc, flightLevel] = ctx.peekn(3);\n    if (isString(flightId) && isString(atc) && isString(flightLevel)) {\n        const cmd = buildClimbCommand(flightId.toUpperCase(), atc.toUpperCase(), flightLevel, [MessageTag.VoiceMessage]);\n        return ctx.drop(3).push(cmd);\n    } else {\n        return ctx.drop(3).push(undefined);\n    }\n}\n\n/**\n * \n * @param ctx \n */\nfunction pushDescend(ctx: Context): Context {\n    const [flightId, atc, flightLevel] = ctx.peekn(3);\n    if (isString(flightId) && isString(atc) && isString(flightLevel)) {\n        const cmd = buildDescendCommand(flightId.toUpperCase(), atc.toUpperCase(), flightLevel, [MessageTag.VoiceMessage]);\n        return ctx.drop(3).push(cmd);\n    } else {\n        return ctx.drop(3).push(undefined);\n    }\n}\n\n/**\n * \n * @param ctx \n */\nfunction pushMaintain(ctx: Context): Context {\n    const [flightId, atc, flightLevel] = ctx.peekn(3);\n    if (isString(flightId) && isString(atc) && isString(flightLevel)) {\n        const cmd = buildMaintainCommand(flightId.toUpperCase(), atc.toUpperCase(), flightLevel, [MessageTag.VoiceMessage]);\n        return ctx.drop(3).push(cmd);\n    } else {\n        return ctx.drop(3).push(undefined);\n    }\n}\n\n/**\n * \n * @param ctx \n */\nfunction pushFlyTo(ctx: Context): Context {\n    const [flightId, atc, to, via] = ctx.peekn(4);\n    if (isString(flightId) && isString(atc) && isString(to)\n        && (via === undefined || isString(via))) {\n        const cmd = buildFlyToCommand(flightId.toUpperCase(), atc.toUpperCase(),\n            to.toUpperCase(), via?.toUpperCase(), [MessageTag.VoiceMessage]);\n        return ctx.drop(4).push(cmd);\n    } else {\n        return ctx.drop(4).push(undefined);\n    }\n}\n\n/**\n * \n * @param ctx \n */\nfunction pushHold(ctx: Context): Context {\n    const [flightId, atc, at] = ctx.peekn(3);\n    if (isString(flightId) && isString(atc) && (at === undefined || isString(at))) {\n        const cmd = buildHoldCommand(flightId.toUpperCase(), atc.toUpperCase(),\n            at ? at.toUpperCase() : at, [MessageTag.VoiceMessage]);\n        return ctx.drop(3).push(cmd);\n    } else {\n        return ctx.drop(3).push(undefined);\n    }\n}\n\n/**\n * \n * @param ctx \n */\nfunction pushLand(ctx: Context): Context {\n    const [flightId, atc, rwy] = ctx.peekn(3);\n    if (isString(flightId) && isString(atc) && isString(rwy)) {\n        const cmd = buildLandCommand(flightId.toUpperCase(), atc.toUpperCase(), rwy.toUpperCase(), [MessageTag.VoiceMessage]);\n        return ctx.drop(3).push(cmd);\n    } else {\n        return ctx.drop(3).push(undefined);\n    }\n}\n\n/**\n * @param ctx \n */\nfunction pushTakeoff(ctx: Context): Context {\n    const [flightId, atc, rwy, fl] = ctx.peekn(4);\n    if (isString(flightId) && isString(atc) && isString(rwy) && isString(fl)) {\n        const cmd = buildTakeoffCommand(flightId.toUpperCase(), atc.toUpperCase(),\n            rwy.toUpperCase(), fl, [MessageTag.VoiceMessage]);\n        return ctx.drop(4).push(cmd);\n    } else {\n        return ctx.drop(4).push(undefined);\n    }\n}\n\n/**\n * @param ctx \n */\nexport function nop(ctx: Context): Context {\n    return ctx;\n}\n\n/***********************************/\n/* Syntactical expression creation */\n/***********************************/\n\n/**\n * Returns the parser with word element meting regex or undefined if not match\n * Optional expression\n * @param word\n */\nexport function optRegex(regex: RegExp) {\n    return (ctx: Context) => {\n        const tok = ctx.token();\n        return tok && regex.test(tok) ?\n            ctx.next().push(tok) :\n            ctx.push(undefined);\n    }\n}\n\n/**\n * \n * @param word \n * @param expected \n */\nfunction isSimilar(word: string | undefined, expected: string) {\n    if (word) {\n        const sims = _.concat([expected], Similitudes[expected] || []);\n        return sims.indexOf(word) >= 0;\n    } else {\n        return false;\n    }\n}\n\n/**\n * Returns the parse with word in the stack and skiped if matches\n * or undefined in the stack\n * @param word \n */\nexport function optWord(word: string) {\n    return (ctx: Context) => {\n        const tok = ctx.token();\n        return isSimilar(tok, word) ?\n            ctx.next().push(word) :\n            ctx.push(undefined);\n    }\n}\n\n/**\n * Returns the parse with word in the stack and skiped if matches\n * or throws an error\n * @param word \n */\nexport function word(word: string): Expression {\n    return (ctx) => {\n        const ctx1 = errorIfEnd(ctx);\n        if (!isSimilar(ctx1.token(), word)) {\n            throw new ParserError('word-expected', ctx1, { word });\n        }\n        return ctx1.next();\n    }\n}\n\n/**\n * Skip a word \n * @param word \n */\nexport function skipWord(word: string) {\n    return (ctx: Context) => {\n        const tok = ctx.token();\n        return isSimilar(tok, word) ? ctx.next() : ctx;\n    }\n}\n/**\n * Returns the parse with mapped word in the stack and skiped if matches\n * or undefined\n * @param props \n */\nexport function optDict(props: Record<string, StackElement>) {\n    return (ctx: Context) => {\n        const tok = ctx.token();\n        if (tok) {\n            const value = props[tok];\n            if (value) {\n                return ctx.next().push(value)\n            }\n        }\n        return ctx.push(undefined);\n    };\n}\n\n/*******************************/\n/* Context expression creation */\n/*******************************/\n\n/**\n * Generate an error\n * @param msg error message\n */\nexport function error(msg: string): Expression {\n    return (ctx: Context): Context => {\n        throw new ParserError(msg, ctx);\n    }\n}\n\n/**\n * Drop elements from stack\n * @param n\n */\nexport function drop(n: number = 1): Expression {\n    return (ctx: Context): Context => ctx.drop(n);\n}\n\n/**\n * Drop elements from stack\n * @param n\n */\nfunction push(el: StackElement): Expression {\n    return (ctx: Context): Context => ctx.push(el);\n}\n\n/************************/\n/* Expression operators */\n/************************/\n\n/**\n * Applies all the list of expressions\n * Returns an expression the applies the single expressions sequentialy\n * the last expression may reduce all results of the single expressions\n * @param exprs \n */\nexport function all(...exprs: Expression[]): Expression {\n    return (ctx: Context): Context => _.reduce(exprs, (ctx1, expr) => expr(ctx1), ctx);\n}\n\n/**\n * Applies conditioning expressions by conditioning stack element\n * @param whenDef \n * @param whenUndef \n */\nexport function ifThenElse(whenDef?: Expression, whenUndef?: Expression) {\n    return (ctx: Context): Context => {\n        return ctx.peek() ?\n            (whenDef ? whenDef(ctx) : ctx) :\n            (whenUndef ? whenUndef(ctx) : ctx);\n    };\n}\n\n/**\n * Applies conditioning expressions by conditioning and consuming stack element\n * @param whenDef \n * @param whenUndef \n */\nexport function ifDropThenElse(whenDef?: Expression, whenUndef?: Expression) {\n    return (ctx: Context): Context => {\n        return ctx.peek() ?\n            (whenDef ? whenDef(ctx.drop()) : ctx) :\n            (whenUndef ? whenUndef(ctx.drop()) : ctx);\n    };\n}\n\n/**\n * Applies expression consuming until first defined result, return only the last defined result or undefined\n * @param exprs \n */\nexport function any(...exprs: Expression[]) {\n    return (ctx: Context): Context => _.reduce(exprs, (ctx1, expr) => {\n        if (ctx1.peek() !== undefined) {\n            return ctx1;\n        }\n        return expr(ctx1.drop());\n    }, ctx.push(undefined));\n}\n\n/**\n * Repeat the exp untill it returns undefined reducing the results with reducer expression\n * It processes a sequence of similar tokens accumulating the results\n * @param exp\n * @param reducer\n */\nexport function repeat(exp: Expression, reducer: Expression) {\n    return (ctx: Context): Context => {\n        var acc = ctx.push(undefined);\n        for (; ;) {\n            const ctx2 = exp(acc);\n            acc = reducer(ctx2);\n            if (ctx2.peek() === undefined) {\n                return acc;\n            }\n        }\n    };\n}\n\n/**\n * Transforms an optional expression in mandatory expression by generateing an error\n * \n * @param errorCode \n * @param expr \n */\nexport function must(errorCode: string) {\n    return all(\n        ifThenElse(\n            undefined,\n            any(\n                errorIfEnd,\n                error(errorCode)\n            )\n        )\n    );\n}\n\n/*************************************/\n/** Composed syntactical expressions */\n/*************************************/\n\n/**\n * Returns an optional sequence of numbers\n */\nexport const optNum =\n    repeat(\n        any(\n            optRegex(/^\\d*$/),\n            optDict(NumberDict)),\n        concat);\n\n/**\n * Returns an optional sequence of alphabet words\n */\nexport const optAlpha =\n    repeat(\n        optDict(AlphaDict),\n        concat);\n\n/**\n * Returns an optional sequence of alphanumeric words\n */\nexport const optAlphaNum =\n    repeat(\n        any(\n            optAlpha,\n            optNum),\n        concat);\n\n/**\n * Returns a mandatory flight id\n */\nexport const flightId = all(optAlphaNum, must('flight-id-expected'));\n\nconst beaconId = all(optAlphaNum, must('beacon-id-expected'));\n\n/**\n * Returns a mandatory atc\n */\nexport const atc =\n    all(\n        optDict({\n            london: 'lon',\n            paris: 'par',\n            munich: 'mun',\n            milan: 'mil',\n            frankfurt: 'ffm'\n        }),\n        ifThenElse(\n            word('atc')\n        ),\n        must('atc-expected')\n    );\n\nexport const flightLevel =\n    all(\n        optWord('flight'),\n        ifDropThenElse(\n            word('level'),\n            nop\n        ),\n        optNum,\n        must('flight-level-expected')\n    );\n\nconst optRunway =\n    all(\n        skipWord('runway'),\n        optNum,\n        ifThenElse(\n            all(\n                optDict(RunwaySuffixDict),\n                concat\n            )\n        )\n    );\n\nexport const runway = all(optRunway, must('runway-expected'));\n\nconst optClimb =\n    all(\n        optWord('climb'),\n        ifDropThenElse(\n            all(\n                word('to'),\n                flightLevel,\n                pushClimb\n            )\n        )\n    );\n\nconst optDescend =\n    all(\n        optWord('descend'),\n        ifDropThenElse(\n            all(\n                word('to'),\n                flightLevel,\n                pushDescend\n            )\n        )\n    );\n\nconst optMaintain =\n    all(\n        optWord('maintain'),\n        ifDropThenElse(\n            all(\n                flightLevel,\n                pushMaintain\n            )\n        )\n    );\n\nconst optFlyTo =\n    all(\n        optWord('fly'),\n        ifDropThenElse(\n            all(\n                word('to'),\n                beaconId,\n                optWord('via'),\n                ifDropThenElse(\n                    beaconId,\n                    push(undefined)\n                ),\n                pushFlyTo\n            )\n        )\n    );\n\nconst optHold =\n    all(\n        optWord('hold'),\n        ifDropThenElse(\n            all(\n                word('at'),\n                all(\n                    optWord('current'),\n                    ifDropThenElse(\n                        all(\n                            word('position'),\n                            push(undefined),\n                            pushHold\n                        ),\n                        all(\n                            beaconId,\n                            pushHold\n                        )\n                    ),\n                )\n            )\n        )\n    );\n\nconst optLand =\n    all(\n        optWord('cleared'),\n        ifDropThenElse(\n            all(\n                word('to'),\n                word('land'),\n                runway,\n                pushLand\n            )\n        )\n    );\n\nconst optTakeoff =\n    all(\n        optRunway,\n        ifThenElse(\n            all(\n                word('cleared'),\n                word('to'),\n                any(\n                    all(\n                        optWord('take'),\n                        ifThenElse(\n                            word('off')\n                        )\n                    ),\n                    all(\n                        word('takeoff'),\n                        push(undefined)\n                    )\n                ),\n                drop(),\n                word('climb'),\n                word('to'),\n                flightLevel,\n                pushTakeoff\n            )\n        )\n    );\n/**\n * Returns the command\n */\nexport const command =\n    all(\n        flightId,\n        atc,\n        any(\n            optClimb,\n            optDescend,\n            optMaintain,\n            optFlyTo,\n            optHold,\n            optLand,\n            optTakeoff\n        ),\n        must('command-expected'),\n        errorIfNotEnd\n    );\n","import React, { Component } from 'react';\nimport { Col, Container, Row } from 'react-bootstrap';\nimport { useParams } from 'react-router-dom';\nimport { sessionDao } from './SessionDao';\nimport { CommandPane } from './CommandPane';\nimport { mapDao } from './MapDao';\nimport { flatMap, map, tap } from 'rxjs/operators';\nimport '../App.css';\nimport { interval, Observable, of } from 'rxjs';\nimport { levelDao } from './LevelDao';\nimport { cockpitLogger, CockpitLogger } from './CockpitLogger';\nimport _ from 'lodash';\nimport { buildSimulator, DefaultSimProps } from './TrafficSimulator';\nimport { RadarPane } from './RadarPane';\nimport { ATCNavBar } from './ATCNavbar';\nimport { Session } from './Session';\nimport { Level } from './Level';\nimport { AreaMap, FlightMap } from './Map';\nimport { andMsgOp, CommandMessage, isCommand, isSpeechError, isVoice, Message, MessageTag, tagMsgOp } from './Message';\nimport { OptionsPane } from './OptionPane';\nimport { InfoPane } from './InfoPane';\nimport { AudioBuilder, TextBuilder } from './MessageConverters';\nimport { synthVoices } from './Audio';\nimport { AudioDialog } from './AudioDialog';\nimport { SpeechPane } from './SpeechPane';\nimport { speechToMessage } from './CommandInterpreter';\n\nconst ClockInterval = 400;\nconst RadarInterval = 4;\nconst SIM_INTERVAL = 1;\n\nconst muteMessage = andMsgOp([isVoice, tagMsgOp(MessageTag.Command)]);\n/**\n * \n */\nclass SessionPane1 extends Component<{\n  readonly sessionId: string;\n}, Readonly<{\n  session?: Session;\n  level?: Level;\n  map?: AreaMap;\n  nodeMap?: FlightMap;\n  logger: CockpitLogger;\n  listenEnabled: boolean;\n  muted: boolean;\n  speed: number;\n  ts: number;\n  flightVoices: string[];\n  audioDialog?: AudioDialog<Message>;\n  listening: boolean;\n  speech: string;\n}>> {\n  private clock: Observable<number>;\n\n  /**\n   * \n   * @param {*} props \n   */\n  constructor(props: {\n    readonly sessionId: string;\n  }) {\n    super(props);\n    const logger = cockpitLogger();\n    this.state = {\n      logger,\n      muted: false,\n      listenEnabled: true,\n      speed: 10,\n      ts: 0,\n      flightVoices: [],\n      listening: false,\n      speech: ''\n    };\n    this.clock = interval(ClockInterval);\n    _.bindAll(this, [\n      'handleClock', 'handleCommand', 'handleListenEnabled',\n      'handleMuted', 'handleSpeed', 'handleMessages'\n    ]);\n  }\n\n  /**\n   *\n   */\n  componentDidMount() {\n    const self = this;\n\n    const audioDialog = new AudioDialog<Message>({\n      polling: 100,\n      parseSpeech: speechToMessage,\n      isCompleted: m => !(isSpeechError(m) && m.parserError === 'partial-command'),\n      onRecognized: speech => self.handleSpeechMessage(speech),\n      onSpeech: speech => self.setState({ speech }),\n      onListening: listening => self.handleListening(listening)\n    });\n    audioDialog.listenEnabled = this.state.listenEnabled;\n    this.setState({ audioDialog });\n\n    sessionDao.getSession(this.props.sessionId).pipe(\n      flatMap(session => {\n        if (!session) {\n          return of({});\n        }\n        return levelDao.level(session.level).pipe(\n          flatMap(level =>\n            mapDao.getMap((session).map).pipe(\n              flatMap(map1 =>\n                synthVoices().pipe(\n                  map(voices => {\n                    const indices = _.range(0, voices.length).map(i => i.toString());\n                    const atcVoice = session.atcVoice;\n                    const nodeMap = mapDao.coords(map1.nodes, map1.center);\n                    const flightVoices1 = _.reject(indices, i => i === atcVoice);\n                    const flightVoices = flightVoices1.length > 0 ? flightVoices1\n                      : atcVoice ? [atcVoice]\n                        : [];\n                    return { session, map: map1, nodeMap, level, flightVoices };\n                  })\n                )\n              )\n            )\n          )\n        );\n      }),\n      tap(data => { self.setState(data) })\n    ).subscribe();\n\n    this.clock.pipe(\n      tap(this.handleClock)\n    ).subscribe()\n\n  }\n\n  /**\n   * \n   * @param listening \n   */\n  private handleListening(listening: boolean) {\n    this.setState({ listening });\n  }\n\n  /**\n   *\n   * @param {*} cmd\n   */\n  private handleCommand(cmd: CommandMessage) {\n    const { session, map, level, flightVoices } = this.state;\n    if (session && map && level) {\n      const sim = buildSimulator(session, {\n        map, level, flightVoices\n      });\n      const next = sim.processCommand(cmd);\n      const newSession = sessionDao.putSession(next.session);\n      this.handleMessages([cmd]);\n      this.handleMessages(next.messages);\n      this.setState({ session: newSession });\n    }\n  }\n\n  /**\n   *\n   * @param t\n   */\n  private handleClock(t: number) {\n    const { session, map, level, speed, ts, flightVoices } = this.state;\n    if (session && map && level) {\n      const ts1 = ts + ClockInterval * speed / 1000;\n      if (ts1 >= RadarInterval) {\n        var sess = session;\n        for (var ts2 = ts1; ts2 >= SIM_INTERVAL; ts2 -= SIM_INTERVAL) {\n          const sim = buildSimulator(sess, {\n            map, level, dt: SIM_INTERVAL, flightVoices\n          }).transition();\n          this.handleMessages(sim.messages);\n          sess = sim.session;\n        }\n        this.setState({ session: sessionDao.putSession(sess), ts: ts2 });\n      } else {\n        this.setState({ ts: ts1 });\n      }\n    }\n  }\n\n  /**\n   * \n   * @param messages \n   */\n  private handleMessages(messages: Message[]) {\n    const { map, logger, session, muted, audioDialog } = this.state;\n    if (map && messages.length > 0 && session) {\n      const texts = messages.map(m => new TextBuilder(m, map).build());\n      logger.putMessages(texts);\n      texts.forEach(txt => console.log(txt.text));\n      if (!muted) {\n        const clips = _(messages)\n          .reject(muteMessage)\n          .map(m => new AudioBuilder(m, map, session).build())\n          .value();\n        if (audioDialog) {\n          audioDialog.say(clips);\n        }\n      }\n    }\n  }\n\n  /**\n   *\n   */\n  private handleMuted() {\n    const muted = !this.state.muted;\n    if (muted && window.speechSynthesis) {\n      window.speechSynthesis.cancel();\n    }\n    this.setState({ muted });\n  }\n\n  /**\n   *\n   */\n  private handleListenEnabled() {\n    const { audioDialog } = this.state;\n    const listenEnabled = !this.state.listenEnabled;\n    if (audioDialog) {\n      audioDialog.listenEnabled = listenEnabled;\n    }\n    this.setState({ listenEnabled });\n  }\n\n  /**\n   *\n   * @param {*} ev\n   */\n  private handleSpeed(speed: number) {\n    this.setState({ speed });\n  }\n\n  private handleSpeechMessage(msg: Message) {\n    console.log(msg);\n    if (isCommand(msg)) {\n      this.handleCommand(msg)\n    } else {\n      this.handleMessages([msg]);\n    }\n  }\n\n  /**\n   *\n   */\n  render() {\n    const { session, map, nodeMap, level, logger, muted, listenEnabled,\n      speed, listening, speech } = this.state;\n    if (!nodeMap || !session || !map || !level) {\n      return (<div></div>);\n    } else {\n      return (\n        <Container fluid>\n          <ATCNavBar session={session} />\n          <Container fluid className=\"ATC\">\n            <Row>\n              <Col xs={2}>\n                <InfoPane session={session} logger={logger} />\n              </Col>\n              <Col><RadarPane\n                session={session}\n                nodeMap={nodeMap}\n                map={map}\n                collisionDistance={DefaultSimProps.collisionDistance} />\n                <SpeechPane listening={listening} speech={speech} />\n              </Col>\n              <Col xs={2}>\n                <CommandPane session={session} map={map}\n                  onCommand={this.handleCommand} />\n                <OptionsPane\n                  speed={speed}\n                  onSpeed={this.handleSpeed}\n                  muted={muted}\n                  onMuted={this.handleMuted}\n                  listeningEnabled={listenEnabled}\n                  onListeningEnabled={this.handleListenEnabled} />\n              </Col>\n            </Row>\n          </Container>\n        </Container >\n      );\n    }\n  }\n}\n\n/**\n * \n */\nexport function SessionPane(): JSX.Element {\n  const { id } = useParams<{ id: string }>();\n  return (\n    <SessionPane1 sessionId={id} />\n  );\n}\n","import React, { Component } from 'react';\nimport { Card, Col, Container, Form, Row } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { synthSay } from './Audio';\n// import grammar from './SpeachGrammar.jsx';\n// const SpeechGrammarList = window.SpeechGrammarList || window.webkitSpeechGrammarList\n// const SpeechRecognitionEvent = window.SpeechRecognitionEvent || window.webkitSpeechRecognitionEvent\n\nconst createRecogn: (arg: {\n    onresult?: (ev: SpeechRecognitionEvent) => void,\n    onnomatch?: (ev: SpeechRecognitionEvent) => void,\n    onend?: (ev: Event) => void\n    onerror?: (ev: Event) => void\n    ondefault?: (ev: Event) => void\n}) => SpeechRecognition | undefined\n    // = ({  }) => {\n    = ({ ondefault = null, onresult = null, onend = null, onnomatch = null, onerror = null }) => {\n        const SpeechRecognition: (new () => SpeechRecognition) | undefined = window.SpeechRecognition || (window as any).webkitSpeechRecognition;\n        console.log('create recogn', SpeechRecognition);\n        if (!!SpeechRecognition) {\n            const recognition = new SpeechRecognition();\n            // const speechRecognitionList = new SpeechGrammarList();\n            // speechRecognitionList.addFromString(grammar, 1);\n            // recognition.grammars = speechRecognitionList;\n            recognition.continuous = false;\n            recognition.lang = 'en';\n            recognition.interimResults = false;\n            recognition.maxAlternatives = 1;\n\n            recognition.onresult = onresult || ondefault;\n            recognition.onspeechend = ondefault;\n            recognition.onnomatch = onnomatch || ondefault\n            recognition.onerror = onerror || ondefault;\n            recognition.onstart = ondefault;\n            recognition.onaudiostart = ondefault;\n            recognition.onsoundstart = ondefault;\n            recognition.onspeechstart = ondefault;\n            recognition.onspeechend = ondefault;\n            recognition.onsoundend = ondefault;\n            recognition.onaudioend = ondefault;\n            recognition.onend = onend || ondefault;\n            console.log('create recogn', recognition);\n            return recognition;\n        } else {\n            return undefined;\n        }\n    }\n\n/**\n * \n */\nclass SpeechRecogn extends Component<{}, Readonly<{\n    cmd?: string;\n    error?: string;\n    event?: Event;\n}>> {\n    private _recognition?: SpeechRecognition;\n\n    /**\n     * \n     * @param props \n     */\n    constructor(props = {}) {\n        super(props);\n        this.state = {};\n        _.bindAll(this, [\n            'handleResult', 'listen'\n        ]);\n\n        const self = this;\n        const errorHandler = (event: any) => {\n            console.log(event);\n            const error = event.error;\n            self.setState({ error })\n        }\n        this._recognition = createRecogn({\n            onresult: self.handleResult,\n            onend: (event: Event) => {\n                console.log(event);\n                const r = self.recognition;\n                if (r) {\n                    r.start();\n                }\n            },\n            onnomatch: (event: SpeechRecognitionEvent) => {\n                console.log(event);\n                const error = 'No match';\n                self.setState({ error })\n            },\n            onerror: errorHandler,\n            ondefault: (event: any) => {\n                console.log(event);\n                self.setState({ event });\n            },\n        });\n    }\n\n    get recognition() { return this._recognition; }\n\n    componentDidMount() {\n        this.listen();\n    }\n\n    listen() {\n        const rec = this._recognition;\n        if (rec) {\n            rec.start();\n        }\n        this.setState({ error: undefined });\n    }\n\n    /**\n     * \n     * @param event \n     */\n    handleResult(event: SpeechRecognitionEvent) {\n        console.log(event);\n        const cmd = event.results[0][0].transcript;\n        synthSay(['3 ' + cmd]).subscribe();\n        this.setState({ cmd });\n    }\n\n    render() {\n        const { cmd, error, event = {} } = this.state;\n        return (\n            <Container>\n                <Card>\n                    <Card.Header>\n                        Speach Recognition Test\n                    </Card.Header>\n                    <Card.Body>\n                        <Form>\n                            <Form.Group as={Row} controlId=\"status\" >\n                                <Form.Label column sm=\"2\">\n                                    Status\n                                </Form.Label>\n                                <Col sm=\"10\">\n                                    <Form.Control plaintext readOnly defaultValue=\"\" value={(event as any).type} />\n                                </Col>\n                            </Form.Group>\n\n                            <Form.Group as={Row} controlId=\"Error\">\n                                <Form.Label column sm=\"2\">\n                                    Errors\n                                </Form.Label>\n                                <Col sm=\"10\">\n                                    <Form.Control plaintext readOnly defaultValue=\"\" value={error} />\n                                </Col>\n                            </Form.Group>\n\n                            <Form.Group as={Row} controlId=\"Text\">\n                                <Form.Label column sm=\"2\">\n                                    Text\n                                </Form.Label>\n                                <Col sm=\"10\">\n                                    <Form.Control plaintext readOnly defaultValue=\"\" value={cmd} />\n                                </Col>\n                            </Form.Group>\n                        </Form>\n                    </Card.Body>\n                </Card>\n            </Container>\n        );\n    }\n}\n\nexport default SpeechRecogn;\n","import React, { Component } from 'react';\nimport { Alert, Card, Col, Container, Form, FormGroup, Row } from 'react-bootstrap';\nimport _ from 'lodash';\nimport { synthVoices } from './Audio';\nimport { tap } from 'rxjs/operators';\nimport { AudioDialog } from './AudioDialog';\n\nexport class DialogTest extends Component<{}, Readonly<{\n    voice: string;\n    voices: SpeechSynthesisVoice[];\n    errors: string[];\n    speech?: string;\n    listening: boolean;\n    audioDialog?: AudioDialog<string>;\n}>> {\n    constructor(props: {}) {\n        super(props);\n        this.state = {\n            voice: '0',\n            voices: [],\n            errors: [],\n            listening: false\n        };\n        _.bindAll(this, [\n            'handleCloseAlert', 'handleVoice'\n        ]);\n    }\n\n    componentDidMount() {\n        const self = this;\n        synthVoices().pipe(\n            tap(voices => self.setState({ voices }))\n        ).subscribe();\n        const audioDialog = new AudioDialog<string>({\n            polling: 100,\n            parseSpeech: s => s,\n            isCompleted: s => s !== '',\n            onSpeech: speech => self.handleSpeech(speech),\n            onListening: listening => {\n                console.log(listening);\n                self.setState({ listening });\n            }\n        });\n        this.setState({ audioDialog });\n    }\n\n    handleSpeech(speech: string) {\n        const { audioDialog, voice } = this.state;\n        if (audioDialog) {\n            console.log(speech);\n            audioDialog.say([voice + ' ' + speech]);\n        }\n        this.setState({ speech })\n    }\n\n    handleVoice(voice: string) {\n        this.setState({ voice });\n    }\n\n    handleCloseAlert(i: number) {\n        const { errors } = this.state;\n        errors.splice(i, 1);\n        this.setState({ errors });\n    }\n\n    render() {\n        const { voice, errors, voices, speech, listening } = this.state;\n        console.log(listening);\n        return (\n            <Container>\n                <Card>\n                    <Card.Header>\n                        Audio test\n                    </Card.Header>\n                    <Card.Body>\n                        {\n                            errors.map((error, i) => (\n                                <Alert\n                                    key={i}\n                                    variant=\"danger\" dismissible\n                                    show={!!error}\n                                    onClose={() => this.handleCloseAlert(i)}>\n                                    {error}\n                                </Alert>\n                            ))\n                        }\n                        <Form>\n                            <FormGroup controlId=\"voiceInput\">\n                                <Form.Label>Voice</Form.Label>\n                                <Form.Control as=\"select\" value={voice}\n                                    onChange={ev => this.handleVoice(ev.target.value)} >\n                                    {voices.map((voice, i) => (\n                                        <option key={i} value={i}>{voice.name}</option>\n                                    ))}\n                                </Form.Control>\n                            </FormGroup>\n                            <Form.Group as={Row} controlId=\"Text\">\n                                <Form.Label column sm=\"2\">\n                                    Text\n                                </Form.Label>\n                                <Col sm=\"10\">\n                                    <Form.Control plaintext readOnly defaultValue={speech} />\n                                </Col>\n                            </Form.Group>\n                            <Form.Group as={Row} controlId=\"Text\">\n                                <Form.Label column sm=\"2\">\n                                    Text\n                                </Form.Label>\n                                <Col sm=\"10\">\n                                    <Form.Control plaintext readOnly defaultValue={\n                                        listening ?\n                                            'Listening ...' :\n                                            ''} />\n                                </Col>\n                            </Form.Group>\n                        </Form>\n                    </Card.Body>\n                </Card>\n            </Container>\n        );\n    }\n}\n","import React from 'react';\nimport 'bootstrap/dist/css/bootstrap.min.css';\nimport Home from './modules/Home';\nimport { HashRouter as Router, Route, Switch } from 'react-router-dom';\nimport { SessionPane } from './modules/SessionPane';\nimport { ToastContainer } from 'react-toastify';\nimport 'react-toastify/dist/ReactToastify.css';\nimport SpeechRecogn from './modules/SpeechRecogn';\nimport { DialogTest } from './modules/DialogTest';\n\nfunction App() {\n  return (\n    <Router basename=\".\">\n      <div>\n        <ToastContainer\n          position=\"bottom-left\"\n          autoClose={5000}\n          hideProgressBar\n          pauseOnFocusLoss\n          pauseOnHover />\n        <Switch>\n          <Route exact path=\"/\">\n            <Home />\n          </Route>\n          <Route exact path=\"/dialog\">\n            <DialogTest />\n          </Route>\n          <Route exact path=\"/speach\">\n            <SpeechRecogn />\n          </Route>\n          <Route path=\"/sessions/:id\" >\n            <SessionPane />\n          </Route>\n          <Route path=\"*\">\n            <NoMatch />\n          </Route>\n        </Switch>\n      </div>\n    </Router>\n  );\n}\n\nfunction NoMatch() {\n  return (\n    <div>\n      No Match\n    </div>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}