(this.webpackJsonpatc=this.webpackJsonpatc||[]).push([[0],{108:function(e,t,n){e.exports=n(131)},113:function(e,t,n){},131:function(e,t,n){"use strict";n.r(t);var a,r=n(0),i=n.n(r),o=n(37),s=n.n(o),l=(n(113),n(114),n(9)),c=n(10),u=n(18),d=n(20),h=n(21),p=n(138),f=n(141),g=n(142),m=n(102),v=n(143),y=n(144),b=n(145),k=n(146),w=n(2),E=n.n(w),$=n(163),M=n(67),O=n(159),C=n(160),T=n(96),j=n(135),F=n(81),x=n(48),A={type:"object",properties:{lat:{type:"number"},lon:{type:"number"}},required:["lat","lon"]};!function(e){e.Beacon="beacon",e.Entry="entry",e.OuterMarker="om",e.Runway="runway"}(a||(a={}));var L,S={type:"string",enum:Object.values(a)};!function(e){e.N="N",e.NE="NE",e.E="E",e.SE="SE",e.S="S",e.SW="SW",e.W="W",e.NW="NW"}(L||(L={}));var V,H={anyOf:[{allOf:[A,{type:"object",properties:{id:{type:"string"},type:S,alignment:{type:"string",enum:Object.values(L)}},required:["id","type","alignment"]}]},{allOf:[A,{type:"object",properties:{hdg:{type:"integer"}},required:["hdg"]}]}]};!function(e){e.Connection="connection",e.Entry="entry",e.Land="land",e.LandConnection="landConnection",e.Takeoff="takeoff"}(V||(V={}));var _={type:"object",properties:{maps:{type:"object",additionalProperties:{type:"object",properties:{id:{type:"string"},name:{type:"string"},descr:{type:"string"},center:A,nodes:{type:"object",additionalProperties:H},routes:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:Object.values(V)},edges:{type:"array",items:[{type:"string"}],minItems:2,maxItems:2}},required:["type","edges"]}}},required:["id","name","descr","center","nodes","routes"]}}},required:["maps"]};function N(e){return e.type===a.Runway}var R,D=Math.PI/180,I=180/Math.PI,z=60/D,B=new(function(){function e(){Object(l.a)(this,e),this._subj=void 0,this._subj=new j.a,$.a.getJSON("/atc/data/maps.json").pipe(Object(M.a)((function(e){return t=e,(new x.Validator).validate(t,_,{throwError:!0}),t;var t})),Object(O.a)(void 0,(function(e){console.error(e)}))).subscribe(this._subj)}return Object(c.a)(e,[{key:"getMaps",value:function(){return this._subj}},{key:"getMap",value:function(e){return this.getMaps().pipe(Object(C.a)((function(e){return Object(F.a)(E.a.values(e.maps))})),Object(T.a)((function(t){return t.id===e})))}},{key:"versor",value:function(e){var t=e.lat,n=e.lon,a=t*D,r=n*D,i=Math.sin(a),o=Math.cos(a);return[o*Math.sin(r),o*Math.cos(r),i]}},{key:"distance",value:function(e,t){var n=this.versor(t),a=this.versor(e),r=n[0]*a[0]+n[1]*a[1]+n[2]*a[2];return Math.acos(Math.min(Math.max(-1,r),1))*z}},{key:"dLon",value:function(e,t){var n=e.lon-t.lon;return n>=180&&(n-=360),n<-180&&(n+=360),n}},{key:"xy",value:function(e,t){return[60*this.dLon(e,t)*Math.cos(e.lat*D),60*(e.lat-t.lat)]}},{key:"hdgSingle",value:function(e,t){var n=this.xy(e,t);return Math.atan2(n[0],n[1])*I}},{key:"hdg",value:function(e,t){var n=this.normAngle(this.hdgSingle(e,t)),a=this.normAngle(this.hdgSingle(t,e)+180),r=this.normHdg(Math.round(n+this.normAngle((a-n)/2)));return r}},{key:"normHdg",value:function(e){return e>360?e-360:e<=0?e+360:e}},{key:"normAngle",value:function(e){return e>=180?e-360:e<-180?e+360:e}},{key:"route",value:function(e,t,n){void 0===n&&(n=e.hdg);var a=this.hdg(t,e),r=this.distance(e,t),i=this.normAngle(Math.round(a-n));return{hdg:a,d:r,angle:i,from:i>90||i<-90,to:i<90&&i>-90}}},{key:"radial",value:function(e,t,n){var a=e.lat,r=e.lon,i=t*D;return{lat:a+n*Math.cos(i)/60,lon:r+n*Math.sin(i)/Math.cos(a*D)/60}}},{key:"coords",value:function(e,t){var n=this,a=E()(e).mapValues((function(e){return{node:e,coords:n.xy(e,t)}})),r=a.map((function(e){return e.coords[0]})),i=a.map((function(e){return e.coords[1]})),o=E()(e).values().map((function(e){return n.distance(t,e)})).max()||0;return{nodes:a.value(),xmin:r.min()||0,xmax:r.max()||0,ymin:i.min()||0,ymax:i.max()||0,range:o}}}]),e}()),W=n(136),Y=n(51),P=n(137),X=n(151);!function(e){e.Jet="J",e.Airplane="A"}(R||(R={}));var U,K={type:"string",enum:Object.values(R)};!function(e){e.WaitingForTakeoff="waiting-for-takeoff",e.Flying="flying",e.FlyingTo="flying-to",e.Turning="turning",e.Approaching="approaching",e.Aligning="aligning",e.Landing="landing",e.HoldingFromAt="holding-from-at",e.HoldingToAt="holding-to-at",e.HoldingFrom="holding-from",e.HoldingTo="holding-to",e.Landed="landed",e.Exited="exited"}(U||(U={}));var J={type:"object",properties:{id:{type:"string"},type:K,status:{type:"string",enum:Object.values(U)},speed:{type:"integer"},alt:{type:"integer"},toAlt:{type:"integer"},to:{type:"string"},from:{type:"string"},rwy:{type:"string"},at:{type:"string"},turnTo:{type:"string"},loopTimer:{type:"number"},holdHdg:{type:"integer"},fix:A,right:{type:"boolean"},exit:{type:"string"},voice:{type:"string"}},required:["id","type","status","speed","alt","toAlt","to","from"]};var G={type:"object",properties:{id:{type:"string"},version:{type:"string",const:"1.1"},level:{type:"string"},map:{type:"string"},t:{type:"number"},noFlights:{type:"integer"},noLandedOk:{type:"integer"},noLandedKo:{type:"integer"},noExitOk:{type:"integer"},noExitKo:{type:"integer"},noCollision:{type:"integer"},entries:{type:"object",additionalProperties:{type:"number"}},flights:{type:"object",additionalProperties:J},atcVoice:{type:"string"}},required:["id","version","level","map","t","noFlights","noLandedOk","noLandedKo","noExitOk","noCollision","entries","flights"]};var q="atc.session";function Z(){var e,t=localStorage.getItem(q);if(null!==t)try{return e=JSON.parse(t),(new x.Validator).validate(e,G,{throwError:!0}),e}catch(n){throw console.log(n),n}}var Q=new(function(){function e(){Object(l.a)(this,e)}return Object(c.a)(e,[{key:"getSession",value:function(e){return this.getSessions().pipe(Object(T.a)((function(t){return!!t&&t.id===e})))}},{key:"getSessions",value:function(){return Object(W.a)((function(){try{var e=Z();return e?Object(P.a)(e):Y.a}catch(t){return Y.a}}))}},{key:"putSession",value:function(e){return localStorage.setItem(q,JSON.stringify(e)),e}},{key:"create",value:function(e,t,n){var a={id:Object(X.a)(),version:"1.1",level:e,map:t,t:0,entries:{},flights:{},noFlights:0,noLandedOk:0,noLandedKo:0,noExitOk:0,noExitKo:0,noCollision:0,atcVoice:n};return this.putSession(a)}}]),e}()),ee=new(function(){function e(){Object(l.a)(this,e),this._subj=void 0,this._subj=new j.a,$.a.getJSON("/atc/data/levels.json").pipe(Object(O.a)(void 0,(function(e){console.error(e)}))).subscribe(this._subj)}return Object(c.a)(e,[{key:"levels",value:function(){return this._subj}},{key:"level",value:function(e){return this.levels().pipe(Object(M.a)((function(t){return E.a.find(t.levels,{id:e})})))}}]),e}()),te=n(153),ne=n(161),ae=n(162),re=function(e){var t=e.value,n=e.values,a=void 0===n?[]:n,r=e.onSelect,o=function(e){return function(){r&&r(e)}};return i.a.createElement(ne.a,{style:{width:"18rem"}},i.a.createElement(ne.a.Header,null,"Game Level"),i.a.createElement(ae.a,{variant:"flush"},E.a.map(a,(function(e){return i.a.createElement(ae.a.Item,{action:!0,key:e.id,active:!!t&&t===e.id,eventKey:e.id,onClick:o(e.id)},e.name)}))))},ie=function(e){var t=e.value,n=e.values,a=void 0===n?[]:n,r=e.onSelect,o=function(e){return function(){r&&r(e)}};return i.a.createElement(ne.a,{style:{width:"18rem"}},i.a.createElement(ne.a.Header,null,"Map"),i.a.createElement(ae.a,{variant:"flush"},E.a.map(a,(function(e){return i.a.createElement(ae.a.Item,{key:e.id,eventKey:e.id,active:t===e.id,action:!0,onClick:o(e.id)},e.descr)}))))},oe=n(152),se=n(139),le=n(156),ce=n(11),ue=function(e){var t=e.session,n=void 0;if(t){var a=t,r=a.noFlights,o=a.noLandedOk,s=a.noLandedKo,l=a.noExitKo,c=a.noExitOk,u=a.noCollision,d=a.t,h=d?3600*(o+c)/d:0,f=r?(l+s)/r*100:0,g=r?u/r*100:0;n=i.a.createElement(p.a,{fluid:!0},i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"info",pill:!0},"Inbound: ",Object(ce.sprintf)("%d",r)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"success",pill:!0},"Success: ",Object(ce.sprintf)("%.1f fph",h)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"warning",pill:!0},"Wrong: ",Object(ce.sprintf)("%.0f%%",f)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"danger",pill:!0},"Collision: ",Object(ce.sprintf)("%.0f%%",g)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"success"},"Right landed: ",Object(ce.sprintf)("%d",o)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"success"},"Right left: ",Object(ce.sprintf)("%d",c)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"warning"},"Wrong landed: ",Object(ce.sprintf)("%d",s)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"warning"},"Wrong left: ",Object(ce.sprintf)("%d",l)))),i.a.createElement(m.a,null,i.a.createElement("span",null,i.a.createElement(se.a,{variant:"danger"},"Collisions: ",Object(ce.sprintf)("%d",u)))))}else n=i.a.createElement(oe.a.Text,null);return i.a.createElement(oe.a,{collapseOnSelect:!0,expand:"lg",bg:"dark",variant:"dark"},i.a.createElement(oe.a.Brand,{href:"http://www.mmarini.org"},"www.mmarini.org"),i.a.createElement(oe.a.Toggle,{"aria-controls":"responsive-navbar-nav"}),i.a.createElement(oe.a.Collapse,{id:"responsive-navbar-nav"},i.a.createElement(le.a,{className:"mr-auto"},i.a.createElement(le.a.Link,{href:"/atc"},"ATC ","0.9.3")),i.a.createElement(oe.a.Text,null)),i.a.createElement(le.a,{className:"mr-auto"},n))},de=n(150),he=(n(140),n(103)),pe=n(157);function fe(){return me().pipe(Object(M.a)((function(e){return e.voices})))}var ge=new j.a;function me(){return ge.asObservable()}function ve(e){return me().pipe(Object(O.a)((function(t){var n=t.synth,a=t.voices;e.forEach((function(e){var t=/(\d+)\b(.*)/.exec(e);if(null!=t&&3===t.length){var r=a[parseInt(t[1])],i=t[2];if(r){var o=new SpeechSynthesisUtterance(i);o.voice=r,n.speak(o)}}}))})))}Object(de.a)(100).pipe(Object(he.a)(100),Object(M.a)((function(){return function(){var e,t=window.speechSynthesis;return{synth:t,voices:t?(e=t.getVoices(),e.filter((function(e){return e.lang.toLowerCase().startsWith("en")}))):[]}}()})),Object(T.a)((function(e){return e.voices.length>0})),Object(pe.a)()).subscribe(ge);var ye,be,ke,we,Ee,$e=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e)).state={},E.a.bindAll(Object(u.a)(a),["handleLevel","handleMap","handleStart","handleLoad"]),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this;B.getMaps().pipe(Object(O.a)((function(t){e.setState({maps:t,map:"LON"})}))).subscribe(),ee.levels().pipe(Object(O.a)((function(t){e.setState({levels:t,level:t.levels[0].id})}))).subscribe(),Q.getSessions().pipe(Object(te.a)(),Object(O.a)((function(t){e.setState({sessions:t})}))).subscribe()}},{key:"handleStart",value:function(){var e=this.state,t=e.level,n=void 0===t?"":t,a=e.map,r=void 0===a?"":a;fe().pipe(Object(O.a)((function(e){var t=e.length>0?Math.floor(Math.random()*e.length).toString():void 0,a=Q.create(n,r,t);window.location.href="/atc#/sessions/"+a.id}))).subscribe()}},{key:"handleLoad",value:function(){var e=this.state.sessions;e&&(window.location.href="/atc#/sessions/"+e[0].id)}},{key:"handleLevel",value:function(e){this.setState({level:e})}},{key:"handleMap",value:function(e){this.setState({map:e})}},{key:"render",value:function(){var e=this.state,t=e.levels,n=void 0===t?{levels:[]}:t,a=e.level,r=e.maps,o=void 0===r?{maps:{}}:r,s=e.map,l=e.sessions;return i.a.createElement(p.a,{fluid:!0},i.a.createElement(ue,null),i.a.createElement(p.a,null,i.a.createElement(f.a,null,i.a.createElement("h1",null,"ATC"),i.a.createElement(p.a,null,i.a.createElement(g.a,null,i.a.createElement(m.a,null,i.a.createElement(v.a,null,i.a.createElement(re,{value:a,values:n.levels,onSelect:this.handleLevel}),i.a.createElement(ie,{value:s,values:E.a.values(o.maps),onSelect:this.handleMap})))),i.a.createElement(g.a,null,i.a.createElement(m.a,null,i.a.createElement(y.a,{"aria-label":"Buttons"},i.a.createElement(b.a,{className:"mr-2","aria-label":"Start"},i.a.createElement(k.a,{onClick:this.handleStart},"Start")),i.a.createElement(b.a,{className:"mr-2","aria-label":"Load"},i.a.createElement(k.a,{disabled:!l||0===l.length,onClick:this.handleLoad},"Load last game"))))))),i.a.createElement("p",null,"Your goal is to route safely the planes in your area."),i.a.createElement("p",null,"You need to:"),i.a.createElement("ul",null,i.a.createElement("li",null,"take off planes waiting at runways"),i.a.createElement("li",null,"land the planes at destination runways"),i.a.createElement("li",null,"fly the planes via the leaving beacons at altitude of 36000 feet.")),i.a.createElement("p",null,"You must avoid:"),i.a.createElement("ul",null,i.a.createElement("li",null,"planes collinsion, the collision happend when the distance between two planes are lower then 4 nautic miles and the altitude difference is lower then 1000 feet"),i.a.createElement("li",null,"leaving to a wrong beacons"),i.a.createElement("li",null,"landing to a wrong runway")),i.a.createElement("p",null,"You can zoom the map using the mouse wheel and shift key or move the map by dragging it with the left mouse button"),i.a.createElement("p",null,"A click with the center mouse button fits the map to the viewport.")))}}]),n}(r.Component),Me=n(88),Oe=n(14);function Ce(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return E.a.findIndex(t,(function(t){return t(e)}))>=0}}function Te(e){return function(t){return t.tags.indexOf(e)>=0}}function je(e){return function(e){return Te(ye.Error)(e)}(e)&&void 0!==e.parserError}!function(e){e.Command="command",e.Confirmation="confirmation",e.Error="error",e.FlightReport="flight-report",e.Negative="negative",e.Readback="readback",e.VoiceMessage="voice"}(ye||(ye={})),function(e){e.ClearedToLand="cleared-to-land",e.ClearedToTakeoff="cleared-to-takeoff",e.Climb="climb",e.Descend="descend",e.FlyTo="fly-to",e.FlyToVia="fly-to-via",e.Maintain="maintain",e.HoldAt="hold-at",e.HoldCurrentPosition="hold-current-position",e.HoldShort="hold-short"}(be||(be={})),function(e){e.Collision="collision",e.EnterTo="enter-to",e.EnterLeave="enter-leave",e.FlyingTo="flying-to",e.GoingAroundMissingApproach="going-around-missing-approach",e.GoingAroundMissingRunway="going-around-missing-runway",e.Leaving="leaving",e.LeavingMissingDearture="leaving-missing-departure",e.LeavingOutOfArea="leaving-out-of-area",e.PassingFlightLevel="passing-flight-level",e.ReadyToDepartureTo="ready-to-departure-to",e.ReadyToDepartureLeave="ready-to-departure-leave",e.RunwayVacated="runway-vacated",e.WrongRunwayVacated="wrong-runway-vacated"}(ke||(ke={})),function(e){e.ClearedTo="cleared-to",e.ClearedToLeave="cleared-to-leave",e.GoodDay="good-day",e.Roger="roger"}(we||(we={})),function(e){e.ATCNotFound="atc-not-found",e.BeaconNotFound="beacon-not-found",e.FlightAtGround="flight-at-ground",e.FlightNotAtGround="flight-not-at-ground",e.FlightNotFound="flight-not-found",e.FlightTooHigh="flight-too-high",e.InvalidFlightLevel="invalid-flight-level",e.InvalidRunway="invalid-runway",e.RunwayNotFound="runway-not-found",e.RunwayTooDistant="runway-too-distant",e.Unitellegible="unintelligible"}(Ee||(Ee={}));var Fe,xe=Te(ye.VoiceMessage);function Ae(e,t,n,a){return{from:t,tags:E.a.concat([ye.Command],a||[]),to:e,cmd:be.Climb,flightLevel:n}}function Le(e,t,n,a){return{from:t,tags:E.a.concat([ye.Command],a||[]),to:e,cmd:be.Descend,flightLevel:n}}function Se(e,t,n,a){return{from:t,tags:E.a.concat([ye.Command],a||[]),to:e,cmd:be.Maintain,flightLevel:n}}function Ve(e,t,n,a,r){return{from:t,tags:E.a.concat([ye.Command],r||[]),to:e,cmd:be.ClearedToTakeoff,flightLevel:a,rwy:n}}function He(e,t,n,a){return{from:t,tags:E.a.concat([ye.Command],a||[]),to:e,cmd:be.ClearedToLand,rwy:n}}function _e(e,t,n,a,r){return{from:t,tags:E.a.concat([ye.Command],r||[]),to:e,cmd:a?be.FlyToVia:be.FlyTo,turnTo:n,via:a}}function Ne(e,t,n,a){return{from:t,tags:E.a.concat([ye.Command],a||[]),to:e,cmd:n?be.HoldAt:be.HoldCurrentPosition,at:n}}function Re(e,t,n,a){return{from:t,tags:[ye.Command],to:e,cmd:be.HoldShort,at:n}}function De(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.FlightAtGround,id:n}}function Ie(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.InvalidFlightLevel,id:n}}function ze(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.BeaconNotFound,id:n}}function Be(e){return E.a.assign({},e,{from:e.to,to:e.from,tags:[ye.Readback]})}function We(e,t){return{from:e,to:t,tags:[ye.FlightReport],report:ke.LeavingOutOfArea}}function Ye(e,t){return{from:e.id,to:t,tags:[ye.FlightReport],report:ke.EnterTo,dest:e.to,via:e.from}}function Pe(e,t){return{from:e.id,to:t,tags:[ye.FlightReport],report:ke.EnterLeave,dest:e.to,via:e.from}}function Xe(e,t){return{from:e.id,to:t,tags:[ye.FlightReport],report:ke.ReadyToDepartureTo,rwy:e.from,dest:e.to}}function Ue(e,t){return{from:e.id,to:t,tags:[ye.FlightReport],report:ke.ReadyToDepartureLeave,rwy:e.from,dest:e.to}}function Ke(e,t){if(!e.rwy)throw new Error("missing runway");return{from:e.id,to:t,tags:[ye.FlightReport],report:ke.RunwayVacated,rwy:e.rwy}}function Je(e,t){return{from:e,to:t,tags:[ye.Confirmation],confirmation:we.GoodDay}}function Ge(e,t){return{from:e,to:t,tags:[ye.Confirmation],confirmation:we.Roger}}function qe(e,t,n){return{from:e,to:t,tags:[ye.Confirmation],confirmation:we.ClearedToLeave,dest:n}}function Ze(e,t){return{from:e,to:t,tags:[ye.Error],error:Ee.FlightNotFound}}function Qe(e,t){return{tags:[ye.Error,ye.VoiceMessage],error:Ee.Unitellegible,speech:e,parserError:t}}!function(e){e.FlightId="flight-id",e.Command="command",e.FlightLevel="flight-level",e.Turn="turn",e.TurnCondition="turn-condition",e.LandingRunway="landing-runway",e.HoldingCondition="holding-condition"}(Fe||(Fe={}));var et,tt=["040","080","120","160","200","240","280","320","360"],nt=function(e){var t=e.flight,n=e.onAbort,a=e.onChangeFlightLevel,r=e.onTurnHeading,o=e.onClearToLand,s=e.onHold;return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t),i.a.createElement(ne.a.Body,null,i.a.createElement(b.a,{vertical:!0},i.a.createElement(k.a,{variant:"warning",onClick:function(){n&&n()}},"Abort"),i.a.createElement(k.a,{variant:"secondary",onClick:function(){a&&a()}},"Change flight level"),i.a.createElement(k.a,{variant:"secondary",onClick:function(){r&&r()}},"Fly to"),i.a.createElement(k.a,{variant:"secondary",onClick:function(){o&&o()}},"Clear to land"),i.a.createElement(k.a,{variant:"secondary",onClick:function(){s&&s()}},"Hold"))))},at=function(e){var t=e.flights,n=e.onSelect,a=t?E()(t).keys().sort().value():[];return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Select flight"),i.a.createElement(ne.a.Body,null,i.a.createElement(b.a,{vertical:!0},a.map((function(e){return i.a.createElement(k.a,{key:e,variant:"secondary",onClick:function(){n&&n(e)}},e)})))))},rt=function(e){var t=e.flight,n=e.map,r=e.onAbort,o=e.onSelect,s=n?E()(n.nodes).filter({type:a.Runway}).map("id").sort().value():[];return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t,i.a.createElement("br",null),"clear to land"),i.a.createElement(ne.a.Body,null,i.a.createElement(b.a,{vertical:!0},i.a.createElement(k.a,{onClick:function(){r&&r()},variant:"warning"},"Abort"),s.map((function(e){return i.a.createElement(k.a,{key:e,onClick:function(){o&&o(e)},variant:"secondary"},e)})))))},it=function(e){var t=e.flight,n=e.map,r=e.onAbort,o=e.onSelect,s=n?E()(n.nodes).filter((function(e){return e.type===a.Entry||e.type===a.Beacon})).map("id").sort().value():[],l=Math.ceil((s.length+1)/2)-1,c=E.a.take(s,l),u=E.a.drop(s,l);return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t,i.a.createElement("br",null),"turn to"),i.a.createElement(ne.a.Body,null,i.a.createElement(p.a,{fluid:!0},i.a.createElement(g.a,null,i.a.createElement(m.a,null,i.a.createElement(b.a,{vertical:!0},i.a.createElement(k.a,{onClick:function(){r&&r()},variant:"warning"},"Abort"),c.map((function(e){return i.a.createElement(k.a,{key:e,onClick:function(){o&&o(e)},variant:"secondary"},e)})))),i.a.createElement(m.a,null,i.a.createElement(b.a,{vertical:!0},u.map((function(e){return i.a.createElement(k.a,{key:e,onClick:function(){o&&o(e)},variant:"secondary"},e)}))))))))},ot=function(e){var t=e.map,n=e.onAbort,r=e.onSelect,o=t?E()(t.nodes).filter((function(e){return e.type===a.Entry||e.type===a.Beacon})).map("id").sort().value():[],s=Math.ceil((o.length+2)/2)-2,l=E.a.take(o,s),c=E.a.drop(o,s);return i.a.createElement(p.a,{fluid:!0},i.a.createElement(g.a,null,i.a.createElement(m.a,null,i.a.createElement(b.a,{vertical:!0},i.a.createElement(k.a,{onClick:function(){n&&n()},variant:"warning"},"Abort"),i.a.createElement(k.a,{onClick:function(){r&&r()},variant:"primary"},"Now"),l.map((function(e){return i.a.createElement(k.a,{key:e,onClick:function(){r&&r(e)},variant:"secondary"},e)})))),i.a.createElement(m.a,null,i.a.createElement(b.a,{vertical:!0},c.map((function(e){return i.a.createElement(k.a,{key:e,onClick:function(){r&&r(e)},variant:"secondary"},e)}))))))},st=function(e){var t=e.flight,n=e.node,a=e.map,r=e.onAbort,o=e.onSelect;return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t,i.a.createElement("br",null),"turn to ",n,i.a.createElement("br",null),"at beacon"),i.a.createElement(ne.a.Body,null,i.a.createElement(ot,{map:a,onAbort:r,onSelect:o})))},lt=function(e){var t=e.flight,n=e.map,a=e.onAbort,r=e.onSelect;return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t,i.a.createElement("br",null),"hold on at"),i.a.createElement(ne.a.Body,null,i.a.createElement(ot,{map:n,onAbort:a,onSelect:r})))},ct=function(e){var t=e.flight,n=e.onAbort,a=e.onSelect,r=E()(tt).orderBy(E.a.identity,"desc").value();return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Header,null,"Flight ",t,i.a.createElement("br",null),"change flight level"),i.a.createElement(ne.a.Body,null,i.a.createElement(b.a,{vertical:!0},i.a.createElement(k.a,{variant:"warning",onClick:function(){n&&n()}},"Abort"),r.map((function(e){return i.a.createElement(k.a,{key:e,variant:"secondary",className:"fl-".concat(e),onClick:function(){a&&a(e)}}," FL ",e)})))))},ut=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e)).state={type:Fe.FlightId},E.a.bindAll(Object(u.a)(a),["handleFlightSelection","handleAbort","handleChangeFlightLevel","handleFlightLevelSelect","handleTurnHeading","handleTurnHeadingSelect","handleTurnConditionSelect","handleClearToLand","handleRunwaySelect","handleHold","handleHoldConditionSelect"]),a}return Object(c.a)(n,[{key:"handleFlightSelection",value:function(e){this.setState({flight:e,type:Fe.Command})}},{key:"handleAbort",value:function(){this.setState({type:Fe.FlightId})}},{key:"handleChangeFlightLevel",value:function(){this.setState({type:Fe.FlightLevel})}},{key:"handleFlightLevelSelect",value:function(e){var t=100*parseInt(e),n=this.state.flight,a=this.props,r=a.session,i=a.onCommand,o=this.mapId;if(i&&n&&r&&o){var s=r.flights[n];s?s.status===U.WaitingForTakeoff?i(Ve(n,o,s.from,e)):t>s.alt?i(Ae(n,o,e)):t<s.alt?i(Le(n,o,e)):i(Se(n,o,e)):i(Ae(n,o,e))}this.setState({type:Fe.FlightId})}},{key:"handleTurnHeading",value:function(){this.setState({type:Fe.Turn})}},{key:"handleTurnHeadingSelect",value:function(e){this.setState({node:e,type:Fe.TurnCondition})}},{key:"handleTurnConditionSelect",value:function(e){var t=this.state,n=t.flight,a=t.node,r=this.props.onCommand,i=this.mapId;i&&r&&a&&n&&r(_e(n,i,a,e)),this.setState({type:Fe.FlightId})}},{key:"handleClearToLand",value:function(){this.setState({type:Fe.LandingRunway})}},{key:"handleRunwaySelect",value:function(e){var t=this.state.flight,n=this.props.onCommand,a=this.mapId;n&&a&&t&&n(He(t,a,e)),this.setState({type:Fe.FlightId})}},{key:"handleHold",value:function(){this.setState({type:Fe.HoldingCondition})}},{key:"handleHoldConditionSelect",value:function(e){var t=this.state.flight,n=this.props.onCommand,a=this.mapId;n&&t&&a&&n(Ne(t,a,e)),this.setState({type:Fe.FlightId})}},{key:"render",value:function(){var e=this.props,t=e.session,n=e.map,a=t?t.flights:void 0,r=this.state,o=r.type,s=r.flight,l=r.node;switch(o){case Fe.Command:return i.a.createElement(nt,{onAbort:this.handleAbort,onChangeFlightLevel:this.handleChangeFlightLevel,onTurnHeading:this.handleTurnHeading,onClearToLand:this.handleClearToLand,onHold:this.handleHold,flight:s});case Fe.FlightLevel:return i.a.createElement(ct,{flight:s,onAbort:this.handleAbort,onSelect:this.handleFlightLevelSelect});case Fe.TurnCondition:return i.a.createElement(st,{map:n,flight:s,node:l,onAbort:this.handleAbort,onSelect:this.handleTurnConditionSelect});case Fe.Turn:return i.a.createElement(it,{map:n,flight:s,onAbort:this.handleAbort,onSelect:this.handleTurnHeadingSelect});case Fe.LandingRunway:return i.a.createElement(rt,{map:n,flight:s,onAbort:this.handleAbort,onSelect:this.handleRunwaySelect});case Fe.HoldingCondition:return i.a.createElement(lt,{map:n,flight:s,onAbort:this.handleAbort,onSelect:this.handleHoldConditionSelect});default:return i.a.createElement(at,{flights:a,onSelect:this.handleFlightSelection})}}},{key:"mapId",get:function(){return this.props.map?this.props.map.id:void 0}}]),n}(r.Component),dt=(n(58),n(29)),ht=n(17);!function(e){e.ATC="atc",e.Flight="flight",e.Error="error"}(et||(et={}));var pt,ft=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var a=E.a.map(t,(function(e){return Te(e)}));return Ce.apply(void 0,a)}(ye.FlightReport,ye.Negative,ye.Readback),gt=(pt=ft,function(e){return!pt(e)}),mt={"flight-report.ready-to-departure-to":{style:et.Flight,templ:"$atc, $from, holding short runway $rwy ready for departure to runway $dest"},"flight-report.ready-to-departure-leave":{style:et.Flight,templ:"$atc, $from, holding short runway $rwy ready for departure via $dest"},"flight-report.enter-to":{style:et.Flight,templ:"$atc, $from, enter control zone via $via to runway $dest"},"flight-report.enter-leave":{style:et.Flight,templ:"$atc, $from, enter control zone via $via leave $dest"},"flight-report.passing-flight-level":{style:et.Flight,templ:"$atc, $from, passing FL$flightLevel"},"flight-report.flying-to":{style:et.Flight,templ:"$atc, $from, flying to $dest"},"flight-report.runway-vacated":{style:et.Flight,templ:"$atc, $from, runway $rwy vacated"},"flight-report.wrong-runway-vacated":{style:et.Flight,templ:"$atc, $from, runway $rwy vacated, wrong arrival"},"flight-report.going-around-missing-approach":{style:et.Flight,templ:"$atc, $from, going around missing approach"},"flight-report.going-around-missing-runway":{style:et.Flight,templ:"$atc, $from, going around missing runway"},"flight-report.leaving":{style:et.Flight,templ:"$atc, $from, leaving controlled zone via $dest"},"flight-report.leaving-missing-departure":{style:et.Flight,templ:"$atc, $from, leaving controlled zone via $dest, missing departure"},"flight-report.leaving-out-of-area":{style:et.Flight,templ:"$atc, $from, leaving controlled zone, missing departure"},"flight-report.collision":{style:et.Flight,templ:"$atc, $from, mayday, mayday, mayday, collision"},"command.climb":{style:et.ATC,templ:"$to, $atc, climb to FL$flightLevel"},"readback.climb":{style:et.Flight,templ:"climbing to FL$flightLevel, $from"},"command.descend":{style:et.ATC,templ:"$to, $atc, descend to FL$flightLevel"},"readback.descend":{style:et.Flight,templ:"descending to FL$flightLevel, $from"},"command.maintain":{style:et.ATC,templ:"$to, $atc, maintain FL$flightLevel"},"readback.maintain":{style:et.Flight,templ:"maintaining FL$flightLevel, $from"},"command.cleared-to-takeoff":{style:et.ATC,templ:"$to, $atc, runway $rwy cleared to takeoff, climb to FL$flightLevel"},"readback.cleared-to-takeoff":{style:et.Flight,templ:"runway $rwy cleared to takeoff, climbing to FL$flightLevel, $from"},"command.fly-to":{style:et.ATC,templ:"$to, $atc, fly to $turnTo"},"readback.fly-to":{style:et.Flight,templ:"flying to $turnTo, $from"},"command.fly-to-via":{style:et.ATC,templ:"$to, $atc, fly to $turnTo via $via"},"readback.fly-to-via":{style:et.Flight,templ:"flying to $turnTo via $via, $from"},"command.cleared-to-land":{style:et.ATC,templ:"$to, $atc, cleared to land runway $rwy"},"readback.cleared-to-land":{style:et.Flight,templ:"cleared to land runway $rwy, $from"},"command.hold-short":{style:et.ATC,templ:"$to, $atc, hold short runway $at"},"readback.hold-short":{style:et.Flight,templ:"holding short runway $at, $from"},"command.hold-current-position":{style:et.ATC,templ:"$to, $atc, hold at current position"},"readback.hold-current-position":{style:et.Flight,templ:"holding at current position, $from"},"command.hold-at":{style:et.ATC,templ:"$to, $atc, hold at $at"},"readback.hold-at":{style:et.Flight,templ:"holding at $at, $from"},"negative.flight-at-ground":{style:et.Flight,templ:"$atc, $from, negative, holding short runway $id"},"negative.runway-too-distant":{style:et.Flight,templ:"$atc, $from, negative, wrong distance"},"negative.flight-too-high":{style:et.Flight,templ:"$atc, $from, negative, wrong flight level"},"negative.atc-not-found":{style:et.Flight,templ:"$atc, $from, negative, ATC not in area"},"negative.beacon-not-found":{style:et.Flight,templ:"$atc, $from, negative, $id not in area"},"negative.flight-not-at-ground":{style:et.Flight,templ:"$atc, $from, negative, not holding short runway $id"},"negative.invalid-flight-level":{style:et.Flight,templ:"$atc, $from, negative, invalid FL$id"},"negative.invalid-runway":{style:et.Flight,templ:"$atc, $from, negative, invalid runway $id"},"negative.runway-not-found":{style:et.Flight,templ:"$atc, $from, negative, runway $id not in area"},"error.flight-not-found":{style:et.Error,templ:"operator, flight $to not in area"},"confirmation.cleared-to":{style:et.ATC,templ:"$to, $atc, cleared to $dest"},"confirmation.cleared-to-leave":{style:et.ATC,templ:"$to, $atc, cleared to leave via $dest"},"confirmation.good-day":{style:et.ATC,templ:"$to, $atc, good day"},"confirmation.roger":{style:et.ATC,templ:"$to, $atc, roger"},"error.unintelligible":{style:et.Error,templ:"unintelligeble $speech, $errCode"}},vt={"flight-report.ready-to-departure-to":"$fromVoice $atc $from holding short runway $rwy ready for departure to runway $dest","flight-report.ready-to-departure-leave":"$fromVoice $atc $from holding short runway $rwy ready for departure via $dest","flight-report.enter-to":"$fromVoice $atc $from enter control zone via $via to runway $dest","flight-report.enter-leave":"$fromVoice $atc $from enter control zone via $via leave $dest","flight-report.passing-flight-level":"$fromVoice $atc $from passing flight level $flightLevel","flight-report.flying-to":"$fromVoice $atc $from flying to $dest","flight-report.runway-vacated":"$fromVoice $atc $from runway $rwy vacated","flight-report.wrong-runway-vacated":"$fromVoice $atc $from runway $rwy vacated wrong arrival","flight-report.going-around-missing-approach":"$fromVoice $atc $from going around missing approach","flight-report.going-around-missing-runway":"$fromVoice $atc $from going around missing runway","flight-report.leaving":"$fromVoice $atc $from leaving controlled zone via $dest","flight-report.leaving-missing-departure":"$fromVoice $atc $from leaving controlled zone via $dest missing departure","flight-report.leaving-out-of-area":"$fromVoice $atc $from leaving controlled zone missing departure","flight-report.collision":"$fromVoice $atc $from mayday mayday mayday collision","command.climb":"$fromVoice $to $atc climb to flight level $flightLevel","readback.climb":"$fromVoice climbing to flight level $flightLevel $from","command.descend":"$fromVoice $to $atc descend to flight level $flightLevel","readback.descend":"$fromVoice descending to flight level $flightLevel $from","command.maintain":"$fromVoice $to $atc maintain flight level $flightLevel","readback.maintain":"$fromVoice maintaining flight level $flightLevel $from","command.cleared-to-takeoff":"$fromVoice $to $atc runway $rwy cleared to takeoff climb to flight level $flightLevel","readback.cleared-to-takeoff":"$fromVoice runway $rwy cleared to takeoff climbing to flight level $flightLevel $from","command.fly-to":"$fromVoice $to $atc fly to $turnTo","readback.fly-to":"$fromVoice flying to $turnTo $from","command.fly-to-via":"$fromVoice $to $atc fly to $turnTo via $via","readback.fly-to-via":"$fromVoice flying to $turnTo via $via $from","command.cleared-to-land":"$fromVoice $to $atc cleared to land runway $rwy","readback.cleared-to-land":"$fromVoice cleared to land runway $rwy $from","command.hold-short":"$fromVoice $to $atc hold short runway $at","readback.hold-short":"$fromVoice holding short runway $at $from","command.hold-current-position":"$fromVoice $to $atc hold at current position","readback.hold-current-position":"$fromVoice holding at current position $from","command.hold-at":"$fromVoice $to $atc hold at $at","readback.hold-at":"$fromVoice holding at $at $from","negative.flight-at-ground":"$fromVoice $atc $from negative holding short runway $id","negative.runway-too-distant":"$fromVoice $atc $from negative wrong distance","negative.flight-too-high":"$fromVoice $atc $from negative wrong flight level","negative.atc-not-found":"$fromVoice $to $from negative ATC not in area","negative.beacon-not-found":"$fromVoice $atc $from negative $id not in area","negative.flight-not-at-ground":"$fromVoice $atc $from negative not holding short runway $id","negative.invalid-flight-level":"$fromVoice $atc $from negative invalid flight level $flId","negative.invalid-runway":"$fromVoice $atc $from negative invalid runway $id","negative.runway-not-found":"$fromVoice $atc $from negative runway $id not in area","error.flight-not-found":"$fromVoice operator flight $to not in area","confirmation.cleared-to":"$fromVoice $to $atc cleared to $dest","confirmation.cleared-to-leave":"$fromVoice $to $atc cleared to leave via $dest","confirmation.good-day":"$fromVoice $to $atc good day","confirmation.roger":"$fromVoice $to $atc roger","error.unintelligible":"$atcVoice unintelligeble $speech, $errCode"},yt=/^(\w+)(.*)/,bt=function(){function e(t,n){Object(l.a)(this,e),this._message=void 0,this._map=void 0,this._message=t,this._map=n,E.a.bindAll(this)}return Object(c.a)(e,[{key:"applyTemplate",value:function(e){var t=this,n=e.split("$"),a=E()(n).drop(1).flatMap((function(e){var t=e.match(yt);return t?["$"+t[1],t[2]]:["$",e]})).value(),r=E.a.concat(n[0],a);return E.a.map(r,(function(e){if("$"!==e&&e.startsWith("$")){var n=e.substring(1),a=t[n];if(!a)return e;var r=a.apply(t);return r||e}return e})).join("")}},{key:"key",value:function(){var e=this.message.tags[0],t=this.message;return[e,t.cmd||t.report||t.error||t.confirmation].join(".")}},{key:"atc",value:function(){var e=gt(this.message)?this.message.from:this.message.to;return e?this.map.id===e?this.map.name:e:"?"}},{key:"at",value:function(){var e=this.message.at;return e||"?"}},{key:"to",value:function(){var e=this.message.to;return e||"?"}},{key:"from",value:function(){var e=this.message.from;return e||"?"}},{key:"dest",value:function(){var e=this.message;return void 0!==e.dest?e.dest:"?"}},{key:"via",value:function(){var e=this.message;return void 0!==e.via?e.via:"?"}},{key:"rwy",value:function(){var e=this.message;return void 0!==e.rwy?e.rwy:"?"}},{key:"flightLevel",value:function(){var e=this.message;return void 0!==e.flightLevel?e.flightLevel:"?"}},{key:"turnTo",value:function(){var e=this.message;return void 0!==e.turnTo?e.turnTo:"?"}},{key:"id",value:function(){var e=this.message.id;return void 0!==e?e:"?"}},{key:"speech",value:function(){var e=this.message.speech;return void 0!==e?e:"?"}},{key:"errCode",value:function(){var e=this.message.parserError;return void 0!==e?e:"?"}},{key:"map",get:function(){return this._map}},{key:"message",get:function(){return this._message}}]),e}(),kt=Object.freeze({a:"alpha",b:"bravo",c:"charlie",d:"delta",e:"echo",f:"fox trot",g:"golf",h:"hotel",i:"india",j:"juliet",k:"kilo",l:"lima",m:"mike",n:"november",o:"oscar",p:"papa",q:"quebeck",r:"romeo",s:"sierra",t:"tango",u:"uniform",v:"victor",x:"x-ray",w:"whiskey",y:"yenkee",z:"zulu",0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"niner"}),wt=Object.freeze({r:"right",c:"center",l:"left"});function Et(e){var t=e.toLowerCase();return E()(t).map((function(e){var t=kt[e];return void 0!==t?t:e})).join(" ")}function $t(e){var t=/^(\d.)(r|l|c)?/g.exec(e.toLowerCase());return t&&3===t.length?t[2]?"".concat(Et(t[1])," ").concat(wt[t[2]]):"".concat(Et(t[1])):Et(e)}var Mt=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e,a){var r;return Object(l.a)(this,n),r=t.call(this,e,a),E.a.bindAll(Object(u.a)(r)),r}return Object(c.a)(n,[{key:"build",value:function(){var e=mt[this.key()];return e?{style:e.style,text:this.applyTemplate(e.templ)}:{style:et.Error,text:this.key()}}}]),n}(bt),Ot=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e,a,r){var i;return Object(l.a)(this,n),(i=t.call(this,e,a))._session=void 0,i._session=r,E.a.bindAll(Object(u.a)(i)),i}return Object(c.a)(n,[{key:"build",value:function(){var e=vt[this.key()];return e?this.applyTemplate(e):this.key()}},{key:"atcVoice",value:function(){return this.session.atcVoice}},{key:"fromVoice",value:function(){var e=Object(dt.a)(Object(ht.a)(n.prototype),"from",this).call(this);if(this.map.id===e)return this.session.atcVoice||"?";var t=this.session.flights[e];return t&&t.voice||this.session.atcVoice||"?"}},{key:"from",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"from",this).call(this))}},{key:"to",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"to",this).call(this))}},{key:"dest",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"dest",this).call(this))}},{key:"rwy",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"rwy",this).call(this))}},{key:"via",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"via",this).call(this))}},{key:"turnTo",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"turnTo",this).call(this))}},{key:"flightLevel",value:function(){return Et(Object(dt.a)(Object(ht.a)(n.prototype),"flightLevel",this).call(this))}},{key:"id",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"id",this).call(this))}},{key:"at",value:function(){return $t(Object(dt.a)(Object(ht.a)(n.prototype),"at",this).call(this))}},{key:"flId",value:function(){return Et(Object(dt.a)(Object(ht.a)(n.prototype),"id",this).call(this))}},{key:"session",get:function(){return this._session}}]),n}(bt),Ct=n(56),Tt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;Object(l.a)(this,e),this._log=void 0,this.maxMessages=void 0,this._log=[],this.maxMessages=t,E.a.bindAll(this,["putMessages"])}return Object(c.a)(e,[{key:"putMessages",value:function(e){return this._log=E()(this.log).concat(e).takeRight(this.maxMessages).value(),e.forEach((function(e){switch(e.style){case et.ATC:Ct.b.dark(i.a.createElement("div",{className:"bg-light text-success border-success border rounded p-2"},e.text));break;case et.Error:Ct.b.dark(i.a.createElement("div",{className:"bg-light text-danger border-danger border rounded p-2"},e.text));break;default:Ct.b.dark(i.a.createElement("div",{className:"bg-light text-dark border-light border rounded p-2"},e.text))}})),this}},{key:"log",get:function(){return this._log}}]),e}();var jt=n(19),Ft=n(27),xt=Math.PI/180,At=1/60/Math.PI,Lt=["hdg","speed","lat","lon","alt"];var St=function(e,t){return function(n){return n.set(e,t)}},Vt=function(e){return function(t){return t.delete(e)}},Ht=function(e){return function(t){return t.set("lat",e.lat).set("lon",e.lon)}},_t=function(){function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];Object(l.a)(this,e),this._flight=void 0,this._messages=void 0,this._props=void 0,this._flight=t,this._messages=a,this._props=n,E.a.bindAll(this)}return Object(c.a)(e,[{key:"addFlyingToDialog",value:function(){var e,t,n,a,r,i=this.flight.at;if(!i)throw new Error("missing at");return this.addMessage([(a=this.flight,r=this.map.id,{from:a.id,to:r,tags:[ye.FlightReport],report:ke.FlyingTo,dest:a.at}),(e=this.map.id,t=this.flight.id,n=i,{from:e,to:t,tags:[ye.Confirmation],confirmation:we.ClearedTo,dest:n})])}},{key:"addMissingApproachDialog",value:function(){var e,t,n,a=Object(ce.sprintf)("%03d",Math.round(this.flight.toAlt/100)),r=Ae(this.flight.id,this.map.id,a);return this.addMessage([(e=this.flight.id,t=this.map.id,n=a,{from:e,to:t,tags:[ye.FlightReport],report:ke.GoingAroundMissingApproach,flightLevel:"string"===typeof n?n:Object(ce.sprintf)("%03d",Math.round(n/100))}),r,Be(r)])}},{key:"addMissingRunwayDialog",value:function(){var e,t,n,a=Object(ce.sprintf)("%03d",Math.round(this.flight.toAlt/100)),r=Ae(this.flight.id,this.map.id,a);return this.addMessage([(e=this.flight.id,t=this.map.id,n=a,{from:e,to:t,tags:[ye.FlightReport],report:ke.GoingAroundMissingRunway,flightLevel:"string"===typeof n?n:Object(ce.sprintf)("%03d",Math.round(n/100))}),r,Be(r)])}},{key:"addPassingFlightLevelDialog",value:function(){return this.addMessage([(e=this.flight.id,t=this.map.id,n=this.flight.alt,{from:e,to:t,tags:[ye.FlightReport],report:ke.PassingFlightLevel,flightLevel:"string"===typeof n?n:Object(ce.sprintf)("%03d",Math.round(n/100))}),Ge(this.map.id,this.flight.id)]);var e,t,n}},{key:"vspeed",value:function(){return this.props.flightTempl[this.flight.type].vspeed}},{key:"landingAlt",value:function(e){var t=this.props,n=t.landingAngle,a=t.map;if(e)return Math.round(e*Math.tan(n*xt)*(1852/.3048));var r=this.flight.rwy;if(!r)throw new Error("missing runway");var i=B.distance(a.nodes[r],this.flight);return Math.round(i*Math.tan(n*xt)*(1852/.3048))}},{key:"outerMarkerAlt",value:function(){return this.landingAlt(this.props.om)}},{key:"outerMarker",value:function(e){if(!(e=e||this.flight.rwy||""))throw new Error("missing runway");var t=this.props,n=t.om,a=t.map.nodes[e];if(!N(a))throw new Error("not a runway");return B.radial(a,a.hdg+180,n)}},{key:"midleMarker",value:function(e){if(!(e=e||this.flight.rwy))throw new Error("missing runway");var t=this.props,n=t.mm,a=t.map.nodes[e];if(!N(a))throw new Error("not a runway");return B.radial(a,a.hdg+180,n)}},{key:"approachDistance",value:function(e){return B.distance(this.flight,this.outerMarker(e))+this.props.om}},{key:"approachAlt",value:function(e){return this.landingAlt(this.approachDistance(e))}},{key:"maxApproachAlt",value:function(e){var t=B.distance(this.outerMarker(e),this.flight),n=this.vspeed()*t*60/this.flight.speed;return Math.round(n+this.outerMarkerAlt())}},{key:"addMessage",value:function(e){var t=E.a.concat(this.messages,e);return this.withMessages(t)}},{key:"withFlight",value:function(t){var n=E()(Lt).find((function(e){var n=t[e];return!n&&0!==n}));return n&&console.trace("Flight with",n,"invalid",t),n?this:new e(t,this.props,this.messages)}},{key:"withMessages",value:function(t){return new e(this.flight,this.props,t)}},{key:"apply",value:function(){for(var e=Object(Ft.b)(this.flight),t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];var r=E.a.reduce(n,(function(e,t){return t(e)}),e).toJS();return this.withFlight(r)}},{key:"nextPos",value:function(){var e=this.flight,t=e.speed,n=e.hdg,a=this.props.dt*t/3600;return B.radial(this.flight,n,a)}},{key:"turnedTo",value:function(e){var t=3*this.props.dt,n=B.route(this.flight,e).angle,a=Math.abs(n)<=t?n:Math.sign(n)*t,r=B.normHdg(this.flight.hdg+a);return this.apply(St("hdg",r))}},{key:"flyTo",value:function(e,t){var n=this.props.dt,a=this.flight,r=a.speed,i=B.distance(a,e),o=r*n/3600,s=this.turnedTo(e).moveHoriz().moveVert();return o>=i?t(s):s}},{key:"approachJunction",value:function(){var e=this.flight,t=e.speed,n=e.rwy;if(!n)throw new Error("missing runway");var a=this.outerMarker(),r=t*At,i=this.props.map.nodes[n];if(!N(i))throw new Error("not a runway");var o=i.hdg,s=B.radial(a,o-90,r),l=B.radial(a,o+90,r),c=B.distance(s,this.flight),u=B.distance(l,this.flight);if(u<=c){var d=B.hdg(l,this.flight),h=B.normHdg(Math.round(d-Math.asin(r/u)/xt));return{entry:B.radial(l,h-90,r),sigma:h,pivot:l,right:!0}}var p=B.hdg(s,this.flight),f=B.normHdg(Math.round(p+Math.asin(r/c)/xt));return{entry:B.radial(s,f+90,r),sigma:f,pivot:s,right:!1}}},{key:"speedByAlt",value:function(e){return function(e,t){return Math.round(e/36e3*(t.speed360-t.speed0)+t.speed0)}(e,this.props.flightTempl[this.flight.type])}},{key:"turnedRight",value:function(e){var t=this.props.dt,n=this.flight.hdg,a=e>=n?e-n:360+e-n,r=3*t,i=a<=r?a:r,o=B.normHdg(this.flight.hdg+i);return this.apply(St("hdg",o))}},{key:"turnedRightTo",value:function(e){var t=this.props.dt,n=this.flight.hdg,a=B.hdg(e,this.flight),r=a>=n?a-n:360+a-n,i=3*t,o=r<=i?r:i,s=B.normHdg(this.flight.hdg+o);return this.apply(St("hdg",s))}},{key:"turnedLeftTo",value:function(e){var t=this.props.dt,n=this.flight.hdg,a=B.hdg(e,this.flight),r=n>=a?n-a:360+n-a,i=3*t,o=r<=i?r:i,s=B.normHdg(this.flight.hdg-o);return this.apply(St("hdg",s))}},{key:"outboundTrack",value:function(e){var t=this.props.dt,n=this.flight,a=n.holdHdg,r=n.loopTimer;if(!a)throw new Error("missing hold heading");var i,o,s=this.apply((i="loopTimer",o=function(e){return e-t},function(e){return e.update(i,o)})).turnedRight(a).moveHoriz().moveVert();return!r||r<=0?e(s):s}},{key:"moveHoriz",value:function(){return this.apply(Ht(this.nextPos()))}},{key:"moveVert",value:function(){var e=this.flight,t=e.alt,n=e.toAlt,a=this.props.dt,r=this.vspeed(),i=t<n?Math.min(n,Math.round(t+r*a*(1/60))):t>n?Math.max(n,Math.round(t-r*a*(1/60))):t,o=this.speedByAlt(i),s=this.apply(St("alt",i),St("speed",o));return n!==t&&i===n?s.addPassingFlightLevelDialog():s}},{key:"approachVert",value:function(){var e=this.flight.alt,t=Math.round(e-this.vspeed()*this.props.dt*(1/60)),n=Math.min(e,Math.max(t,this.approachAlt())),a=this.speedByAlt(n);return this.apply(St("alt",n),St("speed",a))}},{key:"landVert",value:function(){var e=this.flight.alt,t=Math.round(e-this.vspeed()*this.props.dt*(1/60)),n=Math.min(e,Math.max(t,this.landingAlt())),a=this.speedByAlt(n);return this.apply(St("alt",n),St("speed",a))}},{key:"processCommand",value:function(e){switch(e.cmd){case be.Climb:return this.processClimbCommand(e);case be.Descend:return this.processDescendCommand(e);case be.Maintain:return this.processMaintainCommand(e);case be.ClearedToTakeoff:return this.processTakeoffCommand(e);case be.FlyTo:case be.FlyToVia:return this.processFlyToCommand(e);case be.ClearedToLand:return this.processClearedToLandCommand(e);case be.HoldCurrentPosition:case be.HoldAt:return this.processHoldCommand(e);default:return this}}},{key:"processHoldCommand",value:function(e){var t=this.validateATC(e);if(t)return t;var n=e.at;if(n&&!this.props.map.nodes[n])return this.addMessage(ze(this.flight.id,this.props.map.id,n));var a=this.flight,r=a.status,i=a.hdg,o=a.lat,s=a.lon,l=this.props,c=l.map,u=l.holdingDuration;if(r===U.WaitingForTakeoff)return this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from));if(n){var d=c.nodes[n],h=B.hdg(d,this.flight);return this.apply(St("status",U.HoldingToAt),St("holdHdg",B.normHdg(h+180)),St("at",n)).addMessage(Be(e))}var p={lat:o,lon:s};return this.apply(St("status",U.HoldingFrom),St("loopTimer",u/2),St("holdHdg",B.normHdg(i+180)),St("fix",p)).addMessage(Be(e))}},{key:"processClearedToLandCommand",value:function(e){var t=this.validateATC(e);if(t)return t;var n=e.rwy;if(!this.props.map.nodes[n])return this.addMessage(function(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.RunwayNotFound,id:n}}(this.flight.id,this.props.map.id,n));var a,r,i=this.flight,o=i.alt,s=i.status,l=this.props.clearToLandDistance;return s===U.WaitingForTakeoff?this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from)):this.approachDistance(n)>l?this.addMessage((a=this.flight.id,r=this.props.map.id,{from:a,to:r,tags:[ye.Negative],error:Ee.RunwayTooDistant})):o>this.maxApproachAlt(n)?this.addMessage(function(e,t){return{from:e,to:t,tags:[ye.Negative],error:Ee.FlightTooHigh}}(this.flight.id,this.props.map.id)):this.apply(St("rwy",n),St("status",U.Approaching),Vt("turnTo"),Vt("at")).addMessage(Be(e))}},{key:"processFlyToCommand",value:function(e){var t=this.validateATC(e);if(t)return t;var n=e.via,a=e.turnTo;return this.props.map.nodes[a]?n&&!this.props.map.nodes[n]?this.addMessage(ze(this.flight.id,this.props.map.id,n)):this.flight.status===U.WaitingForTakeoff?this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from)):(n?this.apply(St("at",n),St("status",U.Turning),St("turnTo",a)):this.apply(St("at",a),St("status",U.FlyingTo),Vt("turnTo"))).apply(Vt("rwy")).addMessage(Be(e)):this.addMessage(ze(this.flight.id,this.props.map.id,a))}},{key:"validateATC",value:function(e){var t=e.from;if(!t)throw new Error("missing atc id");if(t!==this.props.map.id)return this.addMessage({from:this.flight.id,to:t,tags:[ye.Negative],error:Ee.ATCNotFound})}},{key:"validateFlightLevelCommand",value:function(e){var t=e.flightLevel,n=100*parseInt(t);if(n<4e3||n>36e3||n%4e3)return this.addMessage(Ie(this.flight.id,this.props.map.id,t))}},{key:"processClimbCommand",value:function(e){var t=this.validateATC(e)||this.validateFlightLevelCommand(e);if(t)return t;var n=e.flightLevel,a=100*parseInt(n),r=this.flight,i=r.alt,o=r.status;return o===U.WaitingForTakeoff?this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from)):i>=a?this.addMessage(Ie(this.flight.id,this.props.map.id,n)):(o===U.Landing||o===U.Approaching||o===U.Aligning?this.apply(St("toAlt",a),St("status",U.Flying),Vt("rwy")):this.apply(St("toAlt",a))).addMessage(Be(e))}},{key:"processDescendCommand",value:function(e){var t=this.validateATC(e)||this.validateFlightLevelCommand(e);if(t)return t;var n=e.flightLevel,a=100*parseInt(n),r=this.flight,i=r.alt,o=r.status;return o===U.WaitingForTakeoff?this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from)):i<=a?this.addMessage(Ie(this.flight.id,this.props.map.id,n)):(o===U.Landing||o===U.Approaching||o===U.Aligning?this.apply(St("toAlt",a),St("status",U.Flying),Vt("rwy")):this.apply(St("toAlt",a))).addMessage(Be(e))}},{key:"processMaintainCommand",value:function(e){var t=this.validateATC(e)||this.validateFlightLevelCommand(e);if(t)return t;var n=e.flightLevel,a=100*parseInt(n),r=this.flight,i=r.alt,o=r.status;return o===U.WaitingForTakeoff?this.addMessage(De(this.flight.id,this.props.map.id,this.flight.from)):i!==a?this.addMessage(Ie(this.flight.id,this.props.map.id,n)):(o===U.Landing||o===U.Approaching||o===U.Aligning?this.apply(St("toAlt",a),St("status",U.Flying),Vt("rwy")):this.apply(St("toAlt",a))).addMessage(Be(e))}},{key:"processTakeoffCommand",value:function(e){var t=this.validateATC(e)||this.validateFlightLevelCommand(e);if(t)return t;var n=e.flightLevel,a=e.rwy,r=100*parseInt(n),i=this.flight,o=i.status,s=i.from;return o!==U.WaitingForTakeoff?this.addMessage(function(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.FlightNotAtGround,id:n}}(this.flight.id,this.props.map.id,a)):a!==s?this.addMessage(function(e,t,n){return{from:e,to:t,tags:[ye.Negative],error:Ee.InvalidRunway,id:n}}(this.flight.id,this.props.map.id,a)):this.apply(St("toAlt",r),St("status",U.Flying),Vt("rwy")).addMessage(Be(e))}},{key:"processTime",value:function(){return this.processTimePhase1().processExit()}},{key:"processTimePhase1",value:function(){switch(this.flight.status){case U.FlyingTo:return this.processTimeFlyingTo();case U.Flying:return this.processTimeFlying();case U.Turning:return this.processTimeTurning();case U.Approaching:return this.processTimeApproaching();case U.Aligning:return this.processTimeAligning();case U.Landing:return this.processTimeLanding();case U.HoldingFrom:return this.processTimeHoldingFrom();case U.HoldingTo:return this.processTimeHoldingTo();case U.HoldingFromAt:return this.processTimeHoldingFromNode();case U.HoldingToAt:return this.processTimeHoldingToNode();default:return this}}},{key:"processTimeHoldingFromNode",value:function(){var e=this.flight;return this.outboundTrack((function(t){var n=B.normHdg(e.hdg+3*t.props.dt);return t.apply(St("status",U.HoldingToAt),St("hdg",n)).moveHoriz().moveVert()}))}},{key:"processTimeHoldingToNode",value:function(){var e=this.flight.at;if(!e)throw new Error("missing at");return this.flyTo(this.props.map.nodes[e],(function(e){return e.apply(St("status",U.HoldingFromAt),St("loopTimer",e.props.holdingDuration/2))}))}},{key:"processTimeHoldingFrom",value:function(){var e=this,t=this.flight;return this.outboundTrack((function(n){var a=B.normHdg(t.hdg+3*n.props.dt);return e.apply(St("status",U.HoldingTo),St("hdg",a)).moveHoriz().moveVert()}))}},{key:"processTimeHoldingTo",value:function(){var e=this.flight.fix;if(!e)throw new Error("missing fix");return this.flyTo(e,(function(e){return e.apply(St("status",U.HoldingFrom),St("loopTimer",e.props.holdingDuration/2))}))}},{key:"processExit",value:function(){var e=this.props,t=e.map,n=e.dt,r=this.flight,i=r.speed*n/3600,o=E.a.findKey(t.nodes,(function(e){if(!function(e){return e.type===a.Entry}(e))return!1;var t=e.hdg,n=B.normAngle(r.hdg-t);if(Math.abs(n)<=90)return!1;var o=B.route(r,e),s=o.from,l=o.d;return s&&l<=i&&Math.abs(n)}));return o?this.apply(St("exit",o),St("status",U.Exited)):this}},{key:"processTimeApproaching",value:function(){var e=this.props,t=e.dt,n=e.map,a=this.flight,r=a.hdg,i=a.speed,o=a.rwy;if(!o)throw new Error("missing runway");var s=n.nodes[o];if(!N(s))throw new Error("not a runway");var l=s.hdg,c=this.approachJunction(),u=c.entry,d=c.pivot,h=c.right,p=i*At,f=3*t,g=B.distance(this.flight,d),m=B.route(this.flight,u),v=m.angle,y=m.d,b=B.normAngle(r-l);if(g<=p-.1)return console.error("Missing approach cause distance from pivot turn",this.flight),console.error("d",g,"r",p),this.apply(St("toAlt",this.props.goAroundAlt),St("status",U.Flying),Vt("rwy")).moveHoriz().moveVert().addMissingApproachDialog();if(Math.abs(v)>f&&g<=2*p)return console.error("Missing approach turn angle and pivot distance",this.flight),console.error("d",g,"r",p,"angle",v,"maxTurn",f,"r",p),this.apply(St("toAlt",this.props.goAroundAlt),St("status",U.Flying),Vt("rwy")).moveHoriz().moveVert().addMissingApproachDialog();if(i*t/3600<y)return this.turnedTo(u).moveHoriz().approachVert();if(Math.abs(b)>f){var k=this.apply(St("status",U.Aligning),St("right",h));return(h?k.turnedRightTo(k.outerMarker()):k.turnedLeftTo(k.outerMarker())).moveHoriz().approachVert()}return this.apply(St("status",U.Landing)).turnedTo(u).moveHoriz().approachVert()}},{key:"processTimeAligning",value:function(){var e=this.flight,t=e.right,n=e.rwy,a=e.hdg;if(!n)throw new Error("missing runway");var r=this.props,i=r.map,o=r.dt,s=i.nodes[n];if(!N(s))throw new Error("not a runway");var l=s.hdg,c=B.normAngle(l-a),u=3*o;return Math.abs(c)<=u?this.apply(Vt("right"),St("status",U.Landing),St("hdg",l)).moveHoriz().landVert():t?this.turnedRightTo(this.outerMarker()).moveHoriz().landVert():this.turnedLeftTo(this.outerMarker()).moveHoriz().landVert()}},{key:"processTimeLanding",value:function(){var e=this.flight,t=e.speed,n=e.rwy,a=e.type,r=e.alt,i=e.hdg;if(!n)throw new Error("missing runway");var o=this.props,s=o.dt,l=o.map,c=o.landingHdgRange,u=o.flightTempl,d=o.goAroundAlt,h=o.mm,p=l.nodes[n];if(!N(p))throw new Error("not a runway");var f=p.hdg,g=B.route(e,p),m=g.from,v=g.d,y=g.angle,b=t*s/3600;if(m)return console.error("Missing runway direction from",this.flight),this.apply(St("status",U.Flying),St("toAlt",d),Vt("rwy")).moveHoriz().moveVert().addMissingRunwayDialog();if(b>v)return Math.abs(B.normAngle(i-f))>c?(console.error("Missing runway land alignment",this.flight),this.apply(St("status",U.Flying),St("toAlt",d),Vt("rwy")).moveHoriz().moveVert().addMissingRunwayDialog()):this.apply(Ht(p),St("speed",0),St("alt",0),St("status",U.Landed));var k=v*Math.sin(y*xt);if(Math.abs(k)>=b)return v<h?(console.error("Missing runway too shifted",this.flight),this.apply(St("status",U.Flying),St("toAlt",d),Vt("rwy")).moveHoriz().moveVert().addMissingRunwayDialog()):this.turnedTo(this.midleMarker()).moveHoriz().landVert();var w=Math.sqrt(b*b-k*k),E=B.radial(p,f+180,v-w),$=this.landingAlt(v-b),M=u[a].vspeed;return $<Math.round(r-M*s*(1/60))?(console.error("Missing runway alitude",this.flight),this.apply(St("status",U.Flying),St("toAlt",d),Vt("rwy")).addMissingRunwayDialog().moveHoriz().moveVert()):this.turnedTo(E).moveHoriz().landVert()}},{key:"processTimeTurning",value:function(){var e=this.props.map,t=this.flight,n=t.turnTo,a=t.at;if(!a)throw new Error("missing at");return this.flyTo(e.nodes[a],(function(e){return e.apply(St("status",U.FlyingTo),St("at",n),Vt("turnTo")).addFlyingToDialog()}))}},{key:"processTimeFlying",value:function(){return this.moveHoriz().moveVert()}},{key:"processTimeFlyingTo",value:function(){var e=this.flight.at;if(!e)throw new Error("missing at property");var t=this.props.map.nodes[e];return this.flyTo(t,(function(e){return e.apply(Vt("at"),St("status",U.Flying))}))}},{key:"messages",get:function(){return this._messages}},{key:"props",get:function(){return this._props}},{key:"flight",get:function(){return this._flight}},{key:"map",get:function(){return this.props.map}}]),e}(),Nt=Object.freeze({dt:1,jetProb:.5,safeEntryDelay:120,entryAlt:28e3,exitAlt:36e3,collisionDistance:4,collisionAlt:1e3,om:7,mm:.9,clearToLandDistance:30,exitDistance:2,landingHdgRange:2,landingAngle:3,conditionDistance:400/3600*10*1.5,holdingDuration:240,goAroundAlt:4e3,flightTempl:{J:{speed0:140,speed360:440,vspeed:1500},A:{speed0:80,speed360:280,vspeed:700}},flightVoices:[]});function Rt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"X99X",t=E.a.map(e,(function(e){return"X"===e?String.fromCharCode(65+Math.floor(26*Math.random())):String.fromCharCode(48+Math.floor(10*Math.random()))})).join("");return t}function Dt(e){return e.length<=1?e[0]:e[(t=e.length,Math.floor(Math.random()*t))];var t}function It(e,t){return new zt(e,E.a.assign({},Nt,t))}var zt=function(){function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];Object(l.a)(this,e),this._props=void 0,this._session=void 0,this._messages=void 0,this._props=n,this._session=t,this._messages=a,E.a.bindAll(this)}return Object(c.a)(e,[{key:"withSession",value:function(t){return new e(t,this.props,this.messages)}},{key:"withMessages",value:function(t){return new e(this.session,this.props,t)}},{key:"addMessages",value:function(e){return this.withMessages(E.a.concat(this.messages,e))}},{key:"addDepartureToDialog",value:function(e){var t=Re(e.id,this.map.id,e.from);return this.addMessages([Xe(e,this.map.id),t,Be(t)])}},{key:"addDepartureLeaveDialog",value:function(e){var t=Re(e.id,this.map.id,e.from);return this.addMessages([Ue(e,this.map.id),t,Be(t)])}},{key:"addEnterToDialog",value:function(e){return this.addMessages([Ye(e,this.map.id),Ge(this.map.id,e.id)])}},{key:"addEnterLeaveDialog",value:function(e){return this.addMessages([Pe(e,this.map.id),Ge(this.map.id,e.id)])}},{key:"processCommand",value:function(e){var t=e.to;if(!t)throw new Error("missing flight id");var n=this.session.flights[t];if(!n)return this.addMessages([Ze(this.props.map.id,t)]);var a=new _t(n,this.props).processCommand(e),r=Object(Ft.b)(this.session).setIn(["flights",t],a.flight).toJS();return this.withSession(r).addMessages(a.messages)}},{key:"transition",value:function(){return this.processFlights().filterForLanded().filterForOutOfArea().filterForExited().filterCollision().processForNewFlight().addTime()}},{key:"filterCollision",value:function(){for(var e=this,t=this.props,n=t.collisionAlt,a=t.collisionDistance,r=this.session.flights,i=E.a.values(r),o=Ft.a.of(),s=0;s<i.length;s++)for(var l=s+1;l<i.length;l++){var c=i[s],u=i[l],d=B.distance(c,u),h=Math.abs(c.alt-u.alt);c.status!==U.WaitingForTakeoff&&u.status!==U.WaitingForTakeoff&&h<=n&&d<=a&&(o=o.add(c.id).add(u.id))}var p=E.a.partition(r,(function(e){return o.has(e.id)})),f=Object(jt.a)(p,2),g=f[0],m=f[1],v=g.length;if(v>0){var y=E()(m).groupBy("id").mapValues((function(e){return e[0]})).value(),b=Object(Ft.b)(this.session).set("flights",y).update("noCollision",(function(e){return e+v})).toJS(),k=g.map((function(t){return n=t.id,a=e.props.map.id,{from:n,to:a,tags:[ye.FlightReport],report:ke.Collision};var n,a}));return this.withSession(b).addMessages(k)}return this}},{key:"filterForExited",value:function(){var e=this,t=this.props.exitAlt,n=E.a.partition(this.session.flights,{status:U.Exited}),a=Object(jt.a)(n,2),r=a[0],i=a[1];if(r.length>0){var o=E.a.partition(r,(function(e){return e.alt===t&&e.to===e.exit})),s=Object(jt.a)(o,2),l=s[0],c=s[1],u=l.length,d=c.length,h=E()(i).groupBy("id").mapValues((function(e){return e[0]})).value(),p=Object(Ft.b)(this.session).set("flights",h).update("noExitOk",(function(e){return e+u})).update("noExitKo",(function(e){return e+d})).toJS(),f=E.a.flatMap(l,(function(t){return[(n=t,a=e.props.map.id,{from:n.id,to:a,tags:[ye.FlightReport],report:ke.Leaving,dest:n.exit}),qe(e.props.map.id,t.id,t.exit)];var n,a})),g=E.a.flatMap(c,(function(t){return[(n=t,a=e.props.map.id,{from:n.id,to:a,tags:[ye.FlightReport],report:ke.LeavingMissingDearture,dest:n.exit}),qe(e.props.map.id,t.id,t.exit)];var n,a}));return this.withSession(p).addMessages(f).addMessages(g)}return this}},{key:"filterForOutOfArea",value:function(){var e=this,t=this.props,n=t.map,a=t.exitDistance,r=n.center,i=B.coords(n.nodes,r),o=this.session.flights,s=E.a.partition(o,(function(e){var t=B.xy(e,r);return t[0]<i.xmin-a||t[0]>i.xmax+a||t[1]<i.ymin-a||t[1]>i.ymax+a})),l=Object(jt.a)(s,2),c=l[0],u=l[1];if(c.length>0){var d=E()(u).groupBy("id").mapValues((function(e){return e[0]})).value(),h=Object(Ft.b)(this.session).set("flights",Object(Ft.b)(d)).update("noExitKo",(function(e){return e+c.length})).toJS(),p=E()(c).flatMap((function(t){return[We(t.id,e.props.map.id),Ge(e.props.map.id,t.id)]})).value();return this.withSession(h).addMessages(p)}return this}},{key:"filterForLanded",value:function(){var e=this,t=E.a.partition(this.session.flights,{status:U.Landed}),n=Object(jt.a)(t,2),a=n[0],r=n[1];if(a.length>0){var i=E.a.partition(a,(function(e){return e.to===e.rwy})),o=Object(jt.a)(i,2),s=o[0],l=o[1],c=s.length,u=l.length,d=E()(r).map((function(e){return[e.id,e]})).fromPairs().value(),h=Object(Ft.b)(this.session).set("flights",d).update("noLandedOk",(function(e){return e+c})).update("noLandedKo",(function(e){return e+u})).toJS(),p=E.a.flatMap(s,(function(t){return[Ke(t,e.props.map.id),Je(e.props.map.id,t.id)]})),f=E.a.flatMap(l,(function(t){return[(n=t,a=e.props.map.id,{from:n.id,to:a,tags:[ye.FlightReport],report:ke.WrongRunwayVacated,rwy:n.rwy}),Je(e.props.map.id,t.id)];var n,a}));return this.withSession(h).addMessages(p).addMessages(f)}return this}},{key:"addTime",value:function(){var e=this.props.dt,t=Object(Ft.b)(this.session).update("t",(function(t){return t+e})).toJS();return this.withSession(t)}},{key:"processFlights",value:function(){var e=this,t=this.session.flights;if(E.a.size(t)>0){var n=E()(t).values().map((function(t){return new _t(t,e.props).processTime()})),a=n.map((function(e){return[e.flight.id,e.flight]})).fromPairs().value(),r=n.flatMap("messages").value(),i=Object(Ft.b)(this.session).set("flights",a).toJS();return this.withSession(i).withMessages(r)}return this}},{key:"processForNewFlight",value:function(){var e=this.props,t=e.dt,n=e.level,a=n.maxPlane,r=n.flightFreq,i=this.session,o=i.flights,s=i.t,l=i.noFlights,c=a-E.a.size(o),u=Math.max(Math.min(function(e){var t=-1,n=1,a=Math.exp(-e);do{++t,n*=Math.random()}while(n>a);return t}(t*r/3600),c),0===l&&s>=20?1:0);if(u>0){for(var d=this,h=0;h<u;h++)d=d.createFlight();return d}return this}},{key:"createEntryCandidates",value:function(){var e=this.props.safeEntryDelay,t=this.session,n=t.entries,r=t.t-e;return E()(this.props.map.nodes).filter((function(e){return e.type===a.Runway||e.type===a.Entry&&(!n[e.id]||n[e.id]<r)})).value()}},{key:"createExitCandidates",value:function(){return E()(this.props.map.nodes).filter((function(e){return e.type===a.Runway||e.type===a.Entry})).value()}},{key:"createFlight",value:function(){var e,t=this.createEntryCandidates();if(t.length>0){var n=this.props,a=n.jetProb,r=n.entryAlt,i=n.flightTempl,o=n.flightVoices,s=this.session,l=s.noFlights,c=s.t,u=s.flights,d=Dt(t),h=Dt(this.createExitCandidates()),p=(e=a,Math.random()<e?R.Jet:R.Airplane),f=void 0;do{f=Rt()}while(void 0!==u[f]);var g=N(d),m=g?0:r,v=g?U.WaitingForTakeoff:U.Flying,y=g?0:function(e,t){return Math.round(e/36e3*(t.speed360-t.speed0)+t.speed0)}(m,i[p]),b=o.length>0?Dt(o):void 0,k={id:f,type:p,alt:m,toAlt:m,hdg:d.hdg,to:h.id,lat:d.lat,lon:d.lon,speed:y,from:d.id,status:v,voice:b},w=Object(Ft.b)(this.session).set("noFlights",l+1).setIn(["flights",k.id],k),E=g?w:w.setIn(["entries",d.id],c),$=this.withSession(E.toJS()),M=N(h);return g?M?$.addDepartureToDialog(k):$.addDepartureLeaveDialog(k):M?$.addEnterToDialog(k):$.addEnterLeaveDialog(k)}return this}},{key:"props",get:function(){return this._props}},{key:"session",get:function(){return this._session}},{key:"messages",get:function(){return this._messages}},{key:"map",get:function(){return this.props.map}}]),e}(),Bt=function(){function e(t){Object(l.a)(this,e),this._props=void 0;var n=t.nodeMap,a=t.width,r=t.height,i=t.borders,o=t.offsetX,s=void 0===o?0:o,c=t.offsetY,u=void 0===c?0:c;if(void 0===t.scale){var d=(a-2*i)/Math.max(n.xmax,-n.xmin)/2,h=(r-2*i)/Math.max(n.ymax,-n.ymin)/2,p=Math.min(d,h);this._props=E.a.assign({},t,{scale:p,offsetX:s,offsetY:u})}else this._props=E.a.assign({},t,{offsetX:s,offsetY:u})}return Object(c.a)(e,[{key:"node",value:function(e){return this.nodes[e]}},{key:"pointByNm",value:function(e){var t=this.props,n=t.width,a=t.height;return[(e[0]-this.offsetX)*this.scale+n/2,-(e[1]-this.offsetY)*this.scale+a/2]}},{key:"pointByNode",value:function(e){return this.pointByNm(e.coords)}},{key:"pointByNodeId",value:function(e){return this.pointByNode(this.node(e))}},{key:"routePath",value:function(e){return[this.pointByNodeId(e.edges[0]),this.pointByNodeId(e.edges[1])]}},{key:"pointByGeo",value:function(e){return this.pointByNm(B.xy(e,this.map.center))}},{key:"moveByNm",value:function(t,n){return new e(E.a.defaults({offsetX:this.offsetX+t,offsetY:this.offsetY+n},this.props))}},{key:"moveByPts",value:function(e,t){var n=-e/this.scale,a=t/this.scale;return this.moveByNm(n,a)}},{key:"props",get:function(){return this._props}},{key:"gridSize",get:function(){var e=this.props,t=e.width,n=e.height,a=e.borders,r=(Math.min(t,n)-2*a)/this.scale/5,i=Math.round(Math.log10(r));return Math.pow(10,i)}},{key:"rect",get:function(){var e=this.props.nodeMap,t=Math.max(e.xmax,-e.xmin),n=Math.max(e.ymax,-e.ymin);return{topLeft:[-t,-n],bottomRight:[t,n]}}},{key:"witdh",get:function(){return this.props.width}},{key:"height",get:function(){return this.props.height}},{key:"nodeMap",get:function(){return this.props.nodeMap}},{key:"map",get:function(){return this.props.map}},{key:"nodes",get:function(){return this.nodeMap.nodes}},{key:"scale",get:function(){return this.props.scale||1}},{key:"offsetX",get:function(){return this.props.offsetX}},{key:"offsetY",get:function(){return this.props.offsetY}}]),e}(),Wt=n(45),Yt=n(46),Pt=Math.log(10)/4/57,Xt={width:850,height:850,borders:30},Ut=15,Kt=14,Jt={x:2,y:-24},Gt={x:2,y:-12},qt={x1:0,x2:0,y1:-8,y2:-34},Zt=["040","080","120","160","200","240","280","320","360"];var Qt=function(e){var t=e.node,n=e.radarMap.pointByNode(t),a=function(e,t){var n=t.alignment,a=void 0===n?"E":n,r=t.width,i=void 0===r?20:r,o=t.height,s=void 0===o?8:o,l=t.radius,c=void 0===l?6:l,u=e[0],d=e[1];switch(a){case"W":case"NW":case"SW":u-=c+i;break;case"E":case"NE":case"SE":u+=c;break;default:u-=i/2}switch(a){case"N":case"NE":case"NW":d-=c;break;case"S":case"SE":case"SW":d+=c+s;break;default:d+=s/2}return[u,d]}(n,{alignment:t.node.alignment}),r=t.node.type,o=t.node.type;return i.a.createElement("g",null,i.a.createElement("circle",{cx:n[0],cy:n[1],className:r}),i.a.createElement("text",{x:a[0],y:a[1],className:o},t.node.id))};var en=function(e){var t=e.flight,n=e.radarMap,a=e.collisionDistance;if(t.status===U.WaitingForTakeoff)return i.a.createElement("g",null);var r,o,s,l=n.pointByGeo(t),c=a*n.scale/2,u=c>5,d=c>20?"collision-dots":"collision-solid",h=(s=t.alt,Zt[Math.max(0,Math.floor((s-2e3)/4e3))]),p=(r=l[0]-Ut/2,o=l[1]-Kt/2,Object(ce.sprintf)("translate(%g,%g)",r,o)+function(e,t,n){return Object(ce.sprintf)("rotate(%f,%f,%f)",e,t,n)}(t.hdg,Ut/2,Kt/2)),f="".concat("/atc","/images/").concat("J"===t.type?"jet":"plane","-").concat(h,".png"),g=Object(ce.sprintf)("%s-%s",t.id,t.type),m=Object(ce.sprintf)("%03d",Math.round(t.alt/100)),v=l[0]+Jt.x,y=l[0]+Gt.x,b=l[1]+Jt.y,k=l[1]+Gt.y,w=l[0]+qt.x1,E=l[0]+qt.x2,$=l[1]+qt.y1,M=l[1]+qt.y2,O="fl-"+h;return i.a.createElement("g",null,u?i.a.createElement("circle",{cx:l[0],cy:l[1],className:"".concat(d," ").concat(O),r:c}):i.a.createElement("g",null),i.a.createElement("image",{href:f,x:0,y:0,width:Ut,height:Kt,transform:p}),i.a.createElement("line",{x1:w,y1:$,x2:E,y2:M,className:O}),i.a.createElement("text",{x:v,y:b,className:O},g),i.a.createElement("text",{x:y,y:k,className:O},m))},tn=function(e){var t=e.radarMap,n=t.props.borders,a=t.gridSize,r=n/2,o=r+a*t.scale,s=o+10,l=n/2,c=n/2-4,u=n/2+4,d=Object(ce.sprintf)("%g nms",a);return i.a.createElement("g",{className:"gridmarker"},i.a.createElement("line",{x1:r,y1:l,x2:o,y2:l}),i.a.createElement("line",{x1:r,y1:c,x2:r,y2:u}),i.a.createElement("line",{x1:o,y1:c,x2:o,y2:u}),i.a.createElement("text",{x:s,y:l},d))},nn=function(e){var t=e.radarMap,n=t.rect,a=n.topLeft,r=n.bottomRight,o=t.gridSize,s=Math.floor(a[0]/o),l=Math.ceil(r[0]/o),c=Math.floor(a[1]/o),u=Math.ceil(r[1]/o),d=E.a.range(s,l+1),h=E.a.range(c,u+1),p=t.props,f=p.borders,g=p.width,m=p.height,v=f,y=g-f,b=f,k=m-f;return i.a.createElement("g",{className:"gridmap"},d.map((function(e){var n=[e*o,c*o],a=[e*o,u*o],r=[t.pointByNm(n),t.pointByNm(a)];return i.a.createElement("line",{key:"v".concat(e),x1:r[0][0],y1:b,x2:r[1][0],y2:k})})),h.map((function(e){var n=[s*o,e*o],a=[l*o,e*o],r=[t.pointByNm(n),t.pointByNm(a)];return i.a.createElement("line",{key:"h".concat(e),x1:v,y1:r[0][1],x2:y,y2:r[1][1]})})))},an=function(e){var t=e.route,n=e.radarMap.routePath(t),a=t.type;return i.a.createElement("line",{x1:n[0][0],y1:n[0][1],x2:n[1][0],y2:n[1][1],className:a})},rn=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e){var a;Object(l.a)(this,n);var r=(a=t.call(this,e)).props,i=r.map,o=r.nodeMap,s=r.session,c=o&&i&&s?new Bt(E.a.assign({},Xt,{map:i,nodeMap:o,offsetX:0,offsetY:0})).scale:1;return a.state={dragging:!1,offsetX:0,offsetY:0,scale:c},E.a.bindAll(Object(u.a)(a),["handleDown","handleMove","handleUp","handleWheel","render","handleFit","handleZoomIn","handleZoomOut"]),a}return Object(c.a)(n,[{key:"handleDown",value:function(e){switch(e.button){case 0:e.preventDefault(),this.setState({dragging:!0,pivotX:e.clientX,pivotY:e.clientY,clientX:e.clientX,clientY:e.clientY});break;case 1:e.preventDefault(),this.fit()}}},{key:"fit",value:function(){var e=this.props,t=e.map,n=e.nodeMap,a=e.session,r=this.state,i=r.offsetX,o=r.offsetY,s=n&&t&&a?new Bt(E.a.assign({},Xt,{map:t,nodeMap:n,offsetX:i,offsetY:o})).scale:1;this.setState({dragging:!1,offsetX:0,offsetY:0,scale:s})}},{key:"handleUp",value:function(e){e.preventDefault();var t=this.radarMap();t&&this.setState({dragging:!1,offsetX:t.offsetX,offsetY:t.offsetY})}},{key:"handleLeave",value:function(e){e.preventDefault(),this.setState({dragging:!1})}},{key:"handleWheel",value:function(e){e.shiftKey&&this.zoom(e.deltaY)}},{key:"zoom",value:function(e){var t=Math.exp(-e*Pt),n=this.radarMap();if(n){var a=n.scale*t;this.setState({scale:a})}}},{key:"handleZoomIn",value:function(){this.zoom(-57)}},{key:"handleZoomOut",value:function(){this.zoom(57)}},{key:"handleFit",value:function(){this.fit()}},{key:"handleMove",value:function(e){if(this.state.dragging){e.preventDefault();var t=e.clientX,n=e.clientY;this.setState({clientX:t,clientY:n})}}},{key:"radarMap",value:function(){var e=this.props,t=e.map,n=e.nodeMap;if(t&&n){var a=this.state,r=a.dragging,i=a.clientX,o=void 0===i?0:i,s=a.clientY,l=void 0===s?0:s,c=a.pivotX,u=void 0===c?0:c,d=a.pivotY,h=void 0===d?0:d,p=a.offsetX,f=a.offsetY,g=a.scale;return r?new Bt(E.a.assign({},Xt,{map:t,nodeMap:n,width:Xt.width,height:Xt.height,offsetX:p,offsetY:f,scale:g})).moveByPts(o-u,l-h):new Bt(E.a.assign({},Xt,{map:t,nodeMap:n,width:Xt.width,height:Xt.height,offsetX:p,offsetY:f,scale:g}))}}},{key:"render",value:function(){var e=this.props,t=e.map,n=e.nodeMap,a=e.session,r=e.collisionDistance,o=this.radarMap();if(n&&t&&a&&o){var s=a.flights;return i.a.createElement("div",null,i.a.createElement("svg",{width:Xt.width,height:Xt.height,onMouseMove:this.handleMove,onMouseDown:this.handleDown,onMouseUp:this.handleUp,onMouseLeave:this.handleUp,onWheel:this.handleWheel,className:"radar"},i.a.createElement(nn,{radarMap:o}),E.a.map(t.routes,(function(e,t){return i.a.createElement(an,{key:t,radarMap:o,route:e})})),E()(n.nodes).values().map((function(e,t){return i.a.createElement(Qt,{key:t,radarMap:o,node:e})})).value(),i.a.createElement(tn,{radarMap:o}),E()(s).values().orderBy("alt","asc").map((function(e){return i.a.createElement(en,{key:e.id,radarMap:o,flight:e,collisionDistance:r||4})})).value()),i.a.createElement(b.a,{vertical:!0,size:"sm"},i.a.createElement(k.a,{variant:"dark",onClick:this.handleZoomIn},i.a.createElement(Wt.a,{icon:Yt.e})),i.a.createElement(k.a,{variant:"dark",onClick:this.handleZoomOut},i.a.createElement(Wt.a,{icon:Yt.d})),i.a.createElement(k.a,{variant:"dark",onClick:this.handleFit},i.a.createElement(Wt.a,{icon:Yt.c}))))}return i.a.createElement("svg",{width:Xt.width,height:Xt.height,className:"radar"})}}]),n}(r.Component),on=n(154),sn=n(149),ln=[1,3,10],cn=function(e){var t=e.muted,n=e.onMuted,a=e.listeningEnabled,r=e.onListeningEnabled,o=e.speed,s=e.speeds,l=void 0===s?ln:s,c=e.onSpeed;return i.a.createElement(on.a,{defaultActiveKey:"1"},i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(on.a.Toggle,{as:ne.a.Header,eventKey:"1"},"Options"),i.a.createElement(on.a.Collapse,{eventKey:"1"},i.a.createElement(ne.a.Body,null,i.a.createElement(sn.a,null,i.a.createElement(sn.a.Group,{controlId:"muted"},i.a.createElement(sn.a.Label,null,"Audio"),i.a.createElement(sn.a.Check,{type:"switch",id:"muted",label:"Muted",onChange:n,checked:t}),i.a.createElement(sn.a.Check,{type:"switch",id:"listening",label:"Listening",onChange:r,checked:a})),i.a.createElement(sn.a.Group,{controlId:"speed"},i.a.createElement(sn.a.Label,null,"Speed"),l.map((function(e){return i.a.createElement(sn.a.Check,{type:"radio",name:"speed",checked:o===e,key:e,value:e,onChange:function(e){c&&c(parseFloat(e.target.value))},label:"x ".concat(e)})}))))))))};function un(e){var t=e.status,n=e.at,a=e.turnTo,r=e.rwy,i=e.from;switch(t){case U.Flying:return"";case U.FlyingTo:return"flying to ".concat(n);case U.WaitingForTakeoff:return Object(ce.sprintf)("holding rwy %s",i);case U.Landing:return Object(ce.sprintf)("landing rwy %s",r);case U.Aligning:return Object(ce.sprintf)("aligning rwy %s",r);case U.Approaching:return Object(ce.sprintf)("approaching rwy %s",r);case U.HoldingFrom:case U.HoldingTo:return"holding";case U.HoldingFromAt:case U.HoldingToAt:return"holding at ".concat(n);case U.Turning:return Object(ce.sprintf)("turn to %s via %s",a,n);default:return t}}function dn(e){var t=Math.round(e.alt/100),n=Math.round(e.toAlt/100),a=un(e),r=Object(ce.sprintf)("%3s to %s Class %s",e.id,e.to,e.type),i=t!==n?Object(ce.sprintf)("    FL%03d to FL%03d Hdg %03d",t,n,e.hdg):Object(ce.sprintf)("    FL%03d  Hdg %03d",t,e.hdg);return 0===a.length?[r,i]:[r,i,Object(ce.sprintf)("    %s",un(e))]}var hn=function(e){var t=e.session;if(t){var n=E()(t.flights).values().sortBy(["id"]).flatMap(dn).join("\n");return i.a.createElement("pre",{className:"terminal"},n)}return i.a.createElement("pre",{className:"terminal"})},pn=function(e){var t=e.session,n=e.logger;return i.a.createElement("div",null,i.a.createElement(on.a,{defaultActiveKey:"0"},i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(on.a.Toggle,{as:ne.a.Header,eventKey:"0"},"Flights"),i.a.createElement(on.a.Collapse,{eventKey:"0"},i.a.createElement(ne.a.Body,null,i.a.createElement(hn,{session:t}))))),i.a.createElement(on.a,{defaultActiveKey:"0"},i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(on.a.Toggle,{as:ne.a.Header,eventKey:"2"},"Cockpit Log"),i.a.createElement(on.a.Collapse,{eventKey:"2"},i.a.createElement(ne.a.Body,null,n&&n.log.map((function(e,t){return i.a.createElement("div",{key:t,className:"term-".concat(e.style," text-monospace")},e.text)})))))))},fn=n(155),gn=n(82),mn=n(147);var vn=function(){function e(t){var n=this;Object(l.a)(this,e),this._recogn=void 0,this._speeches=void 0,this._messages=void 0,this._listening=void 0,this._props=void 0,this._buffer=void 0,this._speech=void 0,this._listenEnabled=void 0,this._props=t,this._speeches=new gn.a,this._messages=new gn.a,this._listening=new mn.a(!1);var a=this;this._buffer=[],this._speech="",this._listenEnabled=!1,this._recogn=function(e){var t=e.ondefault,n=void 0===t?null:t,a=e.onresult,r=void 0===a?null:a,i=e.onend,o=void 0===i?null:i,s=e.onnomatch,l=void 0===s?null:s,c=e.onerror,u=void 0===c?null:c,d=window.SpeechRecognition||window.webkitSpeechRecognition;if(d){var h=new d;return h.continuous=!1,h.lang="en",h.interimResults=!1,h.maxAlternatives=1,h.onresult=r||n,h.onspeechend=n,h.onnomatch=l||n,h.onerror=u||n,h.onstart=n,h.onaudiostart=n,h.onsoundstart=n,h.onspeechstart=n,h.onspeechend=n,h.onsoundend=n,h.onaudioend=n,h.onend=o||n,h}}({onend:function(e){a._listening.next(!1)},onresult:function(e){var t=e.results[0][0].transcript;n.handleSpeech(t)}});var r=t.onSpeech,i=t.onListening,o=t.onRecognized;r&&this.speeches().pipe(Object(O.a)((function(e){return r(e)}))).subscribe(),o&&this.messages().pipe(Object(O.a)((function(e){return o(e)}))).subscribe(),i&&this.listening().pipe(Object(O.a)((function(e){i(e)}))).subscribe();var s,c,u=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;return Object(de.a)(e).pipe(Object(C.a)((function(){return me()})),Object(M.a)((function(e){return e.synth.speaking})))}(t.polling||500).pipe(Object(T.a)((function(e){return!e})));(s=this.listening(),c=u,Object(fn.a)([c,s]).pipe(Object(M.a)((function(e){var t=Object(jt.a)(e,2),n=t[0],a=t[1];return!n&&!a})),Object(T.a)((function(e){return e})))).pipe(Object(O.a)((function(e){return a.handleCleared(e)}))).subscribe()}return Object(c.a)(e,[{key:"handleSpeech",value:function(e){var t=(this._speech+" "+e).trim(),n=this.props.parseSpeech(t);this.props.isCompleted(n)?(this._messages.next(n),this._speech="",this._speeches.next("")):(this._speech=t,this._speeches.next(t))}},{key:"handleCleared",value:function(e){if(""===this._speech&&this._buffer.length>0){var t=this._buffer;this._buffer=[],ve(t).subscribe()}else this.listenEnabled&&this.startListening()}},{key:"startListening",value:function(){var e=this.recogn;e&&(this._listening.next(!0),e.start())}},{key:"speeches",value:function(){return this._speeches.asObservable()}},{key:"listening",value:function(){return this._listening.asObservable()}},{key:"messages",value:function(){return this._messages.asObservable()}},{key:"say",value:function(e){var t=this._buffer;this._buffer=[],this._buffer=E.a.concat(t,e)}},{key:"props",get:function(){return this._props}},{key:"recogn",get:function(){return this._recogn}},{key:"listenEnabled",get:function(){return this._listenEnabled},set:function(e){this._listenEnabled=e}}]),e}(),yn=n(148),bn=function(e){var t=e.listening,n=e.speech,a=void 0===n?"":n;return i.a.createElement(ne.a,{bg:"dark",text:"white"},i.a.createElement(ne.a.Body,null,i.a.createElement(sn.a,null,i.a.createElement(sn.a.Group,null,i.a.createElement(sn.a.Label,null,"Listening"),i.a.createElement(yn.a,null,i.a.createElement(yn.a.Prepend,null,t?i.a.createElement(Wt.a,{icon:Yt.a}):i.a.createElement(Wt.a,{icon:Yt.b}))),a.toLowerCase()))))},kn=n(106),wn={at:["it"],cleared:["clear","player","order"],climb:["time"],descend:["descent"],fly:["flight","play"],flight:["fly","play"],maintain:["19"],runway:["railway","runways","roundway"],to:["two","2"],via:["fire","by"]};function En(e){return"string"===typeof e}var $n=function(){function e(t){Object(l.a)(this,e),this._props=void 0,this._props=t}return Object(c.a)(e,[{key:"token",value:function(){var e=this.props,t=e.cursor,n=e.tokens;return t<n.length?n[t]:void 0}},{key:"next",value:function(){var t=this.props,n=t.cursor;return n>=t.tokens.length?this:new e(E.a.assign({},this.props,{cursor:n+1}))}},{key:"push",value:function(t){var n=this.props.stack;return new e(E.a.assign({},this.props,{stack:E.a.concat(n,t)}))}},{key:"peek",value:function(){var e=this.props.stack;return e[e.length-1]}},{key:"peekn",value:function(e){var t=this.props.stack;return E.a.takeRight(t,e)}},{key:"drop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=this.props.stack;return new e(E.a.assign({},this.props,{stack:E.a.dropRight(n,t)}))}},{key:"props",get:function(){return this._props}}]),e}();function Mn(e){var t,n,a=(t=e,new $n({tokens:E.a.filter(t.toLowerCase().split(/[^-\w]+/),(function(e){return e.length>0})),cursor:0,stack:[]}));try{var r=ia(a).peek();return void 0===(n=r)||En(n)?Qe(e,"message-expected"):r}catch(o){var i=o.message;return"string"===typeof i?Qe(e,"word-expected"===i?"".concat(o.props.word,"-exepected"):i):(console.trace(o),Qe(e,"unknown-error"))}}var On=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e,a,r){var i;return Object(l.a)(this,n),(i=t.call(this,e))._ctx=void 0,i._props=void 0,i._ctx=a,i._props=r,i}return Object(c.a)(n,[{key:"context",get:function(){return this._ctx}},{key:"props",get:function(){return this._props}}]),n}(Object(kn.a)(Error));function Cn(e){if(!e.token())throw new On("partial-command",e);return e}function Tn(e){var t=e.peekn(2),n=Object(jt.a)(t,2),a=n[0],r=n[1];return En(a)?En(r)?e.drop(2).push(a+r):e.drop(2).push(a):e.drop(2).push(r)}function jn(e){var t=e.peekn(3),n=Object(jt.a)(t,3),a=n[0],r=n[1],i=n[2];if(En(a)&&En(r)&&(void 0===i||En(i))){var o=Ne(a.toUpperCase(),r.toUpperCase(),i?i.toUpperCase():i,[ye.VoiceMessage]);return e.drop(3).push(o)}return e.drop(3).push(void 0)}function Fn(e,t){return!!e&&E.a.concat([t],wn[t]||[]).indexOf(e)>=0}function xn(e){return function(t){return Fn(t.token(),e)?t.next().push(e):t.push(void 0)}}function An(e){return function(t){var n=Cn(t);if(!Fn(n.token(),e))throw new On("word-expected",n,{word:e});return n.next()}}function Ln(e){return function(t){var n=t.token();if(n){var a=e[n];if(a)return t.next().push(a)}return t.push(void 0)}}function Sn(e){return function(t){return t.push(e)}}function Vn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return E.a.reduce(t,(function(e,t){return t(e)}),e)}}function Hn(e,t){return function(n){return n.peek()?e?e(n):n:t?t(n):n}}function _n(e,t){return function(n){return n.peek()?e?e(n.drop()):n:t?t(n.drop()):n}}function Nn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return E.a.reduce(t,(function(e,t){return void 0!==e.peek()?e:t(e.drop())}),e.push(void 0))}}function Rn(e,t){return function(n){for(var a=n.push(void 0);;){var r=e(a);if(a=t(r),void 0===r.peek())return a}}}function Dn(e){return Vn(Hn(void 0,Nn(Cn,(t=e,function(e){throw new On(t,e)}))));var t}var In,zn,Bn,Wn=Rn(Nn((In=/^\d*$/,function(e){var t=e.token();return t&&In.test(t)?e.next().push(t):e.push(void 0)}),Ln({zero:"0",one:"1",wine:"1",two:"2",to:"2",three:"3",four:"4",for:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",niner:"9",naina:"9"})),Tn),Yn=Rn(Ln({alpha:"a",bravo:"b",charlie:"c",delta:"d",echo:"e",foxtrot:"f","fox-trot":"f","fox-tots":"f",golf:"g",hotel:"h",india:"i",indian:"i",juliet:"j",kilo:"k",lima:"l",mike:"m",november:"n",oscar:"o",papa:"p",quebec:"q",rebec:"q",prebec:"q",romeo:"r",sierra:"s",tango:"t",uniform:"u",uniforms:"u",uniformed:"u",victor:"v",viktor:"v",picture:"v",whiskey:"w",whisky:"w","x-ray":"x","x-rayed":"x",yankee:"y",zulu:"z"}),Tn),Pn=Rn(Nn(Yn,Wn),Tn),Xn=Vn(Pn,Dn("flight-id-expected")),Un=Vn(Pn,Dn("beacon-id-expected")),Kn=Vn(Ln({london:"lon",paris:"par",munich:"mun",milan:"mil",frankfurt:"ffm"}),Hn(An("atc")),Dn("atc-expected")),Jn=Vn(xn("flight"),_n(An("level"),(function(e){return e})),Wn,Dn("flight-level-expected")),Gn=Vn((zn="runway",function(e){return Fn(e.token(),zn)?e.next():e}),Wn,Hn(Vn(Ln({right:"r",center:"c",left:"l"}),Tn))),qn=Vn(Gn,Dn("runway-expected")),Zn=Vn(xn("climb"),_n(Vn(An("to"),Jn,(function(e){var t=e.peekn(3),n=Object(jt.a)(t,3),a=n[0],r=n[1],i=n[2];if(En(a)&&En(r)&&En(i)){var o=Ae(a.toUpperCase(),r.toUpperCase(),i,[ye.VoiceMessage]);return e.drop(3).push(o)}return e.drop(3).push(void 0)})))),Qn=Vn(xn("descend"),_n(Vn(An("to"),Jn,(function(e){var t=e.peekn(3),n=Object(jt.a)(t,3),a=n[0],r=n[1],i=n[2];if(En(a)&&En(r)&&En(i)){var o=Le(a.toUpperCase(),r.toUpperCase(),i,[ye.VoiceMessage]);return e.drop(3).push(o)}return e.drop(3).push(void 0)})))),ea=Vn(xn("maintain"),_n(Vn(Jn,(function(e){var t=e.peekn(3),n=Object(jt.a)(t,3),a=n[0],r=n[1],i=n[2];if(En(a)&&En(r)&&En(i)){var o=Se(a.toUpperCase(),r.toUpperCase(),i,[ye.VoiceMessage]);return e.drop(3).push(o)}return e.drop(3).push(void 0)})))),ta=Vn(xn("fly"),_n(Vn(An("to"),Un,xn("via"),_n(Un,Sn(void 0)),(function(e){var t=e.peekn(4),n=Object(jt.a)(t,4),a=n[0],r=n[1],i=n[2],o=n[3];if(En(a)&&En(r)&&En(i)&&(void 0===o||En(o))){var s=_e(a.toUpperCase(),r.toUpperCase(),i.toUpperCase(),null===o||void 0===o?void 0:o.toUpperCase(),[ye.VoiceMessage]);return e.drop(4).push(s)}return e.drop(4).push(void 0)})))),na=Vn(xn("hold"),_n(Vn(An("at"),Vn(xn("current"),_n(Vn(An("position"),Sn(void 0),jn),Vn(Un,jn)))))),aa=Vn(xn("cleared"),_n(Vn(An("to"),An("land"),qn,(function(e){var t=e.peekn(3),n=Object(jt.a)(t,3),a=n[0],r=n[1],i=n[2];if(En(a)&&En(r)&&En(i)){var o=He(a.toUpperCase(),r.toUpperCase(),i.toUpperCase(),[ye.VoiceMessage]);return e.drop(3).push(o)}return e.drop(3).push(void 0)})))),ra=Vn(Gn,Hn(Vn(An("cleared"),An("to"),Nn(Vn(xn("take"),Hn(An("off"))),Vn(An("takeoff"),Sn(void 0))),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return function(t){return t.drop(e)}}(),An("climb"),An("to"),Jn,(function(e){var t=e.peekn(4),n=Object(jt.a)(t,4),a=n[0],r=n[1],i=n[2],o=n[3];if(En(a)&&En(r)&&En(i)&&En(o)){var s=Ve(a.toUpperCase(),r.toUpperCase(),i.toUpperCase(),o,[ye.VoiceMessage]);return e.drop(4).push(s)}return e.drop(4).push(void 0)})))),ia=Vn(Xn,Kn,Nn(Zn,Qn,ea,ta,na,aa,ra),Dn("command-expected"),(function(e){if(e.token())throw new On("end-expected",e);return e})),oa=(Bn=[xe,Te(ye.Command)],function(e){return E.a.findIndex(Bn,(function(t,n){return!t(e)}))<0}),sa=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e){var a;Object(l.a)(this,n),(a=t.call(this,e)).clock=void 0;var r=new Tt;return a.state={logger:r,muted:!1,listenEnabled:!0,speed:10,ts:0,flightVoices:[],listening:!1,speech:""},a.clock=Object(de.a)(400),E.a.bindAll(Object(u.a)(a),["handleClock","handleCommand","handleListenEnabled","handleMuted","handleSpeed","handleMessages"]),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this,t=new vn({polling:100,parseSpeech:Mn,isCompleted:function(e){return!(je(e)&&"partial-command"===e.parserError)},onRecognized:function(t){return e.handleSpeechMessage(t)},onSpeech:function(t){return e.setState({speech:t})},onListening:function(t){return e.handleListening(t)}});t.listenEnabled=this.state.listenEnabled,this.setState({audioDialog:t}),Q.getSession(this.props.sessionId).pipe(Object(C.a)((function(e){return e?ee.level(e.level).pipe(Object(C.a)((function(t){return B.getMap(e.map).pipe(Object(C.a)((function(n){return fe().pipe(Object(M.a)((function(a){var r=E.a.range(0,a.length).map((function(e){return e.toString()})),i=e.atcVoice,o=B.coords(n.nodes,n.center),s=E.a.reject(r,(function(e){return e===i})),l=s.length>0?s:i?[i]:[];return{session:e,map:n,nodeMap:o,level:t,flightVoices:l}})))})))}))):Object(P.a)({})})),Object(O.a)((function(t){e.setState(t)}))).subscribe(),this.clock.pipe(Object(O.a)(this.handleClock)).subscribe()}},{key:"handleListening",value:function(e){this.setState({listening:e})}},{key:"handleCommand",value:function(e){var t=this.state,n=t.session,a=t.map,r=t.level,i=t.flightVoices;if(n&&a&&r){var o=It(n,{map:a,level:r,flightVoices:i}).processCommand(e),s=Q.putSession(o.session);this.handleMessages([e]),this.handleMessages(o.messages),this.setState({session:s})}}},{key:"handleClock",value:function(e){var t=this.state,n=t.session,a=t.map,r=t.level,i=t.speed,o=t.ts,s=t.flightVoices;if(n&&a&&r){var l=o+400*i/1e3;if(l>=4){for(var c=n,u=l;u>=1;u-=1){var d=It(c,{map:a,level:r,dt:1,flightVoices:s}).transition();this.handleMessages(d.messages),c=d.session}this.setState({session:Q.putSession(c),ts:u})}else this.setState({ts:l})}}},{key:"handleMessages",value:function(e){var t=this.state,n=t.map,a=t.logger,r=t.session,i=t.muted,o=t.audioDialog;if(n&&e.length>0&&r){var s=e.map((function(e){return new Mt(e,n).build()}));if(a.putMessages(s),s.forEach((function(e){return console.log(e.text)})),!i){var l=E()(e).reject(oa).map((function(e){return new Ot(e,n,r).build()})).value();o&&o.say(l)}}}},{key:"handleMuted",value:function(){var e=!this.state.muted;e&&window.speechSynthesis&&window.speechSynthesis.cancel(),this.setState({muted:e})}},{key:"handleListenEnabled",value:function(){var e=this.state.audioDialog,t=!this.state.listenEnabled;e&&(e.listenEnabled=t),this.setState({listenEnabled:t})}},{key:"handleSpeed",value:function(e){this.setState({speed:e})}},{key:"handleSpeechMessage",value:function(e){console.log(e),!function(e){return Te(ye.Command)(e)}(e)?this.handleMessages([e]):this.handleCommand(e)}},{key:"render",value:function(){var e=this.state,t=e.session,n=e.map,a=e.nodeMap,r=e.level,o=e.logger,s=e.muted,l=e.listenEnabled,c=e.speed,u=e.listening,d=e.speech;return a&&t&&n&&r?i.a.createElement(p.a,{fluid:!0},i.a.createElement(ue,{session:t}),i.a.createElement(p.a,{fluid:!0,className:"ATC"},i.a.createElement(g.a,null,i.a.createElement(m.a,{xs:2},i.a.createElement(pn,{session:t,logger:o})),i.a.createElement(m.a,null,i.a.createElement(rn,{session:t,nodeMap:a,map:n,collisionDistance:Nt.collisionDistance}),i.a.createElement(bn,{listening:u,speech:d})),i.a.createElement(m.a,{xs:2},i.a.createElement(ut,{session:t,map:n,onCommand:this.handleCommand}),i.a.createElement(cn,{speed:c,onSpeed:this.handleSpeed,muted:s,onMuted:this.handleMuted,listeningEnabled:l,onListeningEnabled:this.handleListenEnabled}))))):i.a.createElement("div",null)}}]),n}(r.Component);function la(){var e=Object(Oe.f)().id;return i.a.createElement(sa,{sessionId:e})}n(130);var ca=function(e){var t=e.ondefault,n=void 0===t?null:t,a=e.onresult,r=void 0===a?null:a,i=e.onend,o=void 0===i?null:i,s=e.onnomatch,l=void 0===s?null:s,c=e.onerror,u=void 0===c?null:c,d=window.SpeechRecognition||window.webkitSpeechRecognition;if(console.log("create recogn",d),d){var h=new d;return h.continuous=!1,h.lang="en",h.interimResults=!1,h.maxAlternatives=1,h.onresult=r||n,h.onspeechend=n,h.onnomatch=l||n,h.onerror=u||n,h.onstart=n,h.onaudiostart=n,h.onsoundstart=n,h.onspeechstart=n,h.onspeechend=n,h.onsoundend=n,h.onaudioend=n,h.onend=o||n,console.log("create recogn",h),h}},ua=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object(l.a)(this,n),(e=t.call(this,a))._recognition=void 0,e.state={},E.a.bindAll(Object(u.a)(e),["handleResult","listen"]);var r=Object(u.a)(e),i=function(e){console.log(e);var t=e.error;r.setState({error:t})};return e._recognition=ca({onresult:r.handleResult,onend:function(e){console.log(e);var t=r.recognition;t&&t.start()},onnomatch:function(e){console.log(e);r.setState({error:"No match"})},onerror:i,ondefault:function(e){console.log(e),r.setState({event:e})}}),e}return Object(c.a)(n,[{key:"componentDidMount",value:function(){this.listen()}},{key:"listen",value:function(){var e=this._recognition;e&&e.start(),this.setState({error:void 0})}},{key:"handleResult",value:function(e){console.log(e);var t=e.results[0][0].transcript;ve(["3 "+t]).subscribe(),this.setState({cmd:t})}},{key:"render",value:function(){var e=this.state,t=e.cmd,n=e.error,a=e.event,r=void 0===a?{}:a;return i.a.createElement(p.a,null,i.a.createElement(ne.a,null,i.a.createElement(ne.a.Header,null,"Speach Recognition Test"),i.a.createElement(ne.a.Body,null,i.a.createElement(sn.a,null,i.a.createElement(sn.a.Group,{as:g.a,controlId:"status"},i.a.createElement(sn.a.Label,{column:!0,sm:"2"},"Status"),i.a.createElement(m.a,{sm:"10"},i.a.createElement(sn.a.Control,{plaintext:!0,readOnly:!0,defaultValue:"",value:r.type}))),i.a.createElement(sn.a.Group,{as:g.a,controlId:"Error"},i.a.createElement(sn.a.Label,{column:!0,sm:"2"},"Errors"),i.a.createElement(m.a,{sm:"10"},i.a.createElement(sn.a.Control,{plaintext:!0,readOnly:!0,defaultValue:"",value:n}))),i.a.createElement(sn.a.Group,{as:g.a,controlId:"Text"},i.a.createElement(sn.a.Label,{column:!0,sm:"2"},"Text"),i.a.createElement(m.a,{sm:"10"},i.a.createElement(sn.a.Control,{plaintext:!0,readOnly:!0,defaultValue:"",value:t})))))))}},{key:"recognition",get:function(){return this._recognition}}]),n}(r.Component),da=n(158),ha=n(104),pa=function(e){Object(d.a)(n,e);var t=Object(h.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e)).state={voice:"0",voices:[],errors:[],listening:!1},E.a.bindAll(Object(u.a)(a),["handleCloseAlert","handleVoice"]),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this;fe().pipe(Object(O.a)((function(t){return e.setState({voices:t})}))).subscribe();var t=new vn({polling:100,parseSpeech:function(e){return e},isCompleted:function(e){return""!==e},onSpeech:function(t){return e.handleSpeech(t)},onListening:function(t){console.log(t),e.setState({listening:t})}});this.setState({audioDialog:t})}},{key:"handleSpeech",value:function(e){var t=this.state,n=t.audioDialog,a=t.voice;n&&(console.log(e),n.say([a+" "+e])),this.setState({speech:e})}},{key:"handleVoice",value:function(e){this.setState({voice:e})}},{key:"handleCloseAlert",value:function(e){var t=this.state.errors;t.splice(e,1),this.setState({errors:t})}},{key:"render",value:function(){var e=this,t=this.state,n=t.voice,a=t.errors,r=t.voices,o=t.speech,s=t.listening;return console.log(s),i.a.createElement(p.a,null,i.a.createElement(ne.a,null,i.a.createElement(ne.a.Header,null,"Audio test"),i.a.createElement(ne.a.Body,null,a.map((function(t,n){return i.a.createElement(da.a,{key:n,variant:"danger",dismissible:!0,show:!!t,onClose:function(){return e.handleCloseAlert(n)}},t)})),i.a.createElement(sn.a,null,i.a.createElement(ha.a,{controlId:"voiceInput"},i.a.createElement(sn.a.Label,null,"Voice"),i.a.createElement(sn.a.Control,{as:"select",value:n,onChange:function(t){return e.handleVoice(t.target.value)}},r.map((function(e,t){return i.a.createElement("option",{key:t,value:t},e.name)})))),i.a.createElement(sn.a.Group,{as:g.a,controlId:"Text"},i.a.createElement(sn.a.Label,{column:!0,sm:"2"},"Text"),i.a.createElement(m.a,{sm:"10"},i.a.createElement(sn.a.Control,{plaintext:!0,readOnly:!0,defaultValue:o}))),i.a.createElement(sn.a.Group,{as:g.a,controlId:"Text"},i.a.createElement(sn.a.Label,{column:!0,sm:"2"},"Text"),i.a.createElement(m.a,{sm:"10"},i.a.createElement(sn.a.Control,{plaintext:!0,readOnly:!0,defaultValue:s?"Listening ...":""})))))))}}]),n}(r.Component);function fa(){return i.a.createElement("div",null,"No Match")}var ga=function(){return i.a.createElement(Me.a,{basename:"."},i.a.createElement("div",null,i.a.createElement(Ct.a,{position:"bottom-left",autoClose:5e3,hideProgressBar:!0,pauseOnFocusLoss:!0,pauseOnHover:!0}),i.a.createElement(Oe.c,null,i.a.createElement(Oe.a,{exact:!0,path:"/"},i.a.createElement($e,null)),i.a.createElement(Oe.a,{exact:!0,path:"/dialog"},i.a.createElement(pa,null)),i.a.createElement(Oe.a,{exact:!0,path:"/speach"},i.a.createElement(ua,null)),i.a.createElement(Oe.a,{path:"/sessions/:id"},i.a.createElement(la,null)),i.a.createElement(Oe.a,{path:"*"},i.a.createElement(fa,null)))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(ga,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},58:function(e,t,n){}},[[108,1,2]]]);
//# sourceMappingURL=main.c3e05c5d.chunk.js.map